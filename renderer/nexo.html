<!DOCTYPE html>
<!-- saved from url=(0038)https://toolboard.vercel.app/nexo.html -->
<html lang="es"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Contactos Masivo</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        :root {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-card: #334155;
            --accent-primary: #3b82f6;
            --accent-success: #10b981;
            --accent-warning: #f59e0b;
            --accent-danger: #ef4444;
            --accent-neutral: #6b7280;
            --accent-jugando: #8b5cf6;
            --text-primary: #f1f5f9;
            --text-secondary: #cbd5e1;
            --border-color: #475569;
            --hover-color: #475569;
            --selection-bg: rgba(59, 130, 246, 0.2);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', system-ui, sans-serif;
        }

        body {
            background-color: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }


        /* Pantalla de inicio */
        .upload-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            background: linear-gradient(135deg, var(--bg-primary) 0%, #1e1b4b 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            transition: opacity 0.5s ease, transform 0.5s ease;
        }

        .upload-screen.hidden {
            opacity: 0;
            transform: scale(0.95);
            pointer-events: none;
        }

        .upload-card {
            background: var(--bg-secondary);
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            max-width: 500px;
            width: 90%;
            text-align: center;
            border: 2px solid var(--accent-primary);
        }

        .upload-card h1 {
            margin-bottom: 30px;
            font-size: 2.2rem;
            background: linear-gradient(90deg, var(--accent-primary), #8b5cf6);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .upload-card i {
            font-size: 4rem;
            color: var(--accent-primary);
            margin-bottom: 20px;
        }

        .file-upload-area {
            border: 3px dashed var(--border-color);
            border-radius: 15px;
            padding: 30px;
            margin: 20px 0;
            cursor: pointer;
            transition: all 0.3s;
        }

        .file-upload-area:hover {
            border-color: var(--accent-primary);
            background: rgba(59, 130, 246, 0.05);
        }

        .origin-input {
            width: 100%;
            padding: 12px 15px;
            margin-top: 20px;
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 1rem;
        }
        
        .file-list {
            margin-top: 20px;
            max-height: 150px;
            overflow-y: auto;
            text-align: left;
        }
        .file-item {
            background: var(--bg-card);
            padding: 10px 15px;
            margin: 5px 0;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9rem;
        }
        .file-item span:last-child {
            color: var(--text-secondary);
        }

        .btn-primary {
            background: linear-gradient(90deg, var(--accent-primary), #6366f1);
            color: white;
            border: none;
            padding: 14px 30px;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
            margin-top: 20px;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(59, 130, 246, 0.3);
        }
        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Barra de navegación */
        .navbar {
            background: linear-gradient(180deg, rgba(30, 41, 59, 0.96), rgba(30, 41, 59, 0.88));
            padding: 15px 20px;
            border-radius: 15px;
            margin-bottom: 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(148, 163, 184, 0.14);
        }

        .stats { display: flex; gap: 10px; flex-wrap: wrap; flex: 1; }
        .stat-box { background: var(--bg-card); padding: 10px 15px; border-radius: 10px; min-width: 120px; text-align: center; cursor: pointer; transition: all 0.3s; border: 2px solid transparent; }
        .stat-box:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2); }
        .stat-box.active { border-color: var(--accent-primary); }
        .stat-value { font-size: 1.3rem; font-weight: 700; }
        .stat-total .stat-value { color: var(--accent-primary); }
        .stat-unreviewed .stat-value { color: #9ca3af; }
        .stat-contactado .stat-value { color: var(--accent-success); }
        .stat-revisado .stat-value { color: #34d399; }
        .stat-jugando .stat-value { color: var(--accent-jugando); }
        .stat-sin-wsp .stat-value { color: var(--accent-warning); }
        .stat-no-interesado .stat-value { color: var(--accent-danger); }
        .stat-duplicados .stat-value { color: var(--accent-warning); }
        .stat-label { font-size: 0.75rem; color: var(--text-secondary); margin-top: 3px; }

        .view-actions {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
        }
        .view-actions .btn { padding: 8px 12px; font-size: 0.84rem; border-radius: 10px; }

        .nexo-brand {
            display:flex;
            align-items:center;
            gap:10px;
            margin-right:12px;
            padding:8px 12px;
            border:1px solid rgba(59,130,246,.35);
            border-radius:12px;
            background:linear-gradient(90deg, rgba(30,64,175,.24), rgba(15,23,42,.3));
            box-shadow: inset 0 0 0 1px rgba(125,211,252,.08);
        }
        .nexo-brand-logo {
            width:28px;
            height:28px;
            border-radius:8px;
            display:flex;
            align-items:center;
            justify-content:center;
            font-weight:900;
            color:#0b1220;
            background:linear-gradient(135deg,#60a5fa,#34d399);
        }
        .nexo-brand-text { font-weight:800; letter-spacing:.4px; }
        .nexo-brand-sub { font-size:.72rem; color:var(--text-secondary); }
        .view-actions .btn i { font-size: 0.9rem; }

        .btn {
            background: var(--bg-card);
            color: var(--text-primary);
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .btn:hover { background: var(--hover-color); transform: translateY(-2px); }
        .btn:active { transform: translateY(0) scale(0.98); transition-duration: .1s; }
        .btn.active { background: var(--accent-primary); color: white; }
        .btn i { font-size: 1rem; }
        .btn-danger { background: var(--accent-danger); color: white; }
        .btn-danger:hover { background: #dc2626; }


        .app-loading-overlay {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.9);
            z-index: 2200;
            display: none;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 10px;
        }
        .app-loading-overlay.active { display: flex; }
        .app-loading-overlay .progress-bar {
            width: min(520px, 82vw);
            height: 10px;
            background: #1e293b;
            border-radius: 999px;
            overflow: hidden;
        }
        .app-loading-overlay .progress-fill {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, #3b82f6, #10b981);
            transition: width .2s ease;
        }
        .btn-success { background: var(--accent-success); color: white; }
        .btn-success:hover { background: #059669; }
        .btn-warning { background: var(--accent-warning); color: white; }
        .btn-warning:hover { background: #d97706; }

        /* Barra de búsqueda */
        .search-bar {
            background: linear-gradient(180deg, rgba(30, 41, 59, 0.96), rgba(30, 41, 59, 0.88));
            padding: 15px 20px;
            border-radius: 15px;
            margin-bottom: 25px;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(148, 163, 184, 0.14);
        }
        .search-input {
            flex: 1;
            min-width: 250px;
            padding: 10px 15px;
            padding-left: 40px;
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 0.95rem;
            position: relative;
        }
        .search-input:focus { border-color: var(--accent-primary); outline: none; }
        .search-icon { position: absolute; left: 35px; top: 50%; transform: translateY(-50%); color: var(--text-secondary); pointer-events: none; }

        .filter-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .filter-select {
            padding: 10px 15px;
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 0.9rem;
            cursor: pointer;
            min-width: 150px;
        }
        .filter-select:focus { border-color: var(--accent-primary); outline: none; }

        /* Barra de acciones masivas */
        .bulk-actions-bar {
            background: linear-gradient(90deg, var(--accent-primary), #6366f1);
            padding: 15px 20px;
            border-radius: 15px;
            margin-bottom: 25px;
            display: none;
            align-items: center;
            gap: 15px;
            box-shadow: 0 5px 15px rgba(59, 130, 246, 0.3);
        }
        .bulk-actions-bar.active { display: flex; }
        .bulk-count { font-weight: 700; font-size: 1.1rem; }
        .bulk-actions { display: flex; gap: 10px; margin-left: auto; flex-wrap: wrap; }

        /* Vista de tarjetas */
        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        .contact-card {
            --status-rgb: 148,163,184;
            background: var(--bg-secondary);
            border-radius: 15px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
            position: relative;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.15);
        }
        .contact-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
            border-color: var(--accent-primary);
            z-index: 40;
        }
        .contact-card.selected { border-color: var(--accent-primary); background: var(--selection-bg); }
        .contact-card::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(120deg, rgba(var(--status-rgb),0.12), transparent 38%);
            pointer-events: none;
        }
        .contact-card::after {
            content: '';
            position: absolute;
            right: -28px;
            top: 50%;
            transform: translateY(-50%);
            width: 130px;
            height: 130px;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(var(--status-rgb),0.18) 0%, transparent 70%);
            pointer-events: none;
        }
        .contact-card.duplicate { border-color: var(--accent-warning); }
        .duplicate-badge {
            position: absolute;
            top: 10px;
            right: 50px;
            background: var(--accent-warning);
            color: white;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.7rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 5px;
            box-shadow: 0 2px 8px rgba(245, 158, 11, 0.4);
        }

        .card-checkbox {
            position: absolute;
            top: 15px;
            left: 15px;
            width: 24px;
            height: 24px;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .contact-card:hover .card-checkbox,
        .contact-card.selected .card-checkbox {
            opacity: 1;
        }

        .contact-card.selected::before {
            content: '✓';
            position: absolute;
            top: 15px;
            left: 15px;
            width: 24px;
            height: 24px;
            background: var(--accent-primary);
            color: white;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1rem;
            z-index: 1;
        }

        .card-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 15px;
            margin-top: 10px;
        }
        .card-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            background: var(--bg-card);
        }
        .card-name {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
            word-break: break-word;
            flex: 1;
        }

        .card-details {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 15px;
        }
        .detail-item {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.9rem;
            color: var(--text-secondary);
            background: rgba(15, 23, 42, 0.24);
            border: 1px solid rgba(148, 163, 184, 0.16);
            border-radius: 10px;
            padding: 8px 10px;
        }
        .detail-item i { width: 20px; text-align: center; color: var(--accent-primary); }

        .status-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        .status-sin-revisar { background: #374151; color: #9ca3af; }
        .status-contactado { background: rgba(16, 185, 129, 0.2); color: var(--accent-success); }
        .status-jugando { background: rgba(139, 92, 246, 0.2); color: var(--accent-jugando); }
        .status-sin-wsp { background: rgba(245, 158, 11, 0.2); color: var(--accent-warning); }
        .status-no-interesado { background: rgba(239, 68, 68, 0.2); color: var(--accent-danger); }
        .status-revisado { background: rgba(52, 211, 153, 0.2); color: #34d399; }
        .card-status-inline { min-width: 150px; display: inline-block; position: relative; z-index: 30; }
        .card-status-inline .status-badge { cursor: pointer; }

        .card-status-menu {
            position: absolute;
            bottom: calc(100% + 8px);
            left: 0;
            min-width: 190px;
            background: #1e293b;
            border: 1px solid rgba(148, 163, 184, 0.35);
            border-radius: 12px;
            box-shadow: 0 14px 28px rgba(2, 6, 23, 0.55);
            padding: 6px;
            z-index: 60;
        }
        .card-status-option {
            width: 100%;
            background: transparent;
            color: var(--text-primary);
            border: none;
            border-radius: 8px;
            padding: 8px 10px;
            display: flex;
            align-items: center;
            gap: 8px;
            text-align: left;
            cursor: pointer;
            font-size: 0.84rem;
        }
        .card-status-option:hover {
            background: rgba(59, 130, 246, 0.16);
        }
        .card-status-option.active {
            background: rgba(59, 130, 246, 0.22);
            font-weight: 600;
        }
        .card-status-inline::after {
            content: '\f078';
            font-family: 'Font Awesome 5 Free';
            font-weight: 900;
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
            pointer-events: none;
        }

        .card-footer {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid var(--border-color);
            font-size: 0.75rem;
            color: var(--text-secondary);
            display: flex;
            justify-content: space-between;
        }

        /* Vista de lista mejorada */
        .list-view {
            background: var(--bg-secondary);
            border-radius: 15px;
            overflow: visible;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(148, 163, 184, 0.14);
        }
        
        .list-header {
            background: var(--bg-card);
            padding: 15px 20px;
            display: grid;
            grid-template-columns: 50px 2fr 1.5fr 1.2fr 1fr 80px 380px;
            gap: 15px;
            font-weight: 600;
            font-size: 0.85rem;
            text-transform: uppercase;
            color: var(--text-secondary);
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .list-item {
            position: relative;
            overflow: visible;
            padding: 15px 20px;
            display: grid;
            grid-template-columns: 50px 2fr 1.5fr 1.2fr 1fr 80px 380px;
            gap: 15px;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: background 0.2s;
        }

        .list-item-main {
            position: relative;
            overflow: visible;
            border-radius: 12px;
            padding: 10px 12px;
            background: rgba(15, 23, 42, 0.18);
        }

        .list-item-main::before {
            content: '';
            position: absolute;
            width: 80px;
            height: 80px;
            border-radius: 50%;
            right: -18px;
            top: 50%;
            transform: translateY(-50%);
            background: radial-gradient(circle, rgba(var(--status-rgb, 148,163,184), 0.32) 0%, transparent 70%);
            pointer-events: none;
        }

        .list-status-bg-icon {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 2.1rem;
            color: var(--status-color, #94a3b8);
            opacity: 0.18;
            filter: blur(0.3px);
            pointer-events: none;
        }

        .list-name-row {
            position: relative;
            display: flex;
            align-items: center;
            gap: 8px;
            z-index: 1;
        }

        .list-status-chip {
            margin-top: 6px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 3px 10px;
            border-radius: 999px;
            font-size: 0.72rem;
            color: var(--status-color, var(--text-secondary));
            background: rgba(var(--status-rgb, 148,163,184), 0.18);
            text-transform: uppercase;
            letter-spacing: 0.03em;
            font-weight: 600;
        }
        
        .list-item:hover { background: var(--hover-color); }
        .list-item.selected { 
            background: linear-gradient(90deg, rgba(59, 130, 246, 0.15), rgba(59, 130, 246, 0.05));
            border-left: 4px solid var(--accent-primary);
        }
        .list-item.duplicate { 
            background: rgba(245, 158, 11, 0.08); 
            border-right: 4px solid var(--accent-warning); 
        }
        .list-item.duplicate.selected {
            background: linear-gradient(90deg, rgba(59, 130, 246, 0.15), rgba(245, 158, 11, 0.08));
            border-left: 4px solid var(--accent-primary);
            border-right: 4px solid var(--accent-warning);
        }
        .list-item:last-child { border-bottom: none; }

        .list-item::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(90deg, rgba(var(--status-rgb,148,163,184),0.13), transparent 35%);
            opacity: 0.5;
            pointer-events: none;
        }

        .list-item::after {
            content: '';
            position: absolute;
            width: 180px;
            height: 180px;
            right: -55px;
            top: 50%;
            transform: translateY(-50%);
            border-radius: 50%;
            background: radial-gradient(circle, rgba(var(--status-rgb,148,163,184),0.16) 0%, transparent 70%);
            pointer-events: none;
        }
        
        .list-item-name {
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .list-item-phone {
            color: var(--text-secondary);
            font-family: monospace;
        }
        
        .list-item-origin {
            color: var(--text-secondary);
        }
        
        .list-item-date {
            color: var(--text-secondary);
            font-size: 0.85rem;
        }
        
        .list-item-actions {
            display: flex;
            gap: 5px;
            justify-content: flex-end;
        }
        
        .list-item-actions .btn {
            padding: 6px 12px;
            font-size: 0.8rem;
        }

        .whatsapp-cell {
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .whatsapp-btn {
            width: 40px;
            height: 40px;
            padding: 0;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #25D366;
            color: white;
        }
        .whatsapp-btn:hover {
            background: #128C7E;
        }
        .whatsapp-btn i {
            font-size: 1.2rem;
        }

        .message-sent-tick {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            color: #60a5fa;
            font-size: 0.72rem;
            font-weight: 700;
            background: rgba(96, 165, 250, 0.14);
            border: 1px solid rgba(96, 165, 250, 0.35);
            border-radius: 999px;
            padding: 3px 7px;
            white-space: nowrap;
        }

        .message-sent-tick i {
            font-size: 0.76rem;
        }

        .status-buttons {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
            justify-content: flex-start;
        }

        .status-btn {
            padding: 0;
            width: 36px;
            height: 36px;
            border-radius: 8px;
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.2s;
            background: var(--bg-card);
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .status-btn i {
            font-size: 1rem;
        }


        .status-btn:hover {
            transform: translateY(-2px);
        }

        .status-btn.active {
            border-color: currentColor;
        }

        .status-btn.sin-revisar { color: #9ca3af; }
        .status-btn.sin-revisar.active { background: #374151; color: #9ca3af; }
        
        .status-btn.contactado { color: var(--accent-success); }
        .status-btn.revisado { color: #34d399; }
        .status-btn.revisado.active { background: rgba(52, 211, 153, 0.2); color: #34d399; }
        .status-btn.contactado.active { background: rgba(16, 185, 129, 0.2); color: var(--accent-success); }
        
        .status-btn.jugando { color: var(--accent-jugando); }
        .status-btn.jugando.active { background: rgba(139, 92, 246, 0.2); color: var(--accent-jugando); }
        
        .status-btn.sin-wsp { color: var(--accent-warning); }
        .status-btn.sin-wsp.active { background: rgba(245, 158, 11, 0.2); color: var(--accent-warning); }
        
        .status-btn.no-interesado { color: var(--accent-danger); }
        .status-btn.no-interesado.active { background: rgba(239, 68, 68, 0.2); color: var(--accent-danger); }

        .urgency-badge {
            margin-left: 8px;
            padding: 3px 8px;
            border-radius: 999px;
            font-size: 0.68rem;
            font-weight: 700;
            letter-spacing: .02em;
            text-transform: uppercase;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }
        .urgency-l1 { background: rgba(245,158,11,0.16); color: #f59e0b; }
        .urgency-l2 { background: rgba(251,146,60,0.2); color: #fb923c; }
        .urgency-l3 { background: rgba(239,68,68,0.2); color: #ef4444; }
        .urgency-l4 { background: rgba(220,38,38,0.32); color: #fecaca; }
        #exportBtn.export-urgency-1 { box-shadow: 0 0 0 2px rgba(245,158,11,.35) inset; }
        #exportBtn.export-urgency-2 { box-shadow: 0 0 0 2px rgba(249,115,22,.45) inset; }
        #exportBtn.export-urgency-3 { box-shadow: 0 0 0 2px rgba(239,68,68,.52) inset; }

        /* Barra de progreso */
        .progress-bar-container {
            background: var(--bg-secondary);
            padding: 15px 20px;
            border-radius: 15px;
            margin-bottom: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(148, 163, 184, 0.14);
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .progress-title {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .progress-percentage {
            color: var(--accent-primary);
            font-size: 1.5rem;
            font-weight: 700;
        }

        .progress-details {
            color: var(--text-secondary);
            font-size: 0.8rem;
            margin-top: 5px;
            text-align: right;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--bg-card);
            border-radius: 10px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-primary), var(--accent-success));
            transition: width 0.3s ease;
        }

        /* Paginación */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 25px;
            flex-wrap: wrap;
        }
        .pagination button {
            background: var(--bg-card);
            color: var(--text-primary);
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s;
        }
        .pagination button:hover:not(:disabled) { background: var(--hover-color); transform: translateY(-2px); }
        .pagination button:disabled { opacity: 0.5; cursor: not-allowed; }
        .pagination button.active { background: var(--accent-primary); color: white; }
        .pagination .page-info { color: var(--text-secondary); font-size: 0.9rem; }

        /* Modal de exportación */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }
        .modal.active { display: flex; }
        .modal-content {
            background: var(--bg-secondary);
            padding: 30px;
            border-radius: 20px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }
        .modal-header {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 20px;
            color: var(--text-primary);
        }
        .export-options {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin: 20px 0;
        }
        .export-option {
            background: var(--bg-card);
            padding: 15px 20px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .export-option:hover { border-color: var(--accent-primary); transform: translateY(-2px); }
        .export-option.selected { border-color: var(--accent-primary); background: var(--selection-bg); }
        .export-option i { font-size: 1.5rem; color: var(--accent-primary); }
        .export-option-text { flex: 1; }
        .export-option-title { font-weight: 600; font-size: 1rem; margin-bottom: 3px; }
        .export-option-desc { font-size: 0.85rem; color: var(--text-secondary); }

        .modal-actions {
            display: flex;
            gap: 10px;
            margin-top: 25px;
        }
        .modal-actions .btn { flex: 1; justify-content: center; }

        /* Notificaciones */
        .notification {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            padding: 15px 25px;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            gap: 15px;
            z-index: 3000;
            animation: slideIn 0.3s ease;
            max-width: 400px;
        }
        @keyframes slideIn {
            from { transform: translateX(400px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .notification.success { border-left: 4px solid var(--accent-success); }
        .notification.error { border-left: 4px solid var(--accent-danger); }
        .notification.info { border-left: 4px solid var(--accent-primary); }
        .notification i { font-size: 1.5rem; }
        .notification.success i { color: var(--accent-success); }
        .notification.error i { color: var(--accent-danger); }
        .notification.info i { color: var(--accent-primary); }

        .global-announcement {
            position: fixed;
            top: 18px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 3200;
            min-width: 320px;
            max-width: min(760px, 92vw);
            background: rgba(15,23,42,.95);
            border: 1px solid rgba(148,163,184,.35);
            border-radius: 12px;
            padding: 10px 14px;
            display: none;
            align-items: center;
            gap: 10px;
            box-shadow: 0 12px 30px rgba(2, 6, 23, .45);
            animation: announceIn .25s ease-out;
        }
        .global-announcement.show { display: flex; }
        .global-announcement.info { border-color: rgba(59,130,246,.45); }
        .global-announcement.success { border-color: rgba(34,197,94,.45); }
        .global-announcement.warn { border-color: rgba(239,68,68,.45); }
        .global-announcement .announce-dot {
            width: 9px; height: 9px; border-radius: 50%; background: #60a5fa;
            animation: pulseDot 1.6s ease-in-out infinite;
        }
        .global-announcement.success .announce-dot { background: #34d399; }
        .global-announcement.warn .announce-dot { background: #f87171; }
        .global-announcement .announce-text { font-size: .86rem; color: var(--text-primary); }

        .loading-overlay {
            position: fixed;
            inset: 0;
            z-index: 3300;
            background: rgba(2, 6, 23, 0.72);
            backdrop-filter: blur(2px);
            display: none;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity .18s ease;
            pointer-events: none;
        }
        .loading-overlay.show { display: flex; opacity: 1; }
        .loading-card {
            width: min(540px, 92vw);
            border-radius: 14px;
            background: linear-gradient(180deg, rgba(15,23,42,.96), rgba(15,23,42,.9));
            border: 1px solid rgba(148,163,184,.3);
            box-shadow: 0 16px 36px rgba(2,6,23,.48);
            padding: 18px;
            animation: loaderIn .2s ease;
        }
        .loading-title { font-weight: 700; font-size: 1.06rem; }
        .loading-sub { color: var(--text-secondary); margin-top: 6px; font-size: .9rem; }
        .loading-bar { margin-top: 12px; width: 100%; height: 8px; border-radius: 999px; background: rgba(148,163,184,.25); overflow: hidden; }
        .loading-bar span { display: block; height: 100%; width: 0%; border-radius: 999px; background: linear-gradient(90deg, #60a5fa, #34d399); transition: width .16s linear; }
        .loading-meta { margin-top: 8px; font-size: .82rem; color: var(--text-secondary); }
        @keyframes loaderIn {
            from { opacity: 0; transform: translateY(8px) scale(.985); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        @keyframes announceIn {
            from { transform: translateX(-50%) translateY(-10px); opacity: 0; }
            to { transform: translateX(-50%) translateY(0); opacity: 1; }
        }
        @keyframes pulseDot {
            0%, 100% { transform: scale(1); opacity: .9; }
            50% { transform: scale(1.35); opacity: .5; }
        }

        .contact-card, .list-item {
            animation: fadeInItem .2s ease-out;
        }
        @keyframes fadeInItem {
            from { opacity: .0; transform: translateY(3px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .ops-chip-row { display: flex; gap: 6px; flex-wrap: wrap; align-items: center; margin-top: 6px; }
        .ops-chip {
            font-size: 0.72rem;
            padding: 2px 7px;
            border-radius: 999px;
            background: rgba(59,130,246,.16);
            border: 1px solid rgba(96,165,250,.32);
            color: #bfdbfe;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }
        .ops-chip.hot { background: rgba(16,185,129,.18); border-color: rgba(16,185,129,.4); color: #a7f3d0; }
        .ops-chip.cold { background: rgba(148,163,184,.16); border-color: rgba(148,163,184,.35); color: #cbd5e1; }
        .ops-info-wrap { position: relative; display: inline-flex; }
        .ops-info-btn {
            width: 20px; height: 20px; border-radius: 50%; border: 1px solid rgba(148,163,184,.35);
            background: rgba(15,23,42,.5); color: #cbd5e1; font-size: .72rem; cursor: help;
        }
        .ops-tooltip {
            position: absolute; z-index: 90; top: 24px; right: 0; width: 280px;
            background: #0f172a; border: 1px solid rgba(148,163,184,.35); border-radius: 10px;
            padding: 10px; display: none; box-shadow: 0 12px 24px rgba(2,6,23,.5); font-size: .78rem;
        }
        .ops-info-wrap:hover .ops-tooltip { display: block; }
        .ops-tooltip .line { display: flex; justify-content: space-between; gap: 8px; margin: 4px 0; color: var(--text-secondary); }
        .ops-tooltip .line strong { color: var(--text-primary); }
        .btn.needs-upload { box-shadow: 0 0 0 2px rgba(239,68,68,.5) inset; }
        .save-state-badge {
            margin-left: 8px;
            font-size: 0.78rem;
            padding: 6px 10px;
            border-radius: 999px;
            border: 1px solid rgba(148,163,184,.35);
            color: var(--text-secondary);
            background: rgba(15,23,42,.35);
            white-space: nowrap;
        }
        .save-state-badge.ok { color: #86efac; border-color: rgba(34,197,94,.35); }
        .save-state-badge.warn { color: #fca5a5; border-color: rgba(239,68,68,.35); }
        .storage-meter {
            margin-left: 6px;
            font-size: 0.78rem;
            padding: 6px 10px;
            border-radius: 999px;
            border: 1px solid rgba(148,163,184,.35);
            color: #cbd5e1;
            background: rgba(15,23,42,.35);
            white-space: nowrap;
            cursor: help;
        }
        .storage-meter.ok { color: #86efac; border-color: rgba(34,197,94,.35); }
        .storage-meter.warn { color: #fde68a; border-color: rgba(245,158,11,.4); }
        .storage-meter.critical { color: #fca5a5; border-color: rgba(239,68,68,.45); }
        .save-state-badge.pending { color: #fcd34d; border-color: rgba(245,158,11,.35); }

        /* Historial */
        .history-list {
            max-height: none;
            overflow-y: auto;
            flex: 1;
            min-height: 260px;
        }
        .history-item {
            background: var(--bg-card);
            padding: 12px 15px;
            margin: 8px 0;
            border-radius: 8px;
            font-size: 0.9rem;
            border-left: 3px solid var(--accent-primary);
        }
        .history-time {
            color: var(--text-secondary);
            font-size: 0.8rem;
            margin-bottom: 5px;
        }
        .history-action {
            color: var(--text-primary);
        }
        .history-modal-content {
            max-height: 82vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .history-toolbar {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .history-toolbar #historySearchInput { flex: 1; }
        .history-count-label {
            color: var(--text-secondary);
            font-size: 0.85rem;
            white-space: nowrap;
        }
        .history-item {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .history-item-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        .history-item-muted {
            border-left-color: rgba(148, 163, 184, 0.45);
            opacity: 0.85;
        }

        /* Duplicados */
        .duplicates-list {
            max-height: 500px;
            overflow-y: auto;
            margin: 20px 0;
        }
        .duplicate-group {
            background: var(--bg-card);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            border-left: 4px solid var(--accent-warning);
        }
        .duplicate-group-header {
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--accent-warning);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .duplicate-item {
            background: var(--bg-secondary);
            padding: 10px;
            margin: 5px 0;
            border-radius: 8px;
            font-size: 0.9rem;
        }
        .duplicate-item-detail {
            color: var(--text-secondary);
            font-size: 0.85rem;
            margin-left: 10px;
        }


        .whatsapp-template {
            margin-top: 15px;
            background: var(--bg-card);
            border-radius: 12px;
            padding: 12px;
            border: 1px solid rgba(148, 163, 184, 0.2);
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .whatsapp-template textarea {
            width: 100%;
            min-height: 88px;
            resize: vertical;
            background: #0f172a;
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            border-radius: 8px;
            padding: 10px;
        }
        .template-actions { display: flex; gap: 8px; flex-wrap: wrap; }
        .template-help { color: var(--text-secondary); font-size: 0.82rem; }


        .failsafe-downgrade-btn {
            position: fixed;
            right: 14px;
            top: 10px;
            z-index: 99999;
            background: rgba(17,24,39,.92);
            color: #e5e7eb;
            border: 1px solid rgba(148,163,184,.35);
            border-radius: 10px;
            padding: 7px 11px;
            font-size: 12px;
            text-decoration: none;
            box-shadow: 0 8px 25px rgba(0,0,0,.35);
        }
        .failsafe-downgrade-btn:hover { border-color: rgba(59,130,246,.6); color: #fff; }

        .duplicates-config {
            margin: 12px 0;
            padding: 10px;
            border-radius: 8px;
            background: rgba(30,41,59,0.65);
            border: 1px solid rgba(148,163,184,0.2);
            font-size: 0.85rem;
            color: var(--text-secondary);
            display: flex;
            gap: 8px;
            flex-direction: column;
        }
        .shortcut-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 8px;
            margin-top: 10px;
        }
        .shortcut-item {
            background: var(--bg-card);
            border-radius: 8px;
            padding: 8px 10px;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }
        .shortcut-item kbd {
            background: #0f172a;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 2px 6px;
            color: var(--text-primary);
        }
        @media (max-width: 768px) {
            .navbar, .search-bar { flex-direction: column; align-items: stretch; }
            .stats { justify-content: center; }
            .list-header { display: none; }
            .list-item {
                grid-template-columns: 1fr;
                gap: 8px;
            }
            .list-item-main {
                width: 100%;
            }
            .cards-grid { grid-template-columns: 1fr; }
            .quick-layout { grid-template-columns: 1fr; }
            .review-actions { grid-template-columns: 1fr; }
            .quick-topbar { flex-direction: column; align-items: flex-start; }
        }
    
        #mainApp.shifts-mode .search-bar { display: none; }
        #mainApp.shifts-mode .bulk-actions-bar { display: none !important; }
        #mainApp.shifts-mode .shifts-view { margin-top: 0; }
        .shifts-overview-card { grid-column: 1 / -1; background: linear-gradient(180deg, rgba(15,23,42,.9), rgba(15,23,42,.75)); border:1px solid rgba(96,165,250,.28); border-radius:14px; padding:14px; display:flex; flex-wrap:wrap; gap:12px; align-items:center; justify-content:space-between; }
        .shifts-overview-stats { display:flex; flex-wrap:wrap; gap:14px; color:var(--text-secondary); font-size:.9rem; }
        .shifts-overview-stats strong { color:var(--text-primary); }
        .shifts-overview-actions { display:flex; gap:8px; flex-wrap:wrap; }
        .shifts-view { display:none; gap:14px; grid-template-columns: repeat(auto-fit,minmax(280px,1fr)); }
        .shift-card { background: linear-gradient(180deg, rgba(30,41,59,.95), rgba(30,41,59,.82)); border:1px solid rgba(148,163,184,.2); border-radius:14px; padding:14px; }
        .shift-card h3 { margin:0 0 8px 0; display:flex; justify-content:space-between; align-items:center; font-size:1.05rem; }
        .shift-card-sub { color: var(--text-secondary); font-size: .8rem; margin-bottom: 8px; }
        .shift-progress { height:8px; border-radius:999px; background:rgba(148,163,184,.2); overflow:hidden; margin:8px 0; }
        .shift-progress > span { display:block; height:100%; background:linear-gradient(90deg,#34d399,#3b82f6); }
        .shift-stats { display:flex; gap:10px; font-size:.8rem; color:var(--text-secondary); flex-wrap:wrap; }
        .review-quick { margin-top:16px; background:linear-gradient(180deg, rgba(30,41,59,.98), rgba(15,23,42,.92)); border:1px solid rgba(148,163,184,.22); border-radius:16px; padding:18px; display:none; }
        .quick-layout { display:grid; grid-template-columns: minmax(260px, 340px) 1fr; gap:14px; }
        .quick-profile { background:rgba(15,23,42,.45); border:1px solid rgba(148,163,184,.25); border-radius:12px; padding:14px; }
        .profiles-art { position:relative; overflow:hidden; }
        .profiles-art::before { content:''; position:absolute; inset:-40% -10% auto auto; width:320px; height:320px; border-radius:999px; background:radial-gradient(circle at center, rgba(56,189,248,.18), rgba(56,189,248,0)); transform:translate(30px,-30px); pointer-events:none; }
        .profiles-art::after { content:''; position:absolute; inset:auto auto -45% -12%; width:280px; height:280px; border-radius:999px; background:radial-gradient(circle at center, rgba(99,102,241,.16), rgba(99,102,241,0)); pointer-events:none; }
        .quick-profile-head { display:flex; gap:12px; align-items:center; }
        .quick-avatar { width:52px; height:52px; border-radius:50%; background:linear-gradient(135deg, rgba(59,130,246,.25), rgba(16,185,129,.2)); border:1px solid rgba(96,165,250,.4); display:flex; align-items:center; justify-content:center; font-weight:800; color:#bfdbfe; font-size:1rem; }
        .quick-name { font-size:1.25rem; font-weight:800; line-height:1.1; }
        .quick-name.copyable { cursor: pointer; display:inline-flex; align-items:center; gap:6px; }
        .quick-name.copyable:hover { color:#93c5fd; text-decoration: underline; }
        .quick-meta { color:var(--text-secondary); font-size:.9rem; margin-top:3px; }
        .quick-chips { display:flex; gap:8px; flex-wrap:wrap; margin-top:10px; }
        .quick-chip { font-size:.74rem; padding:4px 9px; border-radius:999px; border:1px solid rgba(148,163,184,.35); color:#cbd5e1; background:rgba(30,41,59,.5); }
        .quick-progress { margin-top:10px; color:var(--text-secondary); font-size:.82rem; }
        .quick-panel { background:rgba(15,23,42,.24); border:1px solid rgba(148,163,184,.2); border-radius:12px; padding:12px; }
        .quick-topbar { display:flex; justify-content:space-between; align-items:center; gap:10px; margin-bottom:10px; }
        .review-actions { display:grid; grid-template-columns: repeat(3,minmax(170px,1fr)); gap:10px; }
        .review-actions .btn { justify-content:flex-start; padding:12px 14px; font-weight:700; }
        .review-actions .quick-status-btn { border:1px solid rgba(148,163,184,.28); }
        .review-actions .quick-status-btn.sin-revisar { border-color: rgba(148,163,184,.45); }
        .review-actions .quick-status-btn.contactado { border-color: rgba(16,185,129,.45); }
        .review-actions .quick-status-btn.revisado { border-color: rgba(52,211,153,.45); }
        .review-actions .quick-status-btn.jugando { border-color: rgba(139,92,246,.45); }
        .review-actions .quick-status-btn.sin-wsp { border-color: rgba(245,158,11,.45); }
        .review-actions .quick-status-btn.no-interesado { border-color: rgba(239,68,68,.45); }
        .review-actions .btn.applied { box-shadow: 0 0 0 2px rgba(52,211,153,.45) inset; transform: scale(0.98); }
        .quick-panel.updating { opacity: .82; transition: opacity .1s linear; }
        .quick-tools { display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin-top:12px; border-top:1px solid rgba(148,163,184,.22); padding-top:10px; }
        .quick-tools .btn { padding: 10px 12px; font-size: .9rem; }
        .shift-tag { font-size:.72rem; padding:2px 8px; border-radius:999px; border:1px solid rgba(148,163,184,.35); color:#cbd5e1; }
        body.perf-mode *,
        body.perf-mode *::before,
        body.perf-mode *::after {
            animation: none !important;
            transition: none !important;
            scroll-behavior: auto !important;
        }

        .metrics-dashboard-grid { display:grid; grid-template-columns: repeat(2, minmax(180px,1fr)); gap:10px; margin:12px 0; }
        .metrics-card { background: rgba(30,41,59,.7); border:1px solid rgba(148,163,184,.25); border-radius:12px; padding:10px; }
        .metrics-card .k { color:var(--text-secondary); font-size:.8rem; }
        .metrics-card .v { font-size:1.2rem; font-weight:800; margin-top:4px; }
        .metrics-actions { display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
        body.perf-mode *,
        body.perf-mode *::before,
        body.perf-mode *::after {
            animation: none !important;
            transition: none !important;
            scroll-behavior: auto !important;
        }

        .metrics-dashboard-grid { display:grid; grid-template-columns: repeat(2, minmax(180px,1fr)); gap:10px; margin:12px 0; }
        .metrics-card { background: rgba(30,41,59,.7); border:1px solid rgba(148,163,184,.25); border-radius:12px; padding:10px; }
        .metrics-card .k { color:var(--text-secondary); font-size:.8rem; }
        .metrics-card .v { font-size:1.2rem; font-weight:800; margin-top:4px; }
        .metrics-actions { display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
        body.perf-mode *,
        body.perf-mode *::before,
        body.perf-mode *::after {
            animation: none !important;
            transition: none !important;
            scroll-behavior: auto !important;
        }

        .metrics-dashboard-grid { display:grid; grid-template-columns: repeat(2, minmax(180px,1fr)); gap:10px; margin:12px 0; }
        .metrics-card { background: rgba(30,41,59,.7); border:1px solid rgba(148,163,184,.25); border-radius:12px; padding:10px; }
        .metrics-card .k { color:var(--text-secondary); font-size:.8rem; }
        .metrics-card .v { font-size:1.2rem; font-weight:800; margin-top:4px; }
        .metrics-actions { display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
        body.perf-mode *,
        body.perf-mode *::before,
        body.perf-mode *::after {
            animation: none !important;
            transition: none !important;
            scroll-behavior: auto !important;
        }

        .metrics-dashboard-grid { display:grid; grid-template-columns: repeat(2, minmax(180px,1fr)); gap:10px; margin:12px 0; }
        .metrics-card { background: rgba(30,41,59,.7); border:1px solid rgba(148,163,184,.25); border-radius:12px; padding:10px; }
        .metrics-card .k { color:var(--text-secondary); font-size:.8rem; }
        .metrics-card .v { font-size:1.2rem; font-weight:800; margin-top:4px; }
        .metrics-actions { display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
        body.perf-mode *,
        body.perf-mode *::before,
        body.perf-mode *::after {
            animation: none !important;
            transition: none !important;
            scroll-behavior: auto !important;
        }

        .metrics-dashboard-grid { display:grid; grid-template-columns: repeat(2, minmax(180px,1fr)); gap:10px; margin:12px 0; }
        .metrics-card { background: rgba(30,41,59,.7); border:1px solid rgba(148,163,184,.25); border-radius:12px; padding:10px; }
        .metrics-card .k { color:var(--text-secondary); font-size:.8rem; }
        .metrics-card .v { font-size:1.2rem; font-weight:800; margin-top:4px; }
        .metrics-actions { display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
        body.perf-mode *,
        body.perf-mode *::before,
        body.perf-mode *::after {
            animation: none !important;
            transition: none !important;
            scroll-behavior: auto !important;
        }

        .metrics-dashboard-grid { display:grid; grid-template-columns: repeat(2, minmax(180px,1fr)); gap:10px; margin:12px 0; }
        .metrics-card { background: rgba(30,41,59,.7); border:1px solid rgba(148,163,184,.25); border-radius:12px; padding:10px; }
        .metrics-card .k { color:var(--text-secondary); font-size:.8rem; }
        .metrics-card .v { font-size:1.2rem; font-weight:800; margin-top:4px; }
        .metrics-actions { display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
        body.perf-mode *,
        body.perf-mode *::before,
        body.perf-mode *::after {
            animation: none !important;
            transition: none !important;
            scroll-behavior: auto !important;
        }

        .metrics-dashboard-grid { display:grid; grid-template-columns: repeat(2, minmax(180px,1fr)); gap:10px; margin:12px 0; }
        .metrics-card { background: rgba(30,41,59,.7); border:1px solid rgba(148,163,184,.25); border-radius:12px; padding:10px; }
        .metrics-card .k { color:var(--text-secondary); font-size:.8rem; }
        .metrics-card .v { font-size:1.2rem; font-weight:800; margin-top:4px; }
        .metrics-actions { display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
        body.perf-mode *,
        body.perf-mode *::before,
        body.perf-mode *::after {
            animation: none !important;
            transition: none !important;
            scroll-behavior: auto !important;
        }

        .metrics-dashboard-grid { display:grid; grid-template-columns: repeat(2, minmax(180px,1fr)); gap:10px; margin:12px 0; }
        .metrics-card { background: rgba(30,41,59,.7); border:1px solid rgba(148,163,184,.25); border-radius:12px; padding:10px; }
        .metrics-card .k { color:var(--text-secondary); font-size:.8rem; }
        .metrics-card .v { font-size:1.2rem; font-weight:800; margin-top:4px; }
        .metrics-actions { display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
        body.perf-mode *,
        body.perf-mode *::before,
        body.perf-mode *::after {
            animation: none !important;
            transition: none !important;
            scroll-behavior: auto !important;
        }

    </style>
</head>
<body __processed_06e8811e-2870-46d5-8df7-cb489419a036__="true">
    <a class="failsafe-downgrade-btn" href="nexo://rollback-previous" target="_blank" rel="noopener noreferrer">⛑️ Volver a versión anterior (cache local)</a>
    <div class="upload-screen" id="uploadScreen">
        <div class="upload-card">
            <i class="fas fa-cloud-upload-alt"></i>
            <h1>Gestor de Contactos Masivo</h1>
            <p style="color: var(--text-secondary); margin-bottom: 20px;">Importa tus contactos desde archivos CSV</p>
            <div class="file-upload-area" id="uploadArea">
                <i class="fas fa-file-csv" style="font-size: 3rem; color: var(--accent-primary);"></i>
                <p style="margin-top: 15px; color: var(--text-secondary);">Arrastra archivos CSV, VCF o JSON aquí o haz clic para seleccionar</p>
                <input type="file" id="fileInput" accept=".csv,.vcf,.json" multiple="" style="display: none;">
            </div>
            <div class="file-list" id="fileList"></div>
            <input type="text" id="originInput" class="origin-input" placeholder="Origen de los contactos (ej: Turno Mañana, Facebook, etc.)">
            <button id="startBtn" class="btn-primary" disabled>Comenzar</button>
            <button id="preStartCheckUpdatesBtn" class="btn" style="margin-top:10px;"><i class="fas fa-cloud-download-alt"></i> Buscar actualizaciones antes de iniciar</button>
        </div>
    </div>

    <div class="container" id="mainApp" style="display: none;">
        <div id="globalAnnouncement" class="global-announcement info" aria-live="polite">
            <span class="announce-dot"></span>
            <span class="announce-text">Sistema listo</span>
        </div>
        <div id="loadingOverlay" class="loading-overlay" aria-live="polite">
            <div class="loading-card">
                <div class="loading-title">Cargando contactos…</div>
                <div class="loading-sub" id="loadingOverlayText">Preparando datos para trabajar sin bloqueos visuales.</div>
                <div class="loading-bar"><span id="loadingOverlayProgress"></span></div>
                <div class="loading-meta" id="loadingOverlayMeta">0%</div>
            </div>
        </div>
        <!-- Barra de navegación -->
        <div class="navbar">
            <div class="nexo-brand" title="Nexo Desktop">
                <div class="nexo-brand-logo">N</div>
                <div>
                    <div class="nexo-brand-text">Nexo</div>
                    <div class="nexo-brand-sub">Desktop</div>
                </div>
            </div>
            <div class="stats">
                <div class="stat-box stat-total" data-filter="">
                    <div class="stat-value" id="totalCount">0</div>
                    <div class="stat-label">Total</div>
                </div>
                <div class="stat-box stat-unreviewed" data-filter="sin revisar">
                    <div class="stat-value" id="unreviewedCount">0</div>
                    <div class="stat-label">Sin Revisar</div>
                </div>
                <div class="stat-box stat-contactado" data-filter="contactado">
                    <div class="stat-value" id="contactadoCount">0</div>
                    <div class="stat-label">Contactado</div>
                </div>
                <div class="stat-box stat-revisado" data-filter="revisado">
                    <div class="stat-value" id="revisadoCount">0</div>
                    <div class="stat-label">Revisado</div>
                </div>
                <div class="stat-box stat-jugando" data-filter="jugando">
                    <div class="stat-value" id="jugandoCount">0</div>
                    <div class="stat-label">Jugando</div>
                </div>
                <div class="stat-box stat-sin-wsp" data-filter="sin wsp">
                    <div class="stat-value" id="sinWspCount">0</div>
                    <div class="stat-label">Sin WSP</div>
                </div>
                <div class="stat-box stat-no-interesado" data-filter="no interesado">
                    <div class="stat-value" id="noInteresadoCount">0</div>
                    <div class="stat-label">No Interesado</div>
                </div>
                <div class="stat-box stat-duplicados" id="duplicatesStatBox">
                    <div class="stat-value" id="duplicatesCount">0</div>
                    <div class="stat-label">Duplicados</div>
                </div>
            </div>
            <div class="view-actions" style="margin-right:8px;">
                <select id="profileSelect" class="filter-select" style="min-width:200px;"></select>
                <button id="manageProfilesBtn" class="btn"><i class="fas fa-layer-group"></i> Perfiles</button>
            </div>
            <div class="view-actions">
                <button id="viewCardsBtn" class="btn active"><i class="fas fa-th"></i> Tarjetas</button>
                <button id="viewListBtn" class="btn"><i class="fas fa-list"></i> Lista</button>
                <button id="viewShiftsBtn" class="btn"><i class="fas fa-users-cog"></i> Turnos</button>
                <button id="exportBtn" class="btn"><i class="fas fa-download"></i> Exportar</button>
                <button id="historyBtn" class="btn"><i class="fas fa-history"></i> Historial</button>
                <button id="manageDuplicatesBtn" class="btn btn-warning"><i class="fas fa-clone"></i> Duplicados</button>
                <button id="checkUpdatesBtn" class="btn"><i class="fas fa-cloud-download-alt"></i> Buscar updates</button>
                <button id="settingsBtn" class="btn"><i class="fas fa-cog"></i> Ajustes</button>
                <button id="importOpsBtn" class="btn" title="Importar agent_operations.csv"><i class="fas fa-chart-line"></i> Operaciones</button>
                <button id="deleteAllBtn" class="btn btn-danger"><i class="fas fa-trash-alt"></i> Borrar Todo</button>
                <span id="saveStateBadge" class="save-state-badge pending">● Pendiente</span>
                                <input type="file" id="opsFileInput" accept=".csv" style="display:none;">
            </div>
        </div>

        <!-- Barra de progreso de revisión -->
        <div class="progress-bar-container" id="progressBarContainer">
            <div class="progress-header">
                <span class="progress-title">Progreso de revisión</span>
                <div style="text-align: right;">
                    <div class="progress-percentage" id="progressPercentage">0%</div>
                    <div class="progress-details"><span id="reviewedCount">0</span> revisados de <span id="totalContactsCount">0</span> totales</div>
                </div>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill" style="width: 0%"></div>
            </div>
        </div>

        <!-- Barra de búsqueda y filtros -->
        <div class="search-bar" style="position: relative;">
            <i class="fas fa-search" style="position: absolute; left: 35px; top: 50%; transform: translateY(-50%); color: var(--text-secondary); pointer-events: none; z-index: 1;"></i>
            <input type="text" id="searchInput" class="search-input" placeholder="Buscar... (ej: pepe, 11, estado:jugando, turno:tm, origen:csv)" style="padding-left: 40px;">
            <div class="filter-group">
                <select id="statusFilter" class="filter-select">
                    <option value="">Todos los estados</option>
                    <option value="sin revisar">Sin Revisar</option>
                    <option value="contactado">Contactado</option>
                    <option value="revisado">Revisado</option>
                    <option value="jugando">Jugando</option>
                    <option value="sin wsp">Sin WhatsApp</option>
                    <option value="no interesado">No Interesado</option>
                </select>
                <select id="originFilter" class="filter-select"><option value="">Todos los orígenes</option></select>
                <select id="opsSegmentFilter" class="filter-select">
                    <option value="all">Todos</option>
                    <option value="top50">Top 50</option>
                    <option value="top100">Top 100</option>
                    <option value="matched">Con movimiento</option>
                    <option value="nomatch">Sin movimiento</option>
                </select>
                <select id="shiftFilter" class="filter-select">
                    <option value="">Todos los turnos</option>
                    <option value="tm">Turno TM</option>
                    <option value="tt">Turno TT</option>
                    <option value="tn">Turno TN</option>
                </select>
                <select id="phoneFilter" class="filter-select">
                    <option value="all">Teléfono: todos</option>
                    <option value="with">Con teléfono</option>
                    <option value="without">Sin teléfono</option>
                </select>
                <select id="editActivityFilter" class="filter-select">
                    <option value="all">Ediciones: todas</option>
                    <option value="today10plus">Editados hoy (si +10)</option>
                    <option value="any10plus">Días con +10 ediciones</option>
                </select>
                <button id="clearFiltersBtn" class="btn" title="Limpiar búsqueda y filtros">
                    <i class="fas fa-filter-circle-xmark"></i> Limpiar
                </button>
                <button id="selectFilteredBtn" class="btn" title="Seleccionar todos los contactos filtrados">
                    <i class="fas fa-check-double"></i> Seleccionar filtrados
                </button>
                <button id="clearSelectionBtn" class="btn" title="Limpiar selección actual">
                    <i class="fas fa-eraser"></i> Limpiar selección
                </button>
                <button id="undoBtn" class="btn" title="Volver al último contacto editado (Ctrl+Z)">
                    <i class="fas fa-undo"></i> Volver
                </button>
                <button id="addMoreBtn" class="btn btn-success"><i class="fas fa-file-upload"></i> Importar CSV</button>
                <button id="addSingleBtn" class="btn btn-success"><i class="fas fa-user-plus"></i> Crear Usuario</button>
            </div>
        </div>

        <!-- Barra de acciones masivas -->
        <div class="bulk-actions-bar" id="bulkActionsBar">
            <span class="bulk-count"><span id="selectedCount">0</span> seleccionados</span>
            <div class="bulk-actions">
                <select id="bulkStatusSelect" class="filter-select" style="min-width: 180px;"><option value="" disabled="" selected="">Cambiar estado</option><option value="sin revisar">Sin Revisar</option><option value="contactado">Contactado</option><option value="revisado">Revisado</option><option value="jugando">Jugando</option><option value="sin wsp">Sin WhatsApp</option><option value="no interesado">No Interesado</option></select>
                <button id="bulkDeleteBtn" class="btn btn-danger"><i class="fas fa-trash"></i> Eliminar</button>
                <button id="bulkCancelBtn" class="btn"><i class="fas fa-times"></i> Cancelar</button>
            </div>
        </div>

        <!-- Vista de tarjetas -->
        <div id="cardsView" class="cards-grid"></div>

        <!-- Vista de lista -->
        <div id="listView" class="list-view" style="display: none;"></div>

        <div id="shiftsView" class="shifts-view"></div>
        <div id="quickReview" class="review-quick"></div>


        <!-- Paginación -->
        <div class="pagination" id="pagination"></div>
    </div>

    <!-- Modal de exportación -->
    <div class="modal" id="exportModal">
        <div class="modal-content">
            <div class="modal-header"><i class="fas fa-download"></i> Exportar Contactos</div>
            <div class="export-options">
                <div class="export-option" data-type="filtered">
                    <i class="fas fa-filter"></i>
                    <div class="export-option-text">
                        <div class="export-option-title">Exportar filtrados</div>
                        <div class="export-option-desc"><span id="exportFilteredCount">0</span> contactos visibles</div>
                    </div>
                </div>
                <div class="export-option selected" data-type="all">
                    <i class="fas fa-users"></i>
                    <div class="export-option-text">
                        <div class="export-option-title">Exportar todos</div>
                        <div class="export-option-desc"><span id="exportAllCount">0</span> contactos totales</div>
                    </div>
                </div>
            </div>
            <div class="export-options">
                <div class="export-option" data-format="vcf">
                    <i class="fas fa-address-card"></i>
                    <div class="export-option-text">
                        <div class="export-option-title">VCF (Contactos)</div>
                        <div class="export-option-desc">Importable directamente a WhatsApp</div>
                    </div>
                </div>
                <div class="export-option selected" data-format="sheet">
                    <i class="fas fa-table"></i>
                    <div class="export-option-text">
                        <div class="export-option-title">Formato Planilla</div>
                        <div class="export-option-desc">Formato personalizado con columnas especiales</div>
                    </div>
                </div>
            </div>
            <div class="modal-actions">
                <button id="cancelExport" class="btn"><i class="fas fa-times"></i> Cancelar</button>
                <button id="confirmExport" class="btn btn-success"><i class="fas fa-download"></i> Exportar</button>
            </div>
        </div>
    </div>

    <!-- Modal de duplicados -->
    <div class="modal" id="duplicatesModal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header"><i class="fas fa-clone"></i> Gestionar Duplicados</div>
            <div id="duplicatesContent">
                <p style="color: var(--text-secondary); margin: 20px 0;">Detectando duplicados...</p>
            </div>
            <div class="modal-actions">
                <button id="closeDuplicatesModal" class="btn"><i class="fas fa-times"></i> Cerrar</button>
                <button id="mergeAllDuplicates" class="btn btn-success" style="display: none;"><i class="fas fa-compress-alt"></i> Fusionar Todos</button>
            </div>
        </div>
    </div>

    <!-- Modal de historial -->
    <div class="modal" id="historyModal">
        <div class="modal-content history-modal-content" style="max-width: 900px;">
            <div class="modal-header"><i class="fas fa-history"></i> Historial de Cambios</div>
            <div class="history-toolbar">
                <input type="text" id="historySearchInput" class="filter-select" placeholder="Filtrar historial por usuario o acción...">
                <span id="historyCountLabel" class="history-count-label"></span>
            </div>
            <div class="history-list" id="historyList"></div>
            <div class="modal-actions">
                <button id="closeHistoryModal" class="btn"><i class="fas fa-times"></i> Cerrar</button>
                <button id="clearHistoryBtn" class="btn btn-danger"><i class="fas fa-trash"></i> Borrar Historial</button>
            </div>
        </div>
    </div>


    <div class="modal" id="contactHistoryModal">
        <div class="modal-content history-modal-content" style="max-width: 860px;">
            <div class="modal-header"><i class="fas fa-id-card"></i> Historial por usuario</div>
            <div id="contactHistoryMeta" class="contact-history-meta"></div>
            <div class="history-list" id="contactHistoryList"></div>
            <div class="modal-actions">
                <button id="closeContactHistoryModal" class="btn"><i class="fas fa-times"></i> Cerrar</button>
            </div>
        </div>
    </div>

    <div class="modal" id="shortcutsModal">
        <div class="modal-content" style="max-width:700px;">
            <div class="modal-header"><i class="fas fa-keyboard"></i> Atajos de Teclado (Numpad)</div>
            <p style="color: var(--text-secondary);">Se evita usar números superiores para no interferir con macros de trabajo.</p>
            <div class="shortcut-list">
                <div class="shortcut-item"><kbd>Numpad 1</kbd> Estado: Sin revisar</div>
                <div class="shortcut-item"><kbd>Numpad 2</kbd> Estado: Contactado</div>
                <div class="shortcut-item"><kbd>Numpad 3</kbd> Estado: Jugando</div>
                <div class="shortcut-item"><kbd>Numpad 4</kbd> Estado: Sin WSP</div>
                <div class="shortcut-item"><kbd>Numpad 5</kbd> Estado: No interesado</div>
                <div class="shortcut-item"><kbd>Numpad 0</kbd> Volver al último contacto</div>
                <div class="shortcut-item"><kbd>Numpad +</kbd> Cambiar a vista Lista</div>
                <div class="shortcut-item"><kbd>Esc</kbd> Cerrar modales y menús abiertos</div>
            </div>
            <div class="modal-actions">
                <button id="closeShortcutsModal" class="btn btn-success"><i class="fas fa-check"></i> Entendido</button>
            </div>
        </div>
    </div>


    <div class="modal" id="userOptionsModal">
        <div class="modal-content" style="max-width: 480px;">
            <div class="modal-header"><i class="fas fa-sliders-h"></i> Ajustes</div>
            <div class="export-options">
                <div class="export-option" id="openShortcutsOption">
                    <i class="fas fa-keyboard"></i>
                    <div class="export-option-text">
                        <div class="export-option-title">Ver atajos de teclado</div>
                        <div class="export-option-desc">Abrir la ayuda de Numpad y accesos rápidos</div>
                    </div>
                </div>
                <div class="export-option" id="openWhatsappMessageOption">
                    <i class="fab fa-whatsapp"></i>
                    <div class="export-option-text">
                        <div class="export-option-title">Cambiar mensaje WhatsApp</div>
                        <div class="export-option-desc">Editar plantilla con token {usuario}</div>
                    </div>
                </div>
                <div class="export-option" id="openGithubReleasesOption">
                    <i class="fab fa-github"></i>
                    <div class="export-option-text">
                        <div class="export-option-title">Descarga manual (seguro)</div>
                        <div class="export-option-desc">Abrir Releases oficiales en GitHub</div>
                    </div>
                </div>

                <div class="export-option" id="rollbackPreviousOption">
                    <i class="fas fa-history"></i>
                    <div class="export-option-text">
                        <div class="export-option-title">Volver a versión anterior</div>
                        <div class="export-option-desc">Rollback desde instalador cacheado local</div>
                    </div>
                </div>
                <div class="export-option" id="openStable110Option">
                    <i class="fas fa-shield-alt"></i>
                    <div class="export-option-text">
                        <div class="export-option-title">Descargar 1.1.10 stable</div>
                        <div class="export-option-desc">Downgrade manual seguro</div>
                    </div>
                </div>
                <div class="export-option" id="openErrorLogOption">
                    <i class="fas fa-file-alt"></i>
                    <div class="export-option-text">
                        <div class="export-option-title">Abrir log de errores</div>
                        <div class="export-option-desc">Ver registro detallado de fallos y trazas</div>
                    </div>
                </div>
                <div class="export-option" id="showQuickMetricsOption">
                    <i class="fas fa-chart-bar"></i>
                    <div class="export-option-text">
                        <div class="export-option-title">Métricas rápidas</div>
                        <div class="export-option-desc">Resumen de progreso y actividad</div>
                    </div>
                </div>
                <div class="export-option" id="checkUpdatesOption">
                    <i class="fas fa-cloud-download-alt"></i>
                    <div class="export-option-text">
                        <div class="export-option-title">Buscar actualizaciones</div>
                        <div class="export-option-desc" id="updateStatusText">Estado: sin comprobar</div>
                        <div style="margin-top:6px; width:100%; height:8px; background:rgba(148,163,184,.22); border-radius:999px; overflow:hidden;">
                            <div id="updateProgressFill" style="height:100%; width:0%; background:linear-gradient(90deg,#3b82f6,#10b981);"></div>
                        </div>
                    </div>
                </div>
                <div class="export-option" id="restartUpdateOption" style="display:none;">
                    <i class="fas fa-redo"></i>
                    <div class="export-option-text">
                        <div class="export-option-title">Reiniciar y actualizar</div>
                        <div class="export-option-desc">Instalar actualización descargada</div>
                    </div>
                </div>
                <div style="display:flex;align-items:center;gap:8px;padding:8px 4px;">
                    <input id="perfDebugToggle" type="checkbox">
                    <label for="perfDebugToggle" style="color:var(--text-secondary);">Modo debug performance</label>
                </div>
            </div>
            <div class="modal-actions">
                <button id="closeUserOptionsModal" class="btn"><i class="fas fa-times"></i> Cerrar</button>
            </div>
        </div>
    </div>

    <div class="modal" id="profilesModal">
        <div class="modal-content profiles-art" style="max-width:640px;">
            <div class="modal-header"><i class="fas fa-layer-group"></i> Perfiles / Bases</div>
            <p style="color:var(--text-secondary); margin-bottom:8px;">Hasta 8 bases distintas. Cada perfil mantiene su propia vista de contactos.</p>
            <div style="display:flex; gap:8px; margin:10px 0;">
                <input id="newProfileName" class="origin-input" style="margin-top:0" placeholder="Nombre del perfil (ej: Base Casino Norte)">
                <button id="addProfileBtn" class="btn btn-success"><i class="fas fa-plus"></i> Crear</button>
            </div>
            <div id="profilesList" class="history-list" style="max-height:260px;"></div>
            <div style="display:flex;align-items:center;gap:8px;margin-top:10px;">
                <input type="checkbox" id="splitImportByFileToggle">
                <label for="splitImportByFileToggle" style="color:var(--text-secondary);">Crear/usar perfil por archivo al importar varios CSV</label>
            </div>
            <div class="modal-actions">
                <button id="closeProfilesModal" class="btn"><i class="fas fa-times"></i> Cerrar</button>
            </div>
        </div>
    </div>


    <div class="modal" id="metricsModal">
        <div class="modal-content" style="max-width: 760px;">
            <div class="modal-header"><i class="fas fa-chart-line"></i> Centro de métricas</div>
            <div id="metricsDateLabel" style="color:var(--text-secondary); margin-bottom:8px;">Resumen diario</div>
            <div class="metrics-dashboard-grid">
                <div class="metrics-card"><div class="k">Trabajados hoy</div><div id="metricEditedToday" class="v">0</div></div>
                <div class="metrics-card"><div class="k">Trabajados ayer</div><div id="metricEditedYesterday" class="v">0</div></div>
                <div class="metrics-card"><div class="k">Turno más activo</div><div id="metricTopShift" class="v">-</div></div>
                <div class="metrics-card"><div class="k">Revisado → Contactado</div><div id="metricRevToContact" class="v">0</div></div>
                <div class="metrics-card"><div class="k">Contactado → Jugando</div><div id="metricContactToJugando" class="v">0</div></div>
                <div class="metrics-card"><div class="k">Última subida / anterior</div><div id="metricLastBatchCount" class="v">0 / 0</div></div>
            </div>
            <div class="metrics-actions">
                <button id="metricsFilterLastBatchBtn" class="btn"><i class="fas fa-filter"></i> Filtrar última subida</button>
                <button id="metricsDeleteLastBatchBtn" class="btn btn-danger"><i class="fas fa-trash"></i> Borrar última subida</button>
            </div>
            <div class="modal-actions">
                <button id="closeMetricsModal" class="btn"><i class="fas fa-times"></i> Cerrar</button>
            </div>
        </div>
    </div>


    <div class="modal" id="whatsappMessageModal">
        <div class="modal-content" style="max-width: 640px;">
            <div class="modal-header"><i class="fab fa-whatsapp"></i> Mensaje de WhatsApp</div>
            <textarea id="whatsappTemplateInput" class="origin-input" style="min-height: 140px; margin-top: 0;" placeholder="Hola {usuario}, ..."></textarea>
            <div class="template-actions" style="margin-top: 12px;">
                <button id="insertUserTokenBtn" class="btn"><i class="fas fa-user"></i> Insertar usuario</button>
                <button id="resetTemplateBtn" class="btn"><i class="fas fa-undo"></i> Restablecer</button>
            </div>
            <p class="template-help" style="margin-top: 8px;">Usá <code>{usuario}</code> para completar el nombre automáticamente.</p>
            <div class="modal-actions">
                <button id="closeWhatsappMessageModal" class="btn"><i class="fas fa-times"></i> Cancelar</button>
                <button id="saveTemplateBtn" class="btn btn-success"><i class="fas fa-save"></i> Guardar mensaje</button>
            </div>
        </div>
    </div>

    <!-- Modal de agregar contacto único -->
    <div class="modal" id="addSingleModal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header"><i class="fas fa-user-plus"></i> Agregar Contacto</div>
            <div style="display: flex; flex-direction: column; gap: 15px; margin: 20px 0;">
                <input type="text" id="singleName" class="origin-input" placeholder="Nombre del contacto" style="margin-top: 0;">
                <input type="text" id="singlePhone" class="origin-input" placeholder="Teléfono (opcional)" style="margin-top: 0;">
                <input type="text" id="singleOrigin" class="origin-input" list="originSuggestions" placeholder="Origen (opcional)" style="margin-top: 0;">
                <datalist id="originSuggestions"></datalist>
                <select id="singleStatus" class="filter-select">
                    <option value="sin revisar">Sin Revisar</option>
                    <option value="contactado">Contactado</option>
                    <option value="revisado">Revisado</option>
                    <option value="jugando">Jugando</option>
                    <option value="sin wsp">Sin WhatsApp</option>
                    <option value="no interesado">No Interesado</option>
                </select>
            </div>
            <div class="modal-actions">
                <button id="cancelAddSingle" class="btn"><i class="fas fa-times"></i> Cancelar</button>
                <button id="confirmAddSingle" class="btn btn-success"><i class="fas fa-plus"></i> Agregar</button>
            </div>
        </div>
    </div>

    <div id="appLoadingOverlay" class="app-loading-overlay">
        <div style="font-size:1.1rem;font-weight:600;">Cargando…</div>
        <div id="appLoadingText" style="color:var(--text-secondary);">Inicializando</div>
        <div class="progress-bar"><div id="appLoadingProgress" class="progress-fill"></div></div>
        <button id="cancelImportBtn" class="btn" style="display:none;"><i class="fas fa-ban"></i> Cancelar importación</button>
    </div>

    <script>
    (() => {
        const hasBridge = !!(window.nexoStore && typeof window.nexoStore.getAll === 'function');
        if (!hasBridge) {
            window.__nexoStoreReady = Promise.resolve();
            return;
        }

        const emitStoreError = (message) => {
            window.dispatchEvent(new CustomEvent('nexo-store-error', { detail: message }));
            console.error(message);
        };

        const state = { map: {}, saveTimer: null };
        const KNOWN_KEYS = new Set(['contactsData', 'contactsHistory', 'whatsappTemplate', 'duplicateMergeMode', 'lastExportAt', 'backups', 'extraStorage']);

        const mapFromDb = (db) => {
            const nextMap = {};
            nextMap.contactsData = JSON.stringify(Array.isArray(db.contactsData) ? db.contactsData : []);
            nextMap.contactsHistory = JSON.stringify(Array.isArray(db.contactsHistory) ? db.contactsHistory : []);
            nextMap.whatsappTemplate = typeof db.whatsappTemplate === 'string' ? db.whatsappTemplate : 'Hola {usuario}, ¿cómo estás? Te escribo por la propuesta que vimos.';
            nextMap.duplicateMergeMode = typeof db.duplicateMergeMode === 'string' ? db.duplicateMergeMode : 'phone-auto';
            if (db.lastExportAt) nextMap.lastExportAt = String(db.lastExportAt);
            if (db.backups && typeof db.backups === 'object') {
                Object.entries(db.backups).forEach(([key, value]) => {
                    nextMap[`bk_${key}`] = JSON.stringify(value);
                });
            }
            if (db.extraStorage && typeof db.extraStorage === 'object') {
                Object.entries(db.extraStorage).forEach(([key, value]) => {
                    if (typeof value === 'string') nextMap[key] = value;
                });
            }
            return nextMap;
        };

        const parseJson = (raw, fallback) => {
            if (!raw) return fallback;
            try { return JSON.parse(raw); } catch (_) { return fallback; }
        };

        const dbFromMap = (map) => {
            const backups = {};
            const extraStorage = {};
            Object.entries(map).forEach(([key, value]) => {
                if (key.startsWith('bk_')) {
                    backups[key.slice(3)] = parseJson(value, []);
                } else if (!KNOWN_KEYS.has(key)) {
                    extraStorage[key] = String(value);
                }
            });
            return {
                contactsData: parseJson(map.contactsData, []),
                contactsHistory: parseJson(map.contactsHistory, []),
                whatsappTemplate: map.whatsappTemplate || 'Hola {usuario}, ¿cómo estás? Te escribo por la propuesta que vimos.',
                duplicateMergeMode: map.duplicateMergeMode || 'phone-auto',
                lastExportAt: map.lastExportAt || null,
                backups,
                extraStorage
            };
        };

        const flushToDisk = async () => {
            try {
                await window.nexoStore.setAll(dbFromMap(state.map));
            } catch (error) {
                emitStoreError(`No se pudo guardar en disco: ${error.message || error}`);
            }
        };

        const scheduleFlush = () => {
            clearTimeout(state.saveTimer);
            state.saveTimer = setTimeout(() => { flushToDisk(); }, 300);
        };

        const storageShim = {
            getItem(key) {
                const value = state.map[String(key)];
                return value === undefined ? null : value;
            },
            setItem(key, value) {
                state.map[String(key)] = String(value);
                scheduleFlush();
            },
            removeItem(key) {
                delete state.map[String(key)];
                scheduleFlush();
            },
            clear() {
                state.map = {};
                scheduleFlush();
            },
            key(index) {
                return Object.keys(state.map)[index] ?? null;
            },
            get length() {
                return Object.keys(state.map).length;
            }
        };

        const installShim = () => {
            try {
                Object.defineProperty(window, 'localStorage', { value: storageShim, configurable: true });
            } catch (_) {
                const proto = Object.getPrototypeOf(window.localStorage);
                proto.getItem = storageShim.getItem;
                proto.setItem = storageShim.setItem;
                proto.removeItem = storageShim.removeItem;
                proto.clear = storageShim.clear;
                proto.key = storageShim.key;
                Object.defineProperty(proto, 'length', { get: () => Object.keys(state.map).length });
            }
        };

        window.__nexoStoreReady = (async () => {
            try {
                const db = await window.nexoStore.getAll();
                state.map = mapFromDb(db || {});
                installShim();
            } catch (error) {
                emitStoreError(`No se pudo cargar la base local: ${error.message || error}`);
                installShim();
            }
        })();
    })();
    </script>

    <script>
    (() => {
        const $ = (sel) => document.querySelector(sel);
        const $$ = (sel) => document.querySelectorAll(sel);

        const STATUS_OPTIONS = [
            { id: 'sin revisar', label: 'Sin Revisar', icon: 'fa-question-circle', color: '#9ca3af', rgb: '156, 163, 175' },
            { id: 'contactado', label: 'Contactado', icon: 'fa-check-circle', color: '#10b981', rgb: '16, 185, 129' },
            { id: 'revisado', label: 'Revisado', icon: 'fa-user-check', color: '#34d399', rgb: '52, 211, 153' },
            { id: 'jugando', label: 'Jugando', icon: 'fa-gamepad', color: '#8b5cf6', rgb: '139, 92, 246' },
            { id: 'sin wsp', label: 'Sin WhatsApp', icon: 'fa-ban', color: '#f59e0b', rgb: '245, 158, 11' },
            { id: 'no interesado', label: 'No Interesado', icon: 'fa-times-circle', color: '#ef4444', rgb: '239, 68, 68' }
        ];

        const AppState = {
            contacts: [],
            filteredContacts: [],
            selectedContacts: new Set(),
            currentPage: 1,
            itemsPerPage: 20,
            searchTerm: '',
            statusFilter: '',
            originFilter: '',
            sortBy: 'name',
            sortOrder: 'asc',
            duplicates: [],
            history: [],
            lastEditedContact: null,
            undoStack: [],
            currentView: 'cards',
            whatsappTemplate: 'Hola {usuario}, ¿cómo estás? Te escribo por la propuesta que vimos.',
            duplicateMergeMode: 'phone-auto',
            opsProfiles: {},
            opsLastImportedAt: null,
            opsFilter: 'all',
            shiftFilter: '',
            phoneFilter: 'all',
            editActivityFilter: 'all',
            shiftMode: {
                tm: { name: 'TM', queue: [], cursor: 0, stack: [] },
                tt: { name: 'TT', queue: [], cursor: 0, stack: [] },
                tn: { name: 'TN', queue: [], cursor: 0, stack: [] }
            },
            activeShift: null,
            editingContactId: null,
            lastSelectedContactId: null,
            autoDownloadBackupIntervalMs: 30 * 60 * 1000,
            lastAutoDownloadAt: 0,
            lastAutoBackupSignature: '',
            autoBackupStorageMode: 'download',
            autoBackupFileHandle: null,
            storageEstimate: null,
            lastStorageWarnAt: 0,
            perfDebug: false,
            importCancelRequested: false,
            reviewPositiveCounter: 0,
            reviewMilestonesShown: {},
            runtimeHash: '',
            profiles: [{ id: 'default', name: 'Base principal' }],
            activeProfileId: 'default',
            splitImportByFile: false,
            operatorName: 'PC local',
            lastImportBatchId: '',
            previousImportBatchId: '',
            lastImportFileName: ''
        };

        function ensureReviewMilestonesState() {
            if (!AppState.reviewMilestonesShown || typeof AppState.reviewMilestonesShown !== 'object') {
                AppState.reviewMilestonesShown = {};
            }
            if (typeof AppState.reviewPositiveCounter !== 'number') {
                AppState.reviewPositiveCounter = Number(AppState.reviewPositiveCounter || 0) || 0;
            }
        }

        const elements = {
            uploadScreen: $('#uploadScreen'),
            mainApp: $('#mainApp'),
            fileInput: $('#fileInput'),
            opsFileInput: $('#opsFileInput'),
            uploadArea: $('#uploadArea'),
            fileList: $('#fileList'),
            originInput: $('#originInput'),
            startBtn: $('#startBtn'),
            preStartCheckUpdatesBtn: $('#preStartCheckUpdatesBtn'),
            profileSelect: $('#profileSelect'),
            manageProfilesBtn: $('#manageProfilesBtn'),
            cardsView: $('#cardsView'),
            listView: $('#listView'),
            shiftsView: $('#shiftsView'),
            quickReview: $('#quickReview'),
            searchInput: $('#searchInput'),
            statusFilter: $('#statusFilter'),
            originFilter: $('#originFilter'),
            opsSegmentFilter: $('#opsSegmentFilter'),
            shiftFilter: $('#shiftFilter'),
            phoneFilter: $('#phoneFilter'),
            editActivityFilter: $('#editActivityFilter'),
            clearFiltersBtn: $('#clearFiltersBtn'),
            selectFilteredBtn: $('#selectFilteredBtn'),
            clearSelectionBtn: $('#clearSelectionBtn'),
            viewCardsBtn: $('#viewCardsBtn'),
            viewListBtn: $('#viewListBtn'),
            viewShiftsBtn: $('#viewShiftsBtn'),
            exportBtn: $('#exportBtn'),
            bulkActionsBar: $('#bulkActionsBar'),
            selectedCount: $('#selectedCount'),
            bulkStatusSelect: $('#bulkStatusSelect'),
            pagination: $('#pagination'),
            manageDuplicatesBtn: $('#manageDuplicatesBtn'),
            duplicatesModal: $('#duplicatesModal'),
            duplicatesStatBox: $('#duplicatesStatBox'),
            addMoreBtn: $('#addMoreBtn'),
            addSingleBtn: $('#addSingleBtn'),
            checkUpdatesBtn: $('#checkUpdatesBtn'),
            settingsBtn: $('#settingsBtn'),
            historyBtn: $('#historyBtn'),
            historyModal: $('#historyModal'),
            contactHistoryModal: $('#contactHistoryModal'),
            contactHistoryList: $('#contactHistoryList'),
            contactHistoryMeta: $('#contactHistoryMeta'),
            deleteAllBtn: $('#deleteAllBtn'),
            importOpsBtn: $('#importOpsBtn'),
            undoBtn: $('#undoBtn'),
            whatsappTemplateInput: $('#whatsappTemplateInput'),
            saveTemplateBtn: $('#saveTemplateBtn'),
            checkUpdatesOption: $('#checkUpdatesOption'),
            restartUpdateOption: $('#restartUpdateOption'),
            openGithubReleasesOption: $('#openGithubReleasesOption'),
            openStable110Option: $('#openStable110Option'),
            openErrorLogOption: $('#openErrorLogOption'),
            rollbackPreviousOption: $('#rollbackPreviousOption'),
            showQuickMetricsOption: $('#showQuickMetricsOption'),
            metricsModal: $('#metricsModal'),
            metricEditedToday: $('#metricEditedToday'),
            metricEditedYesterday: $('#metricEditedYesterday'),
            metricTopShift: $('#metricTopShift'),
            metricRevToContact: $('#metricRevToContact'),
            metricContactToJugando: $('#metricContactToJugando'),
            metricLastBatchCount: $('#metricLastBatchCount'),
            metricsDateLabel: $('#metricsDateLabel'),
            metricsFilterLastBatchBtn: $('#metricsFilterLastBatchBtn'),
            metricsDeleteLastBatchBtn: $('#metricsDeleteLastBatchBtn'),
            profilesModal: $('#profilesModal'),
            profilesList: $('#profilesList'),
            newProfileName: $('#newProfileName'),
            addProfileBtn: $('#addProfileBtn'),
            closeProfilesModal: $('#closeProfilesModal'),
            splitImportByFileToggle: $('#splitImportByFileToggle'),
            updateStatusText: $('#updateStatusText'),
            updateProgressFill: $('#updateProgressFill'),
            perfDebugToggle: $('#perfDebugToggle'),
            appLoadingOverlay: $('#appLoadingOverlay'),
            appLoadingText: $('#appLoadingText'),
            appLoadingProgress: $('#appLoadingProgress'),
            cancelImportBtn: $('#cancelImportBtn'),
            insertUserTokenBtn: $('#insertUserTokenBtn'),
            resetTemplateBtn: $('#resetTemplateBtn'),
            shortcutsModal: $('#shortcutsModal'),
            userOptionsModal: $('#userOptionsModal'),
            whatsappMessageModal: $('#whatsappMessageModal'),
            saveStateBadge: $('#saveStateBadge'),
            storageMeter: $('#storageMeter'),
            globalAnnouncement: $('#globalAnnouncement'),
            loadingOverlay: $('#loadingOverlay'),
            loadingOverlayText: $('#loadingOverlayText'),
            loadingOverlayProgress: $('#loadingOverlayProgress'),
            loadingOverlayMeta: $('#loadingOverlayMeta')
        };

        // Compatibilidad defensiva: evita ReferenceError en handlers legacy cacheados por el navegador.
        let shift = '';
        let mode = '';

        let selectedFiles = [];

        function normalizePhoneNumber(phone) {
            if (!phone) return '';
            return phone.toString().replace(/\D/g, '');
        }

        function normalizeUsername(name) {
            if (!name) return '';
            return name.toString().toLowerCase().trim();
        }

        function normalizeName(name) {
            return normalizeUsername(name).replace(/\s+/g, ' ').trim();
        }

        function normalizeAlias(alias) {
            return normalizeUsername(alias).replace(/\s+/g, '');
        }

        function extractPrimaryAlias(name = '') {
            const base = (name || '').split('/')[0].trim();
            const token = base.split(/\s+/)[0] || base;
            return token.trim();
        }

        function parseCsvRow(line) {
            const out = [];
            let cur = '';
            let q = false;
            for (let i = 0; i < line.length; i++) {
                const ch = line[i];
                if (ch === '"') {
                    if (q && line[i + 1] === '"') { cur += '"'; i++; }
                    else q = !q;
                } else if (ch === ',' && !q) {
                    out.push(cur); cur = '';
                } else cur += ch;
            }
            out.push(cur);
            return out.map(v => v.trim());
        }

        function median(values) {
            if (!values.length) return 0;
            const sorted = [...values].sort((a, b) => a - b);
            const mid = Math.floor(sorted.length / 2);
            return sorted.length % 2 ? sorted[mid] : (sorted[mid - 1] + sorted[mid]) / 2;
        }

        function getOpsSuggestedStatus(lastCargaAt) {
            if (!lastCargaAt) return 'sin revisar';
            const days = (Date.now() - new Date(lastCargaAt).getTime()) / 86400000;
            if (days <= 2) return 'jugando';
            if (days <= 7) return 'contactado';
            if (days <= 21) return 'revisado';
            // Nota: datos de operaciones no implican disponibilidad de WhatsApp.
            // Evitamos sugerir 'sin wsp' solo por recencia.
            return 'sin revisar';
        }

        function suggestStatusByName(name) {
            try {
                const n = normalizeName(name || '');
                if (!n) return 'sin revisar';
                if (n.includes('vip') || n.includes('high roller')) return 'contactado';
                if (n.includes('activo') || n.includes('hot') || n.includes('reciente')) return 'jugando';
                if (n.includes('dormido') || n.includes('frio') || n.includes('cold')) return 'revisado';
                return 'sin revisar';
            } catch (error) {
                console.warn('[import] suggest fallback', error);
                return 'sin revisar';
            }
        }

        function getOpsHeatLabel(lastCargaAt) {
            if (!lastCargaAt) return { text: 'Sin datos', cls: 'cold' };
            const days = (Date.now() - new Date(lastCargaAt).getTime()) / 86400000;
            if (days <= 7) return { text: '🔥 Activo', cls: 'hot' };
            if (days <= 21) return { text: '⏳ Tibio', cls: '' };
            return { text: '❄️ Frío', cls: 'cold' };
        }

        function parseOperationsCsvChunkedFallback(text, onProgress) {
            return new Promise((resolve) => {
                const lines = text.split('\n').map(line => line.replace(/\r$/, '')).filter(Boolean);
                if (!lines.length) return resolve({ byAlias: {}, importedRows: 0 });

                let idx = 0;
                if (lines[0].toLowerCase().startsWith('sep=')) idx = 1;
                const header = parseCsvRow(lines[idx] || '');
                idx++;
                const h = header.map(v => normalizeUsername(v));
                const aliasIdx = h.findIndex(v => v.includes('alias'));
                const amountIdx = h.findIndex(v => v.includes('cantidad'));
                const dateIdx = h.findIndex(v => v.includes('fecha'));
                const stats = new Map();
                const now = Date.now();
                const chunk = 700;
                const totalRows = Math.max(0, lines.length - idx);
                const startIdx = idx;
                let importedRows = 0;

                const process = () => {
                    const end = Math.min(lines.length, idx + chunk);
                    for (; idx < end; idx++) {
                        const row = parseCsvRow(lines[idx]);
                        const aliasRaw = row[aliasIdx] || '';
                        const alias = normalizeAlias(aliasRaw);
                        if (!alias) continue;
                        const amount = parseInt((row[amountIdx] || '0').replace(/[^\d-]/g, ''), 10);
                        if (Number.isNaN(amount)) continue;
                        const dateRaw = row[dateIdx] || '';
                        const ts = Date.parse(dateRaw.replace(' ', 'T')) || Date.now();
                        const hour = new Date(ts).getHours();

                        if (!stats.has(alias)) {
                            stats.set(alias, {
                                alias,
                                aliasLabel: aliasRaw.trim(),
                                cargasCount: 0,
                                descargasCount: 0,
                                cargadoTotal: 0,
                                descargadoTotal: 0,
                                netoTotal: 0,
                                lastAt: null,
                                lastCargaAt: null,
                                cargasVals: [],
                                hourHist: Array(24).fill(0),
                                cargas30d: 0,
                                cargado30d: 0,
                                cargado90d: 0,
                                weeks30: new Set(),
                                months90: new Set()
                            });
                        }
                        const st = stats.get(alias);
                        importedRows++;
                        st.netoTotal += amount;
                        st.hourHist[hour] += 1;
                        if (!st.lastAt || ts > st.lastAt) st.lastAt = ts;

                        const ageDays = (now - ts) / 86400000;
                        if (amount > 0) {
                            st.cargasCount++;
                            st.cargadoTotal += amount;
                            st.cargasVals.push(amount);
                            if (!st.lastCargaAt || ts > st.lastCargaAt) st.lastCargaAt = ts;
                            if (ageDays <= 30) {
                                st.cargas30d++;
                                st.cargado30d += amount;
                                const d = new Date(ts);
                                const wk = `${d.getFullYear()}-${Math.ceil((((d - new Date(d.getFullYear(),0,1)) / 86400000) + d.getDay() + 1) / 7)}`;
                                st.weeks30.add(wk);
                            }
                            if (ageDays <= 90) {
                                st.cargado90d += amount;
                                const d = new Date(ts);
                                st.months90.add(`${d.getFullYear()}-${d.getMonth()+1}`);
                            }
                        } else {
                            st.descargasCount++;
                            st.descargadoTotal += Math.abs(amount);
                        }
                    }

                    if (typeof onProgress === 'function') {
                        onProgress({ processed: Math.max(0, idx - startIdx), total: totalRows });
                    }

                    if (idx < lines.length) return setTimeout(process, 0);

                    const byAlias = {};
                    for (const [alias, st] of stats.entries()) {
                        const topHours = st.hourHist.map((v, i) => ({ h: i, v })).sort((a, b) => b.v - a.v).slice(0, 3).map(x => `${String(x.h).padStart(2, '0')}:00`);
                        const avgCarga = st.cargasCount ? (st.cargadoTotal / st.cargasCount) : 0;
                        const mediana = median(st.cargasVals);
                        const loyalty = (st.weeks30.size >= 2 ? 1 : 0) + (st.months90.size >= 2 ? 1 : 0) + (st.cargado30d >= 50000 ? 1 : 0) + (st.cargas30d >= 8 ? 1 : 0);
                        const recencyDays = st.lastCargaAt ? (Date.now() - st.lastCargaAt) / 86400000 : 999;
                        const recencyScore = Math.max(0, 40 - recencyDays);
                        const score = recencyScore + Math.min(35, st.cargas30d * 3) + Math.min(20, st.cargado90d / 10000) + (loyalty * 8);
                        byAlias[alias] = {
                            ...st,
                            lastAt: st.lastAt ? new Date(st.lastAt).toISOString() : null,
                            lastCargaAt: st.lastCargaAt ? new Date(st.lastCargaAt).toISOString() : null,
                            avgCarga: Math.round(avgCarga),
                            medianCarga: Math.round(mediana),
                            topHours,
                            loyalty,
                            score: Math.round(score),
                            suggestedStatus: getOpsSuggestedStatus(st.lastCargaAt),
                            heat: getOpsHeatLabel(st.lastCargaAt)
                        };
                        delete byAlias[alias].cargasVals;
                        delete byAlias[alias].weeks30;
                        delete byAlias[alias].months90;
                    }
                    resolve({ byAlias, importedRows });
                };
                process();
            });
        }

        function parseOperationsCsvChunked(text, onProgress) {
            if (typeof Worker === 'undefined') {
                return parseOperationsCsvChunkedFallback(text, onProgress);
            }
            return new Promise((resolve, reject) => {
                const workerScript = `
                    const normalizeUsername = (value = '') => (value || '').toString().trim().toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
                    const normalizeAlias = (value = '') => normalizeUsername(value).replace(/\s+/g, '');
                    const parseCsvRow = (line = '') => {
                        const out = [];
                        let cur = '';
                        let inQuotes = false;
                        for (let i = 0; i < line.length; i++) {
                            const ch = line[i];
                            if (ch === '"') {
                                if (inQuotes && line[i + 1] === '"') { cur += '"'; i++; }
                                else inQuotes = !inQuotes;
                            } else if (ch === ',' && !inQuotes) {
                                out.push(cur);
                                cur = '';
                            } else cur += ch;
                        }
                        out.push(cur);
                        return out.map(v => v.trim());
                    };
                    const median = (values) => {
                        if (!values.length) return 0;
                        const sorted = [...values].sort((a, b) => a - b);
                        const mid = Math.floor(sorted.length / 2);
                        return sorted.length % 2 ? sorted[mid] : (sorted[mid - 1] + sorted[mid]) / 2;
                    };
                    const getOpsSuggestedStatus = (lastCargaAt) => {
                        if (!lastCargaAt) return 'sin revisar';
                        const days = (Date.now() - new Date(lastCargaAt).getTime()) / 86400000;
                        if (days <= 2) return 'jugando';
                        if (days <= 7) return 'contactado';
                        if (days <= 21) return 'revisado';
                        return 'sin revisar';
                    };
                    const getOpsHeatLabel = (lastCargaAt) => {
                        if (!lastCargaAt) return { text: 'Sin datos', cls: 'cold' };
                        const days = (Date.now() - new Date(lastCargaAt).getTime()) / 86400000;
                        if (days <= 7) return { text: '🔥 Activo', cls: 'hot' };
                        if (days <= 21) return { text: '⏳ Tibio', cls: '' };
                        return { text: '❄️ Frío', cls: 'cold' };
                    };

                    self.onmessage = (event) => {
                        try {
                            const text = String(event.data && event.data.text || '');
                            const lines = text.split(/\r?\n/).filter(Boolean);
                            if (!lines.length) {
                                self.postMessage({ type: 'done', payload: { byAlias: {}, importedRows: 0 } });
                                return;
                            }

                            let idx = 0;
                            if ((lines[0] || '').toLowerCase().startsWith('sep=')) idx = 1;
                            const header = parseCsvRow(lines[idx] || '');
                            idx++;
                            const h = header.map(v => normalizeUsername(v));
                            const aliasIdx = h.findIndex(v => v.includes('alias'));
                            const amountIdx = h.findIndex(v => v.includes('cantidad'));
                            const dateIdx = h.findIndex(v => v.includes('fecha'));
                            const stats = new Map();
                            const now = Date.now();
                            const chunk = 1200;
                            const totalRows = Math.max(0, lines.length - idx);
                            let importedRows = 0;

                            while (idx < lines.length) {
                                const end = Math.min(lines.length, idx + chunk);
                                for (; idx < end; idx++) {
                                    const row = parseCsvRow(lines[idx]);
                                    const aliasRaw = row[aliasIdx] || '';
                                    const alias = normalizeAlias(aliasRaw);
                                    if (!alias) continue;
                                    const amount = parseInt((row[amountIdx] || '0').replace(/[^\d-]/g, ''), 10);
                                    if (Number.isNaN(amount)) continue;
                                    const dateRaw = row[dateIdx] || '';
                                    const ts = Date.parse(dateRaw.replace(' ', 'T')) || Date.now();
                                    const hour = new Date(ts).getHours();

                                    if (!stats.has(alias)) {
                                        stats.set(alias, {
                                            alias,
                                            aliasLabel: aliasRaw.trim(),
                                            cargasCount: 0,
                                            descargasCount: 0,
                                            cargadoTotal: 0,
                                            descargadoTotal: 0,
                                            netoTotal: 0,
                                            lastAt: null,
                                            lastCargaAt: null,
                                            cargasVals: [],
                                            hourHist: Array(24).fill(0),
                                            cargas30d: 0,
                                            cargado30d: 0,
                                            cargado90d: 0,
                                            weeks30: new Set(),
                                            months90: new Set()
                                        });
                                    }

                                    const st = stats.get(alias);
                                    importedRows++;
                                    st.netoTotal += amount;
                                    st.hourHist[hour] += 1;
                                    if (!st.lastAt || ts > st.lastAt) st.lastAt = ts;

                                    const ageDays = (now - ts) / 86400000;
                                    if (amount > 0) {
                                        st.cargasCount++;
                                        st.cargadoTotal += amount;
                                        st.cargasVals.push(amount);
                                        if (!st.lastCargaAt || ts > st.lastCargaAt) st.lastCargaAt = ts;
                                        if (ageDays <= 30) {
                                            st.cargas30d++;
                                            st.cargado30d += amount;
                                            const d = new Date(ts);
                                            const wk = String(d.getFullYear()) + '-' + String(Math.ceil((((d - new Date(d.getFullYear(), 0, 1)) / 86400000) + d.getDay() + 1) / 7));
                                            st.weeks30.add(wk);
                                        }
                                        if (ageDays <= 90) {
                                            st.cargado90d += amount;
                                            const d = new Date(ts);
                                            st.months90.add(String(d.getFullYear()) + '-' + String(d.getMonth() + 1));
                                        }
                                    } else {
                                        st.descargasCount++;
                                        st.descargadoTotal += Math.abs(amount);
                                    }
                                }

                                self.postMessage({ type: 'progress', payload: { processed: Math.max(0, idx - (lines[0].toLowerCase().startsWith('sep=') ? 2 : 1)), total: totalRows } });
                            }

                            const byAlias = {};
                            for (const [alias, st] of stats.entries()) {
                                const topHours = st.hourHist
                                    .map((v, i) => ({ h: i, v }))
                                    .sort((a, b) => b.v - a.v)
                                    .slice(0, 3)
                                    .map(x => String(x.h).padStart(2, '0') + ':00');
                                const avgCarga = st.cargasCount ? (st.cargadoTotal / st.cargasCount) : 0;
                                const mediana = median(st.cargasVals);
                                const loyalty = (st.weeks30.size >= 2 ? 1 : 0) + (st.months90.size >= 2 ? 1 : 0) + (st.cargado30d >= 50000 ? 1 : 0) + (st.cargas30d >= 8 ? 1 : 0);
                                const recencyDays = st.lastCargaAt ? (Date.now() - st.lastCargaAt) / 86400000 : 999;
                                const recencyScore = Math.max(0, 40 - recencyDays);
                                const score = recencyScore + Math.min(35, st.cargas30d * 3) + Math.min(20, st.cargado90d / 10000) + (loyalty * 8);
                                byAlias[alias] = {
                                    ...st,
                                    lastAt: st.lastAt ? new Date(st.lastAt).toISOString() : null,
                                    lastCargaAt: st.lastCargaAt ? new Date(st.lastCargaAt).toISOString() : null,
                                    avgCarga: Math.round(avgCarga),
                                    medianCarga: Math.round(mediana),
                                    topHours,
                                    loyalty,
                                    score: Math.round(score),
                                    suggestedStatus: getOpsSuggestedStatus(st.lastCargaAt),
                                    heat: getOpsHeatLabel(st.lastCargaAt)
                                };
                                delete byAlias[alias].cargasVals;
                                delete byAlias[alias].weeks30;
                                delete byAlias[alias].months90;
                            }

                            self.postMessage({ type: 'done', payload: { byAlias, importedRows } });
                        } catch (err) {
                            self.postMessage({ type: 'error', payload: String((err && err.message) || err || 'Error procesando CSV de operaciones') });
                        }
                    };
                `;

                const blob = new Blob([workerScript], { type: 'application/javascript' });
                const workerUrl = URL.createObjectURL(blob);
                const worker = new Worker(workerUrl);
                let settled = false;

                worker.onmessage = (event) => {
                    const { type, payload } = event.data || {};
                    if (type === 'progress' && typeof onProgress === 'function') {
                        onProgress(payload || {});
                        return;
                    }
                    if (type === 'done') {
                        if (settled) return;
                        settled = true;
                        worker.terminate();
                        URL.revokeObjectURL(workerUrl);
                        resolve(payload || { byAlias: {}, importedRows: 0 });
                        return;
                    }
                    if (type === 'error') {
                        if (settled) return;
                        settled = true;
                        worker.terminate();
                        URL.revokeObjectURL(workerUrl);
                        parseOperationsCsvChunkedFallback(text, onProgress).then(resolve).catch(reject);
                    }
                };

                worker.onerror = () => {
                    if (settled) return;
                    settled = true;
                    worker.terminate();
                    URL.revokeObjectURL(workerUrl);
                    parseOperationsCsvChunkedFallback(text, onProgress).then(resolve).catch(reject);
                };

                worker.postMessage({ text: String(text || '') });
            });
        }

        function applyOpsHeuristicsToContact(contact) {
            if (!contact || !contact.ops?.suggestedStatus) return;
            const suggested = contact.ops.suggestedStatus;
            const nextStatus = getHigherPriorityStatus(contact.status, suggested);
            if (nextStatus !== contact.status) {
                contact.status = nextStatus;
                touchContactEdit(contact, 'ops_sync');
            }
        }

        function syncOpsToContacts({ createNewUsers = true } = {}) {
            const profiles = AppState.opsProfiles || {};
            const matchedAliases = new Set();
            let updatedCount = 0;
            let createdCount = 0;

            AppState.contacts.forEach(contact => {
                const prevStatus = contact.status;
                const prevAlias = contact.alias || '';
                const keys = [normalizeAlias(contact.alias || ''), normalizeAlias(extractPrimaryAlias(contact.name || '')), normalizeAlias(contact.name || '')].filter(Boolean);
                const foundKey = keys.find(k => profiles[k]);
                contact.ops = foundKey ? profiles[foundKey] : null;
                if (foundKey) {
                    contact.alias = contact.alias || extractPrimaryAlias(contact.name || '') || profiles[foundKey].aliasLabel;
                    matchedAliases.add(foundKey);
                    applyOpsHeuristicsToContact(contact);
                }
                if (contact.status !== prevStatus || (contact.alias || '') !== prevAlias) updatedCount++;
            });

            if (createNewUsers) {
                Object.keys(profiles).forEach(alias => {
                    if (matchedAliases.has(alias)) return;
                    const p = profiles[alias];
                    const newId = Date.now() + Math.random();
                    AppState.contacts.push({
                        id: newId,
                        name: p.aliasLabel || alias,
                        alias: p.aliasLabel || alias,
                        phone: '',
                        origin: 'Operaciones panel',
                        status: 'sin revisar',
                        lastUpdated: new Date().toISOString(),
                        lastEditedAt: new Date().toISOString(),
                        lastEditReason: 'ops_create',
                        recontactAttempts: 0,
                        isDuplicate: false,
                        isNewFromOps: true,
                        ops: p
                    });
                    applyOpsHeuristicsToContact(AppState.contacts[AppState.contacts.length - 1]);
                    addToHistory('Nuevo usuario desde operaciones', p.aliasLabel || alias);
                    createdCount++;
                });
            }
            return { updatedCount, createdCount };
        }

        function mergeOpsProfiles(newProfiles) {
            const merged = { ...(AppState.opsProfiles || {}) };
            Object.entries(newProfiles || {}).forEach(([alias, n]) => {
                const prev = merged[alias];
                if (!prev) { merged[alias] = n; return; }
                merged[alias] = {
                    ...n,
                    cargasCount: (prev.cargasCount || 0) + (n.cargasCount || 0),
                    descargasCount: (prev.descargasCount || 0) + (n.descargasCount || 0),
                    cargadoTotal: (prev.cargadoTotal || 0) + (n.cargadoTotal || 0),
                    descargadoTotal: (prev.descargadoTotal || 0) + (n.descargadoTotal || 0),
                    netoTotal: (prev.netoTotal || 0) + (n.netoTotal || 0),
                    cargas30d: Math.max(prev.cargas30d || 0, n.cargas30d || 0),
                    cargado30d: Math.max(prev.cargado30d || 0, n.cargado30d || 0),
                    cargado90d: Math.max(prev.cargado90d || 0, n.cargado90d || 0),
                    lastAt: (!prev.lastAt || (n.lastAt && n.lastAt > prev.lastAt)) ? n.lastAt : prev.lastAt,
                    lastCargaAt: (!prev.lastCargaAt || (n.lastCargaAt && n.lastCargaAt > prev.lastCargaAt)) ? n.lastCargaAt : prev.lastCargaAt,
                    avgCarga: Math.round(((prev.avgCarga || 0) + (n.avgCarga || 0)) / 2),
                    medianCarga: Math.round(((prev.medianCarga || 0) + (n.medianCarga || 0)) / 2),
                    loyalty: Math.max(prev.loyalty || 0, n.loyalty || 0),
                    score: Math.max(prev.score || 0, n.score || 0),
                    suggestedStatus: n.suggestedStatus || prev.suggestedStatus,
                    heat: n.heat || prev.heat,
                    topHours: n.topHours?.length ? n.topHours : (prev.topHours || [])
                };
            });
            AppState.opsProfiles = merged;
            AppState.opsLastImportedAt = new Date().toISOString();
            saveOpsData();
        }

        function saveOpsData() {
            try {
                localStorage.setItem('opsProfilesData', JSON.stringify(AppState.opsProfiles || {}));
                localStorage.setItem('opsLastImportedAt', AppState.opsLastImportedAt || '');
            } catch (e) {
                console.error('Error guardando operaciones:', e);
            }
        }

        function loadOpsData() {
            try {
                AppState.opsProfiles = JSON.parse(localStorage.getItem('opsProfilesData') || '{}');
                AppState.opsLastImportedAt = localStorage.getItem('opsLastImportedAt') || null;
            } catch (e) {
                AppState.opsProfiles = {};
                AppState.opsLastImportedAt = null;
            }
        }

        function updateOpsUploadReminder() {
            if (!elements.importOpsBtn) return;
            elements.importOpsBtn.classList.remove('needs-upload');
            if (!AppState.opsLastImportedAt) {
                elements.importOpsBtn.classList.add('needs-upload');
                elements.importOpsBtn.title = 'Importá operaciones (sin importación previa)';
                return;
            }
            const hours = (Date.now() - new Date(AppState.opsLastImportedAt).getTime()) / 36e5;
            if (hours >= 48) elements.importOpsBtn.classList.add('needs-upload');
            elements.importOpsBtn.title = `Última importación: ${new Date(AppState.opsLastImportedAt).toLocaleString('es-ES')}`;
        }

        function getOpsMiniHtml(contact) {
            if (!contact.ops) return '';
            const o = contact.ops;
            const heat = o.heat || getOpsHeatLabel(o.lastCargaAt);
            const last = o.lastCargaAt ? new Date(o.lastCargaAt).toLocaleString('es-ES') : '-';
            const topHours = (o.topHours || []).join(' / ') || '-';
            return `
                <div class="ops-chip-row">
                    <span class="ops-chip ${heat.cls}">${heat.text}</span>
                    <span class="ops-chip">↑${o.cargasCount || 0} ↓${o.descargasCount || 0}</span>
                    <span class="ops-chip">Σ $${Math.round(o.netoTotal || 0)}</span>
                    <span class="ops-chip">Score ${o.score || 0}</span>
                    <div class="ops-info-wrap">
                        <button class="ops-info-btn" type="button" onclick="event.stopPropagation()">ℹ️</button>
                        <div class="ops-tooltip" onclick="event.stopPropagation()">
                            <div class="line"><span>Última actividad</span><strong>${last}</strong></div>
                            <div class="line"><span>Promedio / Mediana</span><strong>$${Math.round(o.avgCarga || 0)} / $${Math.round(o.medianCarga || 0)}</strong></div>
                            <div class="line"><span>Cargado 30d / 90d</span><strong>$${Math.round(o.cargado30d || 0)} / $${Math.round(o.cargado90d || 0)}</strong></div>
                            <div class="line"><span>Horas top</span><strong>${topHours}</strong></div>
                            <div class="line"><span>Lealtad</span><strong>${o.loyalty || 0}/4</strong></div>
                            <div style="display:flex; gap:6px; margin-top:8px;">
                                <button class="btn" style="padding:4px 8px;font-size:.72rem;" onclick="applyOpsSuggestion(${contact.id}, event)">Aplicar ${o.suggestedStatus || 'sin revisar'}</button>
                                <button class="btn" style="padding:4px 8px;font-size:.72rem;" onclick="pinContact(${contact.id}, event)">${contact.pinned ? 'Desfijar' : 'Pin'}</button>
                            </div>
                        </div>
                    </div>
                </div>`;
        }

        function addContactTimeline(contactId, action, details) {
            const contact = AppState.contacts.find(c => c.id === contactId);
            if (!contact) return;
            if (!Array.isArray(contact.timeline)) contact.timeline = [];
            contact.timeline.unshift({
                timestamp: new Date().toISOString(),
                action,
                details
            });
            if (contact.timeline.length > 500) contact.timeline = contact.timeline.slice(0, 500);
        }

        function addToHistory(action, details, contactId = null) {
            const historyEntry = {
                timestamp: new Date().toISOString(),
                action: action,
                details: details,
                contactId: contactId || null,
                actor: AppState.operatorName || 'PC local'
            };
            AppState.history.unshift(historyEntry);
            if (AppState.history.length > 500) {
                AppState.history = AppState.history.slice(0, 500);
            }
            if (contactId) addContactTimeline(contactId, action, details);
            saveHistory();
        }

        function saveHistory() {
            try {
                localStorage.setItem('contactsHistory', JSON.stringify(AppState.history));
            } catch (e) {
                reportError('saveHistory', e);
            }
        }

        function loadHistory() {
            try {
                const saved = localStorage.getItem('contactsHistory');
                if (saved) {
                    AppState.history = JSON.parse(saved);
                }
            } catch (e) {
                reportError('loadHistory', e);
            }
        }

        function mergeContact(existing, newContact) {
            const merged = { ...existing };
            
            merged.name = existing.name || newContact.name;
            
            if (newContact.phone && !existing.phone) {
                merged.phone = newContact.phone;
            } else if (existing.phone) {
                merged.phone = existing.phone;
            }
            
            if (newContact.origin && !existing.origin) {
                merged.origin = newContact.origin;
            } else if (existing.origin) {
                merged.origin = existing.origin;
            }
            
            const statusPriority = {
                'jugando': 5,
                'contactado': 4,
                'revisado': 3.5,
                'sin wsp': 3,
                'sin revisar': 2,
                'no interesado': 1
            };
            
            const existingPriority = statusPriority[existing.status] || 0;
            const newPriority = statusPriority[newContact.status] || 0;
            
            if (newPriority > existingPriority) {
                merged.status = newContact.status;
                merged.lastUpdated = new Date().toISOString();
            } else {
                merged.status = existing.status;
            }
            
            return merged;
        }

        function detectDuplicates() {
            const nameMap = new Map();
            const phoneMap = new Map();
            const duplicateGroups = [];
            const duplicateIds = new Set();

            // Agrupar por nombre normalizado
            AppState.contacts.forEach(contact => {
                const normalizedName = normalizeUsername(contact.name);
                if (!nameMap.has(normalizedName)) {
                    nameMap.set(normalizedName, []);
                }
                nameMap.get(normalizedName).push(contact);
            });

            // Agrupar por teléfono
            AppState.contacts.forEach(contact => {
                if (contact.phone) {
                    const normalizedPhone = normalizePhoneNumber(contact.phone);
                    if (!phoneMap.has(normalizedPhone)) {
                        phoneMap.set(normalizedPhone, []);
                    }
                    phoneMap.get(normalizedPhone).push(contact);
                }
            });

            // Detectar duplicados por nombre
            nameMap.forEach((contacts, name) => {
                if (contacts.length > 1) {
                    duplicateGroups.push({
                        type: 'nombre',
                        name: contacts[0].name,
                        contacts: contacts
                    });
                    contacts.forEach(c => duplicateIds.add(c.id));
                }
            });

            // Detectar duplicados por teléfono
            phoneMap.forEach((contacts, phone) => {
                if (contacts.length > 1) {
                    const uniqueNames = new Set(contacts.map(c => normalizeUsername(c.name)));
                    if (uniqueNames.size > 1) {
                        duplicateGroups.push({
                            type: 'teléfono',
                            name: `Teléfono: ${contacts[0].phone}`,
                            contacts: contacts
                        });
                        contacts.forEach(c => duplicateIds.add(c.id));
                    }
                }
            });

            AppState.duplicates = duplicateGroups;
            
            // Marcar contactos duplicados
            AppState.contacts.forEach(contact => {
                contact.isDuplicate = duplicateIds.has(contact.id);
            });

            return duplicateGroups;
        }

        function parseCSV(text) {
            // Detectar si es VCF
            if (text.trim().startsWith('BEGIN:VCARD')) {
                return parseVCF(text);
            }

            const normalizeHeader = (header) => (header || '')
                .toLowerCase()
                .normalize('NFD')
                .replace(/[\u0300-\u036f]/g, '')
                .trim();

            const parseCSVRow = (line, delimiter) => {
                const row = [];
                let current = '';
                let inQuotes = false;

                for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    const nextChar = line[i + 1];

                    if (char === '"') {
                        if (inQuotes && nextChar === '"') {
                            current += '"';
                            i++;
                        } else {
                            inQuotes = !inQuotes;
                        }
                    } else if (char === delimiter && !inQuotes) {
                        row.push(current.trim());
                        current = '';
                    } else {
                        current += char;
                    }
                }

                row.push(current.trim());
                return row.map(v => v.replace(/^"|"$/g, '').trim());
            };

            const detectDelimiter = (headerLine) => {
                const candidates = [',', ';', '\t', '|'];
                let best = ',';
                let bestScore = -1;

                candidates.forEach((candidate) => {
                    const score = parseCSVRow(headerLine, candidate).length;
                    if (score > bestScore) {
                        best = candidate;
                        bestScore = score;
                    }
                });

                return best;
            };

            const lines = text.replace(/\r/g, '').split('\n').filter(line => line.trim());
            if (lines.length === 0) return [];

            const delimiter = detectDelimiter(lines[0]);
            const headers = parseCSVRow(lines[0], delimiter).map(normalizeHeader);
            const contacts = [];

            const isNameHeader = (header) => {
                return [
                    'name', 'nombre', 'usuario', 'fullname', 'full name', 'displayname', 'display name', 'contacto', 'contact'
                ].includes(header) || header.includes('nombre') || header.includes('usuario') || header.includes('name');
            };

            const isPhoneHeader = (header) => {
                return [
                    'number', 'phone', 'telefono', 'tel', 'cel', 'celular', 'mobile', 'movil', 'whatsapp', 'msisdn'
                ].includes(header)
                    || header.includes('telefono')
                    || header.includes('numero')
                    || header.includes('phone')
                    || header.includes('mobile')
                    || header.includes('whatsapp');
            };

            const mapStatus = (value) => {
                const lowerValue = (value || '').toLowerCase();
                if (lowerValue.includes('promo enviada') || lowerValue.includes('contactado')) return 'contactado';
                if (lowerValue.includes('no esta en wsp') || lowerValue.includes('sin wsp')) return 'sin wsp';
                if (lowerValue.includes('en contacto') || lowerValue.includes('jugando')) return 'jugando';
                if (lowerValue.includes('eliminado') || lowerValue.includes('no interesado')) return 'no interesado';
                if (lowerValue.includes('revisado') || lowerValue.includes('verificado')) return 'revisado';
                if (lowerValue.includes('a contactar') || lowerValue.includes('sin revisar')) return 'sin revisar';
                return undefined;
            };

            for (let i = 1; i < lines.length; i++) {
                const values = parseCSVRow(lines[i], delimiter);
                const contact = {};

                headers.forEach((header, index) => {
                    const value = values[index] || '';
                    if (!value) return;

                    if (isNameHeader(header)) {
                        contact.name = value;
                    } else if (isPhoneHeader(header)) {
                        contact.phone = normalizePhoneNumber(value);
                    } else if (header.includes('estado') && !header.includes('revision')) {
                        const status = mapStatus(value);
                        if (status) contact.status = status;
                    }
                });

                // Fallback: si el CSV no tiene headers claros, tomar la primera celda numérica como teléfono.
                if (!contact.phone) {
                    const probablePhone = values.find(v => /\d{6,}/.test((v || '').replace(/\D/g, '')));
                    if (probablePhone) contact.phone = normalizePhoneNumber(probablePhone);
                }

                if (!contact.name && contact.phone) {
                    contact.name = contact.phone;
                }

                if (contact.name || contact.phone) {
                    contacts.push(contact);
                }
            }

            return contacts;
        }

        function parseBackupJson(text) {
            let parsed;
            try {
                parsed = JSON.parse(text);
            } catch (e) {
                throw new Error('JSON inválido');
            }
            const list = Array.isArray(parsed) ? parsed : (Array.isArray(parsed?.contacts) ? parsed.contacts : null);
            if (!list) throw new Error('El JSON no contiene una lista de contactos válida');
            return list
                .map(c => ({
                    name: (c?.name || '').toString().trim(),
                    phone: normalizePhoneNumber(c?.phone || ''),
                    status: c?.status || 'sin revisar',
                    origin: (c?.origin || 'Backup JSON').toString().trim()
                }))
                .filter(c => c.name);
        }

        function parseContactsByFile(fileName, text) {
            const lower = (fileName || '').toLowerCase();
            if (lower.endsWith('.json')) return parseBackupJson(text);
            return parseCSV(text);
        }

        async function persistContactsChunkedForImport(contacts) {
            if (!(window.nexoStore && typeof window.nexoStore.importContactsChunk === 'function')) return false;
            const chunkSize = 400;
            const total = contacts.length;
            const started = Date.now();
            console.info('[import] store chunked start', { total, chunkSize });
            for (let i = 0; i < total; i += chunkSize) {
                const chunk = contacts.slice(i, i + chunkSize);
                await window.nexoStore.importContactsChunk({ chunk, reset: i === 0 });
                const done = Math.min(total, i + chunk.length);
                const pct = total ? Math.min(99, 60 + Math.round((done / total) * 39)) : 99;
                setLoadingState(true, `Guardando… ${done}/${total}`, pct, true);
                await new Promise((r) => setTimeout(r, 0));
            }
            console.info('[import] store chunked done', { ms: Date.now() - started, total });
            return true;
        }

        async function loadFiles() {
            const origin = elements.originInput.value.trim() || 'Sin especificar';
            let totalNewContacts = 0;
            let totalMerged = 0;
            let totalRenamedCleanup = 0;
            const batchId = `imp_${Date.now()}`;
            const batchFiles = [];

            if (selectedFiles.length === 0) return;
            AppState.importCancelRequested = false;
            const importStarted = Date.now();
            setLoadingState(true, 'Leyendo archivo…', 2, true);

            try {
            const snapshotStamp = new Date().toISOString().replace(/[:.]/g, '-');
            const activeProfileBefore = AppState.activeProfileId || 'default';
            const profileContactsBefore = AppState.contacts.filter(c => (c.profileId || 'default') === activeProfileBefore);
            localStorage.setItem(`bk_profile_${activeProfileBefore}_${snapshotStamp}`, JSON.stringify(profileContactsBefore));

            for (let fileIndex = 0; fileIndex < selectedFiles.length; fileIndex++) {
                const file = selectedFiles[fileIndex];
                batchFiles.push(file.name);
                const text = await file.text();
                const profileIdForFile = AppState.splitImportByFile && selectedFiles.length > 1 ? ensureProfileByName((file.name || '').replace(/\.[^.]+$/, '')) : (AppState.activeProfileId || 'default');
                const linesPreview = String(text || '').split(/\r?\n/).slice(0, 11);
                if (linesPreview.length > 1) {
                    const previewCols = parseCsvRow(linesPreview[0] || '');
                    const previewRows = linesPreview.slice(1).filter(Boolean).slice(0, 3).join('\n');
                    const okPreview = confirm(`Vista previa de importación\nArchivo: ${file.name}\nPerfil destino: ${(AppState.profiles.find(p => p.id === profileIdForFile)?.name || 'Base principal')}\nColumnas detectadas: ${previewCols.join(' | ')}\n\nEjemplo:\n${previewRows}\n\n¿Continuar?`);
                    if (!okPreview) continue;
                }
                if (AppState.importCancelRequested) break;

                setLoadingState(true, `Parseando… ${file.name}`, 10, true);
                const parsedContacts = await perfMark('import parse', () => parseContactsInWorker(file.name, String(text || ''), ({ processed = 0, total = 0 }) => {
                    const pct = total > 0 ? Math.round((processed / total) * 45) : 0;
                    setLoadingState(true, `Parseando… ${processed}/${total}`, 10 + pct, true);
                }));

                setLoadingState(true, `Integrando… ${file.name}`, 60, true);
                console.info('[import] merge start', { file: file.name, rows: parsedContacts.length });
                const nowIso = new Date().toISOString();
                let fileNewContacts = 0;
                let fileMerged = 0;
                let fileRenamedCleanup = 0;
                const phoneIndex = new Map();
                const nameIndex = new Map();
                for (const existingContact of AppState.contacts) {
                    const existingPhone = normalizePhoneNumber(existingContact.phone || '');
                    if (existingPhone && !phoneIndex.has(existingPhone)) phoneIndex.set(existingPhone, existingContact);
                    const existingName = normalizeName(existingContact.name || '');
                    if (existingName && !nameIndex.has(existingName)) nameIndex.set(existingName, existingContact);
                }

                const integrationChunk = parsedContacts.length > 12000 ? 2200 : parsedContacts.length > 5000 ? 1400 : 900;
                for (let i = 0; i < parsedContacts.length; i++) {
                    if (AppState.importCancelRequested) break;
                    const newContact = parsedContacts[i];
                    const normalizedName = normalizeName(newContact.name || '');
                    const normalizedPhone = normalizePhoneNumber(newContact.phone || '');

                    const byPhone = normalizedPhone ? phoneIndex.get(normalizedPhone) : null;
                    const byName = normalizedName ? nameIndex.get(normalizedName) : null;
                    const existingContact = byPhone || byName || null;

                    if (existingContact) {
                        let touched = false;
                        if ((!existingContact.phone || !existingContact.phone.trim()) && normalizedPhone) {
                            existingContact.phone = newContact.phone;
                            phoneIndex.set(normalizedPhone, existingContact);
                            touched = true;
                        }
                        const previousOrigin = (existingContact.origin || '').trim();
                        const previousName = (existingContact.name || '').trim();
                        const incomingName = (newContact.name || '').trim();
                        if (incomingName && normalizeName(incomingName) !== normalizeName(previousName)) {
                            existingContact.name = incomingName;
                            if (!Array.isArray(existingContact.previousNames)) existingContact.previousNames = [];
                            existingContact.previousNames.unshift({ at: nowIso, from: previousName || '(vacío)', to: incomingName, file: file.name });
                            existingContact.previousNames = existingContact.previousNames.slice(0, 40);
                            existingContact.cleanupLabel = 'contactos a borrar';
                            existingContact.markedForCleanup = true;
                            fileRenamedCleanup++;
                            totalRenamedCleanup++;
                            touched = true;
                        }
                        if (origin && previousOrigin !== origin) {
                            existingContact.origin = origin;
                            if (!Array.isArray(existingContact.originHistory)) existingContact.originHistory = [];
                            existingContact.originHistory.unshift({ at: nowIso, from: previousOrigin || '(vacío)', to: origin, file: file.name });
                            existingContact.originHistory = existingContact.originHistory.slice(0, 30);
                            touched = true;
                        }
                        if (touched) {
                            existingContact.lastUpdated = nowIso;
                            existingContact.lastImportBatchId = batchId;
                            existingContact.lastImportFile = file.name;
                            existingContact.lastImportedAt = nowIso;
                            existingContact.profileId = profileIdForFile;
                            totalMerged++;
                            fileMerged++;
                        }
                    } else if (newContact.name || newContact.phone) {
                        let suggestedStatus = 'sin revisar';
                        try { suggestedStatus = suggestStatusByName(newContact.name || ''); } catch (e) { console.warn('[import] sugerencia estado falló, fallback', e); }
                        const created = {
                            id: Date.now() + Math.random() + i,
                            name: newContact.name || newContact.phone,
                            phone: newContact.phone || '',
                            origin: origin,
                            status: newContact.status || suggestedStatus,
                            lastUpdated: nowIso,
                            isDuplicate: false,
                            lastImportBatchId: batchId,
                            lastImportFile: file.name,
                            lastImportedAt: nowIso,
                            profileId: profileIdForFile
                        };
                        AppState.contacts.push(created);
                        if (normalizedPhone) phoneIndex.set(normalizedPhone, created);
                        if (normalizedName) nameIndex.set(normalizedName, created);
                        totalNewContacts++;
                        fileNewContacts++;
                    }

                    if (i % integrationChunk === 0) {
                        const base = 60 + Math.round((i / Math.max(parsedContacts.length, 1)) * 35);
                        const etaHint = parsedContacts.length > 0 ? `Integrando… ${i}/${parsedContacts.length}` : `Integrando… ${file.name}`;
                        setLoadingState(true, etaHint, base, true);
                        await new Promise((r) => setTimeout(r, 0));
                    }
                }

                addToHistory('Importación de archivo', `${file.name}: +${fileNewContacts} nuevos / ${fileMerged} actualizados / ${fileRenamedCleanup} renombrados (contactos a borrar)`);
                console.info('[import] merge done', { file: file.name, nuevos: fileNewContacts, actualizados: fileMerged });
            }

            AppState.previousImportBatchId = AppState.lastImportBatchId || '';
            AppState.lastImportBatchId = batchId;
            AppState.lastImportFileName = batchFiles[batchFiles.length - 1] || '';
            localStorage.setItem('lastImportBatchId', AppState.lastImportBatchId);
            localStorage.setItem('previousImportBatchId', AppState.previousImportBatchId);
            localStorage.setItem('lastImportFileName', AppState.lastImportFileName);

            detectDuplicates();
            const chunkedSaved = await persistContactsChunkedForImport(sanitizeContactsForStorage(AppState.contacts));
            if (!chunkedSaved) saveData();
            elements.uploadScreen.classList.add('hidden');
            elements.mainApp.style.display = 'block';
            await perfMark('render inicial', async () => { render(); });
            setLoadingState(false, 'Listo', 100, false);
            showNotification(
                AppState.importCancelRequested
                    ? `Importación cancelada. ${totalNewContacts} nuevos, ${totalMerged} actualizados, ${totalRenamedCleanup} renombrados`
                    : `✅ ${totalNewContacts} nuevos, ${totalMerged} actualizados, ${totalRenamedCleanup} renombrados`,
                AppState.importCancelRequested ? 'warning' : 'success'
            );
            console.info('[import] complete', { ms: Date.now() - importStarted, newContacts: totalNewContacts, merged: totalMerged });
            } catch (error) {
                reportError('import', error, { phase: 'loadFiles' });
                setLoadingState(false, 'Error de importación', null, false);
                showNotification(`Error al importar: ${error?.message || error}`, 'error');
            } finally {
                selectedFiles = [];
                elements.fileInput.value = '';
                elements.fileList.innerHTML = '';
            }
        }


        function importOperationsFile(file) {
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    showNotification('Procesando operaciones...', 'info');
                    announceGeneral('Procesando archivo de operaciones…', 'info');
                    setSaveState('pending', 'Procesando operaciones 0%');
                    const { byAlias, importedRows } = await parseOperationsCsvChunked(String(e.target.result || ''), ({ processed = 0, total = 0 }) => {
                        const pct = total > 0 ? Math.min(99, Math.round((processed / total) * 100)) : 0;
                        setSaveState('pending', `Procesando operaciones ${pct}%`);
                    });
                    mergeOpsProfiles(byAlias);
                    syncOpsToContacts({ createNewUsers: true });
                    detectDuplicates();
                    saveData();
                    addToHistory('Operaciones importadas', `${importedRows} filas procesadas`);
                    render();
                    setSaveState('ok', `Operaciones listas ${new Date().toLocaleTimeString('es-ES')}`);
                    showNotification(`✅ Operaciones actualizadas (${importedRows} filas)`, 'success');
                    announceGeneral(`Operaciones importadas: ${importedRows} filas`, 'success');
                } catch (err) {
                    console.error('Error importando operaciones:', err);
                    setSaveState('warn', 'Error procesando operaciones');
                    showNotification('Error al importar operaciones', 'error');
                    announceGeneral('No se pudo procesar operaciones. Se aplicó modo seguro.', 'warn', 4500);
                    setTimeout(() => setSaveState('pending', 'Pendiente'), 5000);
                }
            };
            reader.readAsText(file);
        }

        function sanitizeContactsForStorage(contacts = []) {
            return contacts.map(contact => {
                const { ops, _nameKey, _searchKey, _derivedSource, ...rest } = contact;
                return { ...rest };
            });
        }

        function getLatestBackupContacts() {
            try {
                const backupKeys = Object.keys(localStorage)
                    .filter(k => k.startsWith('bk_'))
                    .sort()
                    .reverse();
                for (const key of backupKeys) {
                    const raw = localStorage.getItem(key);
                    if (!raw) continue;
                    const parsed = JSON.parse(raw);
                    if (Array.isArray(parsed) && parsed.length) return parsed;
                }
            } catch (e) {
                console.error('Error leyendo backups:', e);
            }
            return null;
        }

        function manageAutomaticBackup() {
            if (!AppState.contacts || AppState.contacts.length === 0) return;
            const currentPct = AppState.storageEstimate?.pct || 0;
            if (currentPct >= 90) {
                const nowTs = Date.now();
                if (nowTs - (AppState.lastStorageWarnAt || 0) > 60000) {
                    AppState.lastStorageWarnAt = nowTs;
                    announceGeneral('Espacio local crítico: se omite backup interno para evitar bloqueo.', 'warn', 4200);
                }
                return;
            }

            const now = new Date();
            const hour = now.getHours();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const dateStr = `${year}-${month}-${day}`;

            let slot;
            if (hour >= 6 && hour < 14) slot = 'tm';
            else if (hour >= 14 && hour < 22) slot = 'tt';
            else slot = 'tn';

            const backupKey = `bk_${slot}_${dateStr}`;
            if (localStorage.getItem(backupKey)) return;

            try {
                const backupData = JSON.stringify(sanitizeContactsForStorage(AppState.contacts));
                localStorage.setItem(backupKey, backupData);
                console.log(`Backup automático creado: ${backupKey}`);
                
                const yesterday = new Date(now);
                yesterday.setDate(now.getDate() - 1);
                const prevYear = yesterday.getFullYear();
                const prevMonth = String(yesterday.getMonth() + 1).padStart(2, '0');
                const prevDay = String(yesterday.getDate()).padStart(2, '0');
                const prevDateStr = `${prevYear}-${prevMonth}-${prevDay}`;
                const oldBackupKey = `bk_${slot}_${prevDateStr}`;
                if(localStorage.getItem(oldBackupKey)) {
                    localStorage.removeItem(oldBackupKey);
                    console.log(`Backup antiguo eliminado: ${oldBackupKey}`);
                }
            } catch (e) {
                console.error('Error al crear backup automático:', e);
            }
        }

        function computeAutoBackupSignature() {
            if (!AppState.contacts || AppState.contacts.length === 0) return 'empty';
            const first = AppState.contacts[0];
            const last = AppState.contacts[AppState.contacts.length - 1];
            return [
                AppState.contacts.length,
                first?.id || '-',
                first?.lastUpdated || '-',
                last?.id || '-',
                last?.lastUpdated || '-'
            ].join('|');
        }

        async function ensureAutoBackupTarget() {
            if (AppState.autoBackupStorageMode === 'file' && AppState.autoBackupFileHandle) return true;
            if (AppState.autoBackupStorageMode === 'download') return false;
            if (typeof window.showSaveFilePicker !== 'function') {
                AppState.autoBackupStorageMode = 'download';
                try { localStorage.setItem('autoBackupStorageMode', 'download'); } catch (_) {}
                return false;
            }

            // Evitamos prompts/avisos intrusivos en flujos automáticos.
            AppState.autoBackupStorageMode = 'download';
            try { localStorage.setItem('autoBackupStorageMode', 'download'); } catch (_) {}
            return false;
        }

        async function persistAutomaticBackup(payload, fileName) {
            const canUseFileTarget = await ensureAutoBackupTarget();
            if (canUseFileTarget && AppState.autoBackupFileHandle) {
                try {
                    const writable = await AppState.autoBackupFileHandle.createWritable();
                    await writable.write(JSON.stringify(payload, null, 2));
                    await writable.close();
                    return 'file';
                } catch (e) {
                    console.warn('Fallo escritura sobre archivo elegido, se cae a descarga:', e);
                    AppState.autoBackupStorageMode = 'download';
                    try { localStorage.setItem('autoBackupStorageMode', 'download'); } catch (_) {}
                }
            }
            downloadFile(JSON.stringify(payload, null, 2), fileName, 'application/json;charset=utf-8;');
            return 'download';
        }

        function maybeDownloadAutomaticBackup(reason = 'interval') {
            if (!AppState.contacts || AppState.contacts.length === 0) return;
            const now = Date.now();
            if (now - AppState.lastAutoDownloadAt < AppState.autoDownloadBackupIntervalMs) return;

            const signature = computeAutoBackupSignature();
            if (signature === AppState.lastAutoBackupSignature && reason !== 'manual-force') return;

            const stamp = new Date(now).toISOString().replace(/[:T]/g, '-').slice(0, 16);
            const fileName = `nexo_backup_auto_${stamp}.json`;
            const payload = {
                exportedAt: new Date(now).toISOString(),
                reason,
                contactsCount: AppState.contacts.length,
                contacts: sanitizeContactsForStorage(AppState.contacts)
            };

            persistAutomaticBackup(payload, fileName).then((mode) => {
                AppState.lastAutoDownloadAt = now;
                AppState.lastAutoBackupSignature = signature;
                try {
                    localStorage.setItem('lastAutoBackupDownloadAt', String(now));
                    localStorage.setItem('lastAutoBackupSignature', signature);
                } catch (_) {}
                const text = mode === 'file'
                    ? `📦 Backup auto guardado en archivo elegido (${AppState.contacts.length} contactos)`
                    : `📦 Backup auto descargado (${AppState.contacts.length} contactos)`;
                showNotification(text, 'info');
                announceGeneral(text, 'info');
            }).catch((e) => {
                console.error('Error en backup automático:', e);
                announceGeneral('No se pudo guardar el backup automático', 'warn', 4200);
            });
        }

        let lastSaveErrorAt = 0;
        function setSaveState(type = 'pending', text = 'Pendiente') {
            if (!elements.saveStateBadge) return;
            elements.saveStateBadge.classList.remove('ok', 'warn', 'pending');
            elements.saveStateBadge.classList.add(type);
            elements.saveStateBadge.textContent = `● ${text}`;
        }

        function tryStorageRecovery() {
            try {
                const backupKeys = Object.keys(localStorage).filter(k => k.startsWith('bk_')).sort();
                while (backupKeys.length > 2) {
                    localStorage.removeItem(backupKeys.shift());
                }
                if (AppState.history.length > 25) {
                    AppState.history = AppState.history.slice(0, 25);
                    localStorage.setItem('contactsHistory', JSON.stringify(AppState.history));
                }
                const opsRaw = localStorage.getItem('opsProfilesData');
                if (opsRaw && opsRaw.length > 1200000) {
                    localStorage.removeItem('opsProfilesData');
                    localStorage.removeItem('opsLastImportedAt');
                    AppState.opsProfiles = {};
                    AppState.opsLastImportedAt = null;
                }
            } catch (_) {}
        }

        async function refreshStorageDiagnostics() {
            try {
                const usageBytes = (() => {
                    let total = 0;
                    for (let i = 0; i < localStorage.length; i++) {
                        const key = localStorage.key(i) || '';
                        const val = localStorage.getItem(key) || '';
                        total += (key.length + val.length) * 2;
                    }
                    return total;
                })();

                let quotaBytes = 5 * 1024 * 1024;
                if (navigator.storage && typeof navigator.storage.estimate === 'function') {
                    const estimate = await navigator.storage.estimate();
                    if (estimate?.quota) quotaBytes = estimate.quota;
                }

                const pct = Math.min(100, Math.round((usageBytes / Math.max(1, quotaBytes)) * 100));
                AppState.storageEstimate = { usageBytes, quotaBytes, pct };

                const mb = (n) => `${(n / (1024 * 1024)).toFixed(2)} MB`;
                const detail = `Almacenamiento local: ${mb(usageBytes)} / ${mb(quotaBytes)} (${pct}%)`;
                if (elements.saveStateBadge) {
                    elements.saveStateBadge.title = detail;
                }
                if (elements.storageMeter) {
                    elements.storageMeter.classList.remove('ok', 'warn', 'critical');
                    elements.storageMeter.classList.add(pct >= 92 ? 'critical' : (pct >= 80 ? 'warn' : 'ok'));
                    elements.storageMeter.textContent = `Almacenamiento ${pct}%`;
                    elements.storageMeter.title = `${detail}. Ejecutá getStorageStatus() en consola para más detalle.`;
                }
                if (pct >= 92) {
                    setSaveState('warn', `Espacio crítico ${pct}%`);
                }
            } catch (e) {
                console.warn('No se pudo estimar almacenamiento:', e);
            }
        }

        let saveDebounceTimer = null;
        function queueSaveData(delayMs = 120) {
            if (saveDebounceTimer) clearTimeout(saveDebounceTimer);
            saveDebounceTimer = setTimeout(() => {
                saveDebounceTimer = null;
                saveDataImmediate();
            }, delayMs);
        }

        function flushSaveQueue() {
            if (saveDebounceTimer) {
                clearTimeout(saveDebounceTimer);
                saveDebounceTimer = null;
            }
            saveDataImmediate();
        }

        window.getStorageStatus = () => {
            const est = AppState.storageEstimate;
            if (!est) return 'Aún sin medición. Probá guardar o recargar.';
            const mb = (n) => `${(n / (1024 * 1024)).toFixed(2)}MB`;
            const free = Math.max(0, est.quotaBytes - est.usageBytes);
            return `Uso ${mb(est.usageBytes)} / ${mb(est.quotaBytes)} (${est.pct}%), libre ${mb(free)}.`;
        };

        function saveDataImmediate() {
            const safeContacts = sanitizeContactsForStorage(AppState.contacts);
            try {
                localStorage.setItem('contactsData', JSON.stringify(safeContacts));
                manageAutomaticBackup();
                maybeDownloadAutomaticBackup('save');
                setSaveState('ok', `Guardado ${new Date().toLocaleTimeString('es-ES')}`);
                refreshStorageDiagnostics();
            } catch (e) {
                console.warn('No se pudo configurar archivo de backup, se usará descarga:', e);
                AppState.autoBackupStorageMode = 'download';
                try { localStorage.setItem('autoBackupStorageMode', 'download'); } catch (_) {}
                announceGeneral('Se canceló selección de archivo, usando descarga normal', 'warn', 4200);
                return false;
            }
        }

        async function persistAutomaticBackup(payload, fileName) {
            const canUseFileTarget = await ensureAutoBackupTarget();
            if (canUseFileTarget && AppState.autoBackupFileHandle) {
                try {
                    localStorage.setItem('contactsData', JSON.stringify(safeContacts));
                    manageAutomaticBackup();
                    maybeDownloadAutomaticBackup('save-recovery');
                    setSaveState('ok', `Guardado ${new Date().toLocaleTimeString('es-ES')}`);
                    refreshStorageDiagnostics();
                    return;
                } catch (e2) {
                    reportError('saveData-recovery', e2);
                    try {
                        localStorage.removeItem('opsProfilesData');
                        localStorage.removeItem('opsLastImportedAt');
                        localStorage.setItem('contactsData', JSON.stringify(safeContacts));
                        manageAutomaticBackup();
                        maybeDownloadAutomaticBackup('save-critical-space');
                        setSaveState('warn', 'Guardado parcial (espacio justo)');
                        refreshStorageDiagnostics();
                        showNotification('Se guardaron contactos priorizando espacio local', 'info');
                        return;
                    } catch (e3) {
                        reportError('saveData-critical', e3);
                    }
                }
                const now = Date.now();
                if (now - lastSaveErrorAt > 5000) {
                    lastSaveErrorAt = now;
                    setSaveState('warn', 'No se pudo guardar');
                }
            }
        }

        function saveData() {
            queueSaveData(120);
        }

        async function loadData() {
            showLoadingOverlay('Cargando contactos…', 'Preparando base local, turnos y validaciones iniciales.');
            try {
                const saved = localStorage.getItem('contactsData');
                if (saved) {
                    AppState.contacts = JSON.parse(saved);
                    for (let i = 0; i < AppState.contacts.length; i++) {
                        const contact = AppState.contacts[i];
                        if (!contact.lastEditedAt) contact.lastEditedAt = contact.lastUpdated || new Date().toISOString();
                        if (!contact.lastEditReason) contact.lastEditReason = 'legacy';
                        if (typeof contact.recontactAttempts !== 'number') contact.recontactAttempts = 0;
                        if (typeof contact.shiftReviewed !== 'boolean') contact.shiftReviewed = !!(contact.status && contact.status !== 'sin revisar');
                        if (!contact.shiftReviewedByShift && contact.shiftReviewed) {
                            contact.shiftReviewedByShift = contact.assignedShift || getLocalCompetitionShift(new Date(contact.lastUpdated || Date.now()));
                        }
                        if (i % 500 === 0) {
                            setLoadingState(true, 'Hidratando contactos…', Math.round((i / Math.max(AppState.contacts.length, 1)) * 100), false);
                            await new Promise((r) => setTimeout(r, 0));
                        }
                    }
                } else {
                    const backupContacts = getLatestBackupContacts();
                    if (backupContacts) {
                        AppState.contacts = backupContacts;
                        try {
                            localStorage.setItem('contactsData', JSON.stringify(sanitizeContactsForStorage(AppState.contacts)));
                        } catch (persistErr) {
                            console.warn('No se pudo reescribir contactsData durante recuperación (storage lleno):', persistErr);
                            setSaveState('warn', 'Recovery sin persistir (storage lleno)');
                        }
                        showNotification('Datos recuperados desde backup local', 'info');
                        announceGeneral('Datos recuperados desde backup local', 'warn', 4200);
                    }
                }

                if (AppState.contacts.length > 0) {
                    assignShifts();
                    detectDuplicates();
                    const syncResult = syncOpsToContacts({ createNewUsers: false });
                    if (syncResult.updatedCount > 0) saveData();
                    elements.uploadScreen.classList.add('hidden');
                    elements.mainApp.style.display = 'block';
                    refreshOriginSuggestions();
                    render();
                    manageAutomaticBackup();
                    setSaveState('ok', `Cargado ${new Date().toLocaleTimeString('es-ES')}`);
                    refreshStorageDiagnostics();
                    announceGeneral(`Base cargada: ${AppState.contacts.length} contactos`, 'success');
                } else {
                    elements.uploadScreen.classList.remove('hidden');
                }
            } catch (e) {
                reportError('loadData', e);
                elements.uploadScreen.classList.remove('hidden');
            } finally {
                hideLoadingOverlay();
            }
        }

        function serializeClientError(error) {
            if (!error) return { name: 'Error', message: 'Error vacío', stack: '' };
            if (typeof error === 'string') return { name: 'Error', message: error, stack: '' };
            return {
                name: error.name || 'Error',
                message: error.message || String(error),
                stack: error.stack || '',
                code: error.code || ''
            };
        }

        function reportError(scope, error, extra = {}) {
            const payload = serializeClientError(error);
            const enriched = { scope, ...payload, extra };
            try { console.error(`[nexo:error:${scope}]`, payload.message, extra, error); } catch (_) {}
            try {
                if (window.electronAPI?.logError) {
                    window.electronAPI.logError(enriched).catch(() => {});
                }
            } catch (_) {}
            return enriched;
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            const icons = { success: 'fa-check-circle', error: 'fa-exclamation-circle', info: 'fa-info-circle' };
            notification.innerHTML = `<i class="fas ${icons[type]}"></i><span>${message}</span>`;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 4000);
        }

        let announceTimer = null;
        let loadingInterval = null;

        function showLoadingOverlay(message = 'Cargando contactos…', details = 'Preparando datos para trabajar sin bloqueos visuales.') {
            if (!elements.loadingOverlay) return;
            if (elements.loadingOverlayText) elements.loadingOverlayText.textContent = details;
            if (elements.loadingOverlayMeta) elements.loadingOverlayMeta.textContent = '0%';
            if (elements.loadingOverlayProgress) elements.loadingOverlayProgress.style.width = '0%';
            elements.loadingOverlay.classList.add('show');
            let value = 0;
            if (loadingInterval) clearInterval(loadingInterval);
            loadingInterval = setInterval(() => {
                value = Math.min(92, value + Math.floor(Math.random() * 7) + 2);
                if (elements.loadingOverlayProgress) elements.loadingOverlayProgress.style.width = `${value}%`;
                if (elements.loadingOverlayMeta) elements.loadingOverlayMeta.textContent = `${value}%`;
            }, 120);
        }

        function hideLoadingOverlay() {
            if (!elements.loadingOverlay) return;
            if (loadingInterval) {
                clearInterval(loadingInterval);
                loadingInterval = null;
            }
            if (elements.loadingOverlayProgress) elements.loadingOverlayProgress.style.width = '100%';
            if (elements.loadingOverlayMeta) elements.loadingOverlayMeta.textContent = '100%';
            setTimeout(() => {
                elements.loadingOverlay.classList.remove('show');
            }, 100);
        }

        function withSoftTransition(callback) {
            const app = elements.mainApp;
            if (!app) {
                callback();
                return;
            }
            app.style.transition = 'opacity .12s ease, transform .12s ease';
            app.style.opacity = '0.88';
            app.style.transform = 'translateY(2px)';
            setTimeout(() => {
                callback();
                app.style.opacity = '1';
                app.style.transform = 'translateY(0)';
                setTimeout(() => {
                    app.style.transition = '';
                }, 140);
            }, 100);
        }

        function refreshOriginSuggestions() {
            const datalist = $('#originSuggestions');
            if (!datalist) return;
            const seen = new Set();
            const origins = [];
            AppState.contacts.forEach(contact => {
                const origin = (contact.origin || '').trim();
                if (!origin) return;
                const key = origin.toLowerCase();
                if (seen.has(key)) return;
                seen.add(key);
                origins.push(origin);
            });
            origins.sort((a, b) => a.localeCompare(b, 'es'));
            datalist.innerHTML = origins.slice(0, 250).map(origin => `<option value="${origin}"></option>`).join('');
        }
        function announceGeneral(message, type = 'info', timeoutMs = 3200) {
            if (!elements.globalAnnouncement) return;
            elements.globalAnnouncement.classList.remove('info', 'success', 'warn', 'show');
            elements.globalAnnouncement.classList.add(type);
            const textEl = elements.globalAnnouncement.querySelector('.announce-text');
            if (textEl) textEl.textContent = message;
            elements.globalAnnouncement.classList.add('show');
            if (announceTimer) clearTimeout(announceTimer);
            announceTimer = setTimeout(() => {
                elements.globalAnnouncement && elements.globalAnnouncement.classList.remove('show');
            }, timeoutMs);
        }

        function normalizeSearchText(value) {
            return (value || '')
                .toString()
                .toLowerCase()
                .normalize('NFD')
                .replace(/[̀-ͯ]/g, '')
                .trim();
        }

        function parseSearchQuery(rawQuery) {
            const normalized = normalizeSearchText(rawQuery);
            const tokens = normalized.split(/\s+/).filter(Boolean);
            const parsed = { terms: [], status: '', origin: '', shift: '' };

            tokens.forEach(token => {
                if (token.startsWith('estado:') || token.startsWith('status:')) {
                    parsed.status = token.split(':').slice(1).join(' ').trim();
                    return;
                }
                if (token.startsWith('origen:') || token.startsWith('origin:')) {
                    parsed.origin = token.split(':').slice(1).join(' ').trim();
                    return;
                }
                if (token.startsWith('turno:') || token.startsWith('shift:')) {
                    parsed.shift = token.split(':').slice(1).join(' ').trim();
                    return;
                }
                parsed.terms.push(token);
            });

            return parsed;
        }

        function buildContactDerivedFields(contact) {
            if (!contact) return;
            const source = [
                contact.name,
                contact.phone,
                contact.origin,
                contact.status,
                contact.alias,
                contact.assignedShift,
                contact.ops?.heat,
                contact.ops?.suggestedStatus
            ].map(v => v || '').join('|');

            if (contact._derivedSource === source) return;

            contact._nameKey = normalizeSearchText(contact.name || '');
            contact._searchKey = normalizeSearchText([
                contact.name,
                contact.phone,
                contact.origin,
                contact.status,
                contact.alias,
                contact.assignedShift,
                contact.ops?.heat,
                contact.ops?.suggestedStatus
            ].filter(Boolean).join(' | '));
            contact._derivedSource = source;
        }

        function getIsoDay(value) {
            if (!value) return '';
            const date = new Date(value);
            if (Number.isNaN(date.getTime())) return '';
            return date.toISOString().slice(0, 10);
        }

        function getEditDayStats() {
            const dayCounts = new Map();
            AppState.contacts.forEach(contact => {
                const day = getIsoDay(contact.lastEditedAt);
                if (!day) return;
                dayCounts.set(day, (dayCounts.get(day) || 0) + 1);
            });
            const today = getIsoDay(new Date());
            return {
                dayCounts,
                todayCount: dayCounts.get(today) || 0,
                hotDays: new Set([...dayCounts.entries()].filter(([, count]) => count > 10).map(([day]) => day))
            };
        }

        function touchContactEdit(contact, reason = '') {
            if (!contact) return;
            const nowIso = new Date().toISOString();
            contact.lastEditedAt = nowIso;
            contact.lastEditReason = reason || contact.lastEditReason || 'actualización';
            contact.lastUpdated = nowIso;
        }

        function getStatusRank(status) {
            const map = {
                'sin revisar': 0,
                'contactado': 1,
                'revisado': 2,
                'jugando': 3,
                'no interesado': 1,
                'sin wsp': 0
            };
            return map[status] ?? 0;
        }

        function getHigherPriorityStatus(currentStatus, suggestedStatus) {
            if (!suggestedStatus) return currentStatus;
            if (currentStatus === 'sin wsp') return currentStatus;
            return getStatusRank(suggestedStatus) > getStatusRank(currentStatus) ? suggestedStatus : currentStatus;
        }

        function applyRecontactAutopolicy(contact, requestedStatus) {
            const finalStatus = requestedStatus;
            if (requestedStatus === 'contactado') {
                contact.recontactAttempts = (contact.recontactAttempts || 0) + 1;
                contact.lastRecontactAt = new Date().toISOString();
                if ((contact.recontactAttempts || 0) >= 3 && contact.status !== 'jugando') {
                    contact.autoArchivedByPolicy = true;
                    return 'sin wsp';
                }
            }
            if (requestedStatus === 'jugando') {
                contact.recontactAttempts = 0;
                contact.autoArchivedByPolicy = false;
            }
            return finalStatus;
        }

        function normalizeProfileName(name) {
            return (name || '').toString().trim();
        }

        function ensureActiveProfile() {
            if (!Array.isArray(AppState.profiles) || !AppState.profiles.length) {
                AppState.profiles = [{ id: 'default', name: 'Base principal' }];
            }
            if (!AppState.profiles.some(p => p.id === AppState.activeProfileId)) {
                AppState.activeProfileId = AppState.profiles[0].id;
            }
        }

        function ensureProfileByName(name) {
            const n = normalizeProfileName(name).slice(0, 60);
            if (!n) return AppState.activeProfileId;
            const existing = AppState.profiles.find(p => normalizeSearchText(p.name) === normalizeSearchText(n));
            if (existing) return existing.id;
            if (AppState.profiles.length >= 8) return AppState.activeProfileId;
            const id = `pf_${Date.now()}_${Math.floor(Math.random()*9999)}`;
            AppState.profiles.push({ id, name: n });
            savePreferences();
            return id;
        }

        function refreshProfilesUI() {
            ensureActiveProfile();
            if (elements.profileSelect) {
                elements.profileSelect.innerHTML = AppState.profiles.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
                elements.profileSelect.value = AppState.activeProfileId;
            }
            if (elements.profilesList) {
                elements.profilesList.innerHTML = AppState.profiles.map((p) => `
                    <div class="history-item" style="display:flex;justify-content:space-between;align-items:center;">
                        <div><strong>${p.name}</strong><div class="history-item-muted">${AppState.contacts.filter(c => (c.profileId || 'default') === p.id).length} contactos</div></div>
                        <div style="display:flex;gap:8px;">
                            <button class="btn" onclick="switchProfile('${p.id}')">Abrir</button>
                            ${p.id !== 'default' ? `<button class="btn btn-danger" onclick="deleteProfile('${p.id}')">Borrar</button>` : ''}
                        </div>
                    </div>
                `).join('');
            }
            if (elements.splitImportByFileToggle) elements.splitImportByFileToggle.checked = !!AppState.splitImportByFile;
        }

        window.switchProfile = (profileId) => {
            AppState.activeProfileId = profileId;
            localStorage.setItem('activeProfileId', AppState.activeProfileId);
            refreshProfilesUI();
            render();
            if (elements.profilesModal) elements.profilesModal.classList.remove('active');
        };

        window.deleteProfile = (profileId) => {
            if (profileId === 'default') return;
            const count = AppState.contacts.filter(c => (c.profileId || 'default') === profileId).length;
            const ok = confirm(`¿Borrar perfil y ${count} contactos asociados?`);
            if (!ok) return;
            AppState.contacts = AppState.contacts.filter(c => (c.profileId || 'default') !== profileId);
            AppState.profiles = AppState.profiles.filter(p => p.id !== profileId);
            ensureActiveProfile();
            detectDuplicates();
            saveData();
            refreshProfilesUI();
            render();
        };

        function getContactBatchId(contact) {
            return String(contact?.lastImportBatchId || contact?.importBatchId || '').trim();
        }

        function applyFilters() {
            const parsedQuery = parseSearchQuery(AppState.searchTerm);
            const selectedStatus = AppState.statusFilter || parsedQuery.status;
            const selectedOrigin = AppState.originFilter || parsedQuery.origin;
            const selectedShift = AppState.shiftFilter || parsedQuery.shift;
            const editStats = getEditDayStats();

            AppState.filteredContacts = AppState.contacts.filter(contact => {
                buildContactDerivedFields(contact);
                const matchesSearch = parsedQuery.terms.length === 0 || parsedQuery.terms.every(term => contact._searchKey.includes(term));
                const matchesStatus = !selectedStatus || normalizeSearchText(contact.status) === selectedStatus;
                const isLastUploadFilter = selectedOrigin === '__last_upload__';
                const matchesOrigin = isLastUploadFilter
                    ? (AppState.lastImportBatchId && getContactBatchId(contact) === AppState.lastImportBatchId)
                    : (!selectedOrigin || normalizeSearchText(contact.origin) === selectedOrigin || (normalizeSearchText(selectedOrigin) === 'operaciones panel' && !!contact.ops));
                const activeProfile = AppState.activeProfileId || 'default';
                const matchesProfile = (contact.profileId || 'default') === activeProfile;
                const matchesShift = !selectedShift || normalizeSearchText(contact.assignedShift) === selectedShift;

                let matchesPhone = true;
                if (AppState.phoneFilter === 'with') matchesPhone = !!(contact.phone || '').trim();
                else if (AppState.phoneFilter === 'without') matchesPhone = !(contact.phone || '').trim();

                let matchesOps = true;
                if (AppState.opsFilter === 'matched') matchesOps = !!contact.ops;
                else if (AppState.opsFilter === 'nomatch') matchesOps = !contact.ops;

                let matchesEditActivity = true;
                const editedDay = getIsoDay(contact.lastEditedAt);
                if (AppState.editActivityFilter === 'today10plus') {
                    const today = getIsoDay(new Date());
                    matchesEditActivity = editStats.todayCount > 10 && editedDay === today;
                } else if (AppState.editActivityFilter === 'any10plus') {
                    matchesEditActivity = !!editedDay && editStats.hotDays.has(editedDay);
                }

                return matchesProfile && matchesSearch && matchesStatus && matchesOrigin && matchesShift && matchesPhone && matchesOps && matchesEditActivity;
            });

            if (AppState.opsFilter === 'top50' || AppState.opsFilter === 'top100') {
                const limit = AppState.opsFilter === 'top50' ? 50 : 100;
                AppState.filteredContacts = AppState.filteredContacts
                    .filter(c => c.ops)
                    .sort((a, b) => (b.ops?.score || 0) - (a.ops?.score || 0))
                    .slice(0, limit);
            }
        }

        function updateStats() {
            const totals = {
                total: AppState.contacts.length,
                unreviewed: 0,
                contactado: 0,
                revisado: 0,
                jugando: 0,
                sinWsp: 0,
                noInteresado: 0,
                reviewed: 0
            };
            const originSet = new Set();

            AppState.contacts.forEach(c => {
                if (c.origin) originSet.add(c.origin);
                if (c.status !== 'sin revisar') totals.reviewed++;
                if (c.status === 'sin revisar') totals.unreviewed++;
                else if (c.status === 'contactado') totals.contactado++;
                else if (c.status === 'revisado') totals.revisado++;
                else if (c.status === 'jugando') totals.jugando++;
                else if (c.status === 'sin wsp') totals.sinWsp++;
                else if (c.status === 'no interesado') totals.noInteresado++;
            });

            $('#totalCount').textContent = totals.total;
            $('#unreviewedCount').textContent = totals.unreviewed;
            $('#contactadoCount').textContent = totals.contactado;
            const revisadoCountEl = $('#revisadoCount');
            if (revisadoCountEl) revisadoCountEl.textContent = totals.revisado;
            $('#jugandoCount').textContent = totals.jugando;
            $('#sinWspCount').textContent = totals.sinWsp;
            $('#noInteresadoCount').textContent = totals.noInteresado;

            const totalDuplicateEntries = (AppState.duplicates || []).reduce((sum, group) => sum + group.contacts.length, 0);
            $('#duplicatesCount').textContent = totalDuplicateEntries;

            updateExportUrgencyBadge();
            const progressPercentage = totals.total > 0 ? Math.round((totals.reviewed / totals.total) * 100) : 0;

            $('#reviewedCount').textContent = totals.reviewed;
            $('#totalContactsCount').textContent = totals.total;
            $('#progressPercentage').textContent = `${progressPercentage}%`;
            $('#progressFill').style.width = `${progressPercentage}%`;

            const uniqueOrigins = [...originSet].sort();
            const lastUploadLabel = AppState.lastImportFileName ? `Última subida (${AppState.lastImportFileName})` : 'Última subida';
            elements.originFilter.innerHTML = '<option value="">Todos los orígenes</option>' +
                `<option value="__last_upload__">${lastUploadLabel}</option>` +
                uniqueOrigins.map(o => `<option value="${o}">${o}</option>`).join('');
            elements.originFilter.value = AppState.originFilter;
        }

        function getStatusOption(status) {
            return STATUS_OPTIONS.find(s => s.id === status) || STATUS_OPTIONS[0];
        }

        function setReviewMetadata(contact, status) {
            if (!contact) return;
            try {
                const nowIso = new Date().toISOString();
                const safeStatus = (typeof status === 'string' && status.trim()) ? status : (contact.status || 'sin revisar');
                if (safeStatus === 'revisado') {
                    contact.reviewedAt = nowIso;
                }
                if (safeStatus === 'sin revisar') {
                    contact.nextReviewAfter = new Date(Date.now() + (6 * 60 * 60 * 1000)).toISOString();
                } else if (safeStatus === 'contactado') {
                    contact.nextReviewAfter = new Date(Date.now() + (18 * 60 * 60 * 1000)).toISOString();
                } else {
                    contact.nextReviewAfter = null;
                }
            } catch (e) {
                console.error('setReviewMetadata fallback:', e);
            }
        }
        function inferShiftForContact(contact, rrState) {
            const o = normalizeUsername(contact.origin || '');
            if (o.includes('mañana') || o.includes('manana')) return 'tm';
            if (o.includes('tarde')) return 'tt';
            if (o.includes('noche')) return 'tn';
            const seq = ['tm', 'tt', 'tn'];
            const shift = seq[rrState.i % seq.length];
            rrState.i += 1;
            return shift;
        }

        function getLocalCompetitionShift(date = new Date()) {
            const hour = date.getHours();
            if (hour >= 6 && hour < 14) return 'tm';
            if (hour >= 14 && hour < 22) return 'tt';
            return 'tn';
        }

        function updateCompetitionCredit(contact, newStatus, source = 'common', { forceTransfer = false } = {}) {
            if (!contact) return false;

            if (newStatus === 'sin revisar') {
                const changed = !!(contact.shiftReviewed || contact.shiftReviewedByShift || contact.shiftReviewedAt);
                contact.shiftReviewed = false;
                contact.shiftReviewedByShift = null;
                contact.shiftReviewedAt = null;
                return changed;
            }

            const localShift = getLocalCompetitionShift(new Date());
            const changed = forceTransfer || !contact.shiftReviewed || contact.shiftReviewedByShift !== localShift;
            contact.shiftReviewed = true;
            contact.shiftReviewedByShift = localShift;
            if (changed) contact.shiftReviewedAt = new Date().toISOString();
            return changed;
        }

        function assignShifts() {
            const rr = { i: 0 };
            AppState.contacts.forEach(c => {
                if (!c.assignedShift) c.assignedShift = inferShiftForContact(c, rr);
            });
        }

        function getShiftStats(shift) {
            const pendientes = AppState.contacts.filter(c => c.assignedShift === shift && c.status === 'sin revisar').length;
            const revisados = AppState.contacts.filter(c => c.shiftReviewed && c.shiftReviewedByShift === shift && c.status !== 'sin revisar').length;
            const total = revisados + pendientes;
            const pct = total ? Math.min(100, Math.round((revisados / total) * 100)) : 0;
            return { total, revisados, pendientes, pct };
        }

        function renderShiftsView() {
            assignShifts();
            const shifts = ['tm', 'tt', 'tn'];
            const shiftStats = shifts.map(shift => ({ shift, st: getShiftStats(shift), data: AppState.shiftMode[shift] }));
            const totals = shiftStats.reduce((acc, row) => {
                acc.total += row.st.total;
                acc.revisados += row.st.revisados;
                acc.pendientes += row.st.pendientes;
                return acc;
            }, { total: 0, revisados: 0, pendientes: 0 });
            const pct = totals.total ? Math.round((totals.revisados / totals.total) * 100) : 0;

            const overviewCard = `
                <div class="shifts-overview-card">
                    <div>
                        <div style="font-weight:800; font-size:1rem;">Vista de competencia por turnos</div>
                        <div style="color:var(--text-secondary); font-size:.86rem; margin-top:2px;">En este modo ocultamos búsqueda/filtros generales para enfocarte en productividad por turno.</div>
                        <div class="shifts-overview-stats" style="margin-top:8px;">
                            <span>Total asignados: <strong>${totals.total}</strong></span>
                            <span>Revisados: <strong>${totals.revisados}</strong></span>
                            <span>Pendientes: <strong>${totals.pendientes}</strong></span>
                            <span>Avance global: <strong>${pct}%</strong></span>
                        </div>
                    </div>
                    <div class="shifts-overview-actions">
                        <button class="btn" onclick="rebalanceShift('all')"><i class="fas fa-random"></i> Rebalancear todo</button>
                        <button class="btn" onclick="closeQuickReview()"><i class="fas fa-times-circle"></i> Cerrar revisión rápida</button>
                    </div>
                </div>`;

            const cards = shiftStats.map(({ shift, st, data }) => {
                return `
                <div class="shift-card">
                    <h3>
                        <span>${shift.toUpperCase()}</span>
                        <input class="filter-select" style="max-width:130px;" value="${data.name}" onchange="renameShift('${shift}', this.value)">
                    </h3>
                    <div class="shift-card-sub">Operador y cola de revisión para este turno.</div>
                    <div class="shift-stats">
                        <span>Asignados: <strong>${st.total}</strong></span>
                        <span>Revisados: <strong>${st.revisados}</strong></span>
                        <span>Pendientes: <strong>${st.pendientes}</strong></span>
                    </div>
                    <div class="shift-progress"><span style="width:${st.pct}%"></span></div>
                    <div class="shift-controls">
                        <button class="btn" onclick="startShiftReview('${shift}')"><i class="fas fa-play"></i> Empezar revisión</button>
                        <button class="btn" onclick="rebalanceShift('${shift}')"><i class="fas fa-random"></i> Rebalancear</button>
                    </div>
                </div>`;
            }).join('');

            elements.shiftsView.innerHTML = overviewCard + cards;
            elements.shiftsView.style.display = 'grid';
        }
        function inferShiftForContact(contact, rrState) {
            const o = normalizeUsername(contact.origin || '');
            if (o.includes('mañana') || o.includes('manana')) return 'tm';
            if (o.includes('tarde')) return 'tt';
            if (o.includes('noche')) return 'tn';
            const seq = ['tm', 'tt', 'tn'];
            const shift = seq[rrState.i % seq.length];
            rrState.i += 1;
            return shift;
        }

        function getLocalCompetitionShift(date = new Date()) {
            const hour = date.getHours();
            if (hour >= 6 && hour < 14) return 'tm';
            if (hour >= 14 && hour < 22) return 'tt';
            return 'tn';
        }

        function updateCompetitionCredit(contact, newStatus, source = 'common', { forceTransfer = false } = {}) {
            if (!contact) return false;

            if (newStatus === 'sin revisar') {
                const changed = !!(contact.shiftReviewed || contact.shiftReviewedByShift || contact.shiftReviewedAt);
                contact.shiftReviewed = false;
                contact.shiftReviewedByShift = null;
                contact.shiftReviewedAt = null;
                return changed;
            }

            const localShift = getLocalCompetitionShift(new Date());
            const changed = forceTransfer || !contact.shiftReviewed || contact.shiftReviewedByShift !== localShift;
            contact.shiftReviewed = true;
            contact.shiftReviewedByShift = localShift;
            if (changed) contact.shiftReviewedAt = new Date().toISOString();
            return changed;
        }

        function assignShifts() {
            const rr = { i: 0 };
            AppState.contacts.forEach(c => {
                if (!c.assignedShift) c.assignedShift = inferShiftForContact(c, rr);
            });
        }

        function getShiftStats(shift) {
            const pendientes = AppState.contacts.filter(c => c.assignedShift === shift && c.status === 'sin revisar').length;
            const revisados = AppState.contacts.filter(c => c.shiftReviewed && c.shiftReviewedByShift === shift && c.status !== 'sin revisar').length;
            const total = revisados + pendientes;
            const pct = total ? Math.min(100, Math.round((revisados / total) * 100)) : 0;
            return { total, revisados, pendientes, pct };
        }

        function renderShiftsView() {
            assignShifts();
            const shifts = ['tm', 'tt', 'tn'];
            const shiftStats = shifts.map(shift => ({ shift, st: getShiftStats(shift), data: AppState.shiftMode[shift] }));
            const totals = shiftStats.reduce((acc, row) => {
                acc.total += row.st.total;
                acc.revisados += row.st.revisados;
                acc.pendientes += row.st.pendientes;
                return acc;
            }, { total: 0, revisados: 0, pendientes: 0 });
            const pct = totals.total ? Math.round((totals.revisados / totals.total) * 100) : 0;

            const overviewCard = `
                <div class="shifts-overview-card">
                    <div>
                        <div style="font-weight:800; font-size:1rem;">Vista de competencia por turnos</div>
                        <div style="color:var(--text-secondary); font-size:.86rem; margin-top:2px;">En este modo ocultamos búsqueda/filtros generales para enfocarte en productividad por turno.</div>
                        <div class="shifts-overview-stats" style="margin-top:8px;">
                            <span>Total asignados: <strong>${totals.total}</strong></span>
                            <span>Revisados: <strong>${totals.revisados}</strong></span>
                            <span>Pendientes: <strong>${totals.pendientes}</strong></span>
                            <span>Avance global: <strong>${pct}%</strong></span>
                        </div>
                    </div>
                    <div class="shifts-overview-actions">
                        <button class="btn" onclick="rebalanceShift('all')"><i class="fas fa-random"></i> Rebalancear todo</button>
                        <button class="btn" onclick="closeQuickReview()"><i class="fas fa-times-circle"></i> Cerrar revisión rápida</button>
                    </div>
                </div>`;

            const cards = shiftStats.map(({ shift, st, data }) => {
                return `
                <div class="shift-card">
                    <h3>
                        <span>${shift.toUpperCase()}</span>
                        <input class="filter-select" style="max-width:130px;" value="${data.name}" onchange="renameShift('${shift}', this.value)">
                    </h3>
                    <div class="shift-card-sub">Operador y cola de revisión para este turno.</div>
                    <div class="shift-stats">
                        <span>Asignados: <strong>${st.total}</strong></span>
                        <span>Revisados: <strong>${st.revisados}</strong></span>
                        <span>Pendientes: <strong>${st.pendientes}</strong></span>
                    </div>
                    <div class="shift-progress"><span style="width:${st.pct}%"></span></div>
                    <div class="shift-controls">
                        <button class="btn" onclick="startShiftReview('${shift}')"><i class="fas fa-play"></i> Empezar revisión</button>
                        <button class="btn" onclick="rebalanceShift('${shift}')"><i class="fas fa-random"></i> Rebalancear</button>
                    </div>
                </div>`;
            }).join('');

            elements.shiftsView.innerHTML = overviewCard + cards;
            elements.shiftsView.style.display = 'grid';
        }

        window.renameShift = (shift, value) => {
            AppState.shiftMode[shift].name = (value || shift.toUpperCase()).trim();
            saveData();
        };


        window.rebalanceShift = (shift) => {
            const seq = ['tm', 'tt', 'tn'];
            if (shift === 'all') {
                const unreviewed = AppState.contacts.filter(c => c.status === 'sin revisar');
                let i = 0;
                unreviewed.forEach(c => { c.assignedShift = seq[i % 3]; i++; });
                renderShiftsView();
                saveData();
                showNotification('Turnos rebalanceados (global)', 'success');
                return;
            }

            const shiftContacts = AppState.contacts.filter(c => c.assignedShift === shift && c.status === 'sin revisar');
            shiftContacts.forEach(c => { c.shiftReviewed = false; });
            renderShiftsView();
            saveData();
            showNotification(`Turno ${String(shift).toUpperCase()} rebalanceado`, 'success');
        };

        function buildShiftQueue(shift) {
            return AppState.contacts
                .filter(c => c.assignedShift === shift && c.status === 'sin revisar')
                .sort((a, b) => (new Date(a.lastUpdated || 0).getTime()) - (new Date(b.lastUpdated || 0).getTime()));
        }

        window.startShiftReview = (shift) => {
            AppState.activeShift = shift;
            AppState.shiftMode[shift].queue = buildShiftQueue(shift);
            AppState.shiftMode[shift].cursor = 0;
            AppState.shiftMode[shift].stack = [];
            renderQuickReview();
        };

        function renderQuickReview() {
            const shift = AppState.activeShift;
            if (!shift) { elements.quickReview.style.display = 'none'; return; }
            const mode = AppState.shiftMode[shift];
            const contact = mode.queue[mode.cursor];
            if (!contact) {
                elements.quickReview.style.display = 'block';
                elements.quickReview.innerHTML = `<h3>Revisión ${shift.toUpperCase()}</h3><p style="color:var(--text-secondary)">Sin más contactos en este turno.</p><button class="btn" onclick="closeQuickReview()">Cerrar</button>`;
                return;
            }
            const phoneTxt = contact.phone || 'Sin teléfono';
            const st = getStatusOption(contact.status);
            elements.quickReview.style.display = 'block';
            const initials = (contact.name || '?').trim().slice(0, 2).toUpperCase();
            const escapedName = (contact.name || '').replace(/'/g, "\\'");
            const escapedPhone = (contact.phone || '').replace(/'/g, "\\'");
            const totalInQueue = mode.queue.length;
            const currentPos = Math.min(mode.cursor + 1, Math.max(1, totalInQueue));
            elements.quickReview.innerHTML = `
                <div class="quick-layout">
                    <div class="quick-profile">
                        <div class="quick-profile-head">
                            <div class="quick-avatar">${initials}</div>
                            <div>
                                <div class="quick-name">${contact.name}</div>
                                <div class="quick-meta">${phoneTxt} · ${contact.origin || '-'}</div>
                            </div>
                        </div>
                        <div class="quick-chips">
                            <span class="quick-chip">Turno ${shift.toUpperCase()}</span>
                            <span class="quick-chip">Operador: ${AppState.shiftMode[shift].name}</span>
                            <span class="quick-chip">Estado: ${st.label}</span>
                            <span class="quick-chip">Cuenta para: ${getLocalCompetitionShift(new Date()).toUpperCase()}</span>
                        </div>
                        <div class="quick-progress">Usuario ${currentPos} de ${totalInQueue} en cola</div>
                    </div>
                    <div class="quick-panel">
                        <div class="quick-topbar">
                            <h3 style="margin:0;">Revisión rápida ${shift.toUpperCase()}</h3>
                            <button class="btn" onclick="closeQuickReview()"><i class="fas fa-times"></i> Cerrar</button>
                        </div>
                        <div class="review-actions">
                            ${STATUS_OPTIONS.map(opt => `<button class="btn ${opt.id===contact.status?'btn-success':''}" onclick="reviewSetStatus(${contact.id}, '${opt.id}')"><i class="fas ${opt.icon}"></i> ${opt.label}</button>`).join('')}
                        </div>
                        <div class="quick-tools">
                            <button class="btn" onclick="reviewPrev()" title="Deshabilitado para mantener consistencia de cola"><i class="fas fa-lock"></i> Sin retroceso</button>
                            <button class="btn" onclick="reviewSkip()"><i class="fas fa-forward"></i> Saltar</button>
                            <button class="btn" onclick="copyToClipboard('${escapedName}')"><i class="fas fa-copy"></i> Copiar usuario</button>
                            ${contact.phone ? `<button class="btn" onclick="copyToClipboard('${escapedPhone}')"><i class="fas fa-copy"></i> Copiar teléfono</button>` : ''}
                            <button class="btn" onclick="editContactField(${contact.id}, 'name')"><i class="fas fa-pen"></i> Editar</button>
                            ${contact.phone ? `<button class="btn btn-success" onclick="openWhatsApp('${escapedPhone}', event)"><i class="fab fa-whatsapp"></i> WhatsApp</button>` : ''}
                        </div>
                    </div>
                </div>
            `;
        }

        window.reviewSetStatus = (id, status) => {
            const shift = AppState.activeShift;
            if (!shift) return;
            const mode = AppState.shiftMode[shift];
            const current = mode.queue[mode.cursor];
            if (current) mode.stack.push(current.id);
            changeContactStatus(id, status, null, 'shift');
            mode.cursor += 1;
            mode.queue = buildShiftQueue(shift);
            renderQuickReview();
            renderShiftsView();
        };

        window.reviewPrev = () => {
            showNotification('Retroceso deshabilitado en modo competencia para no romper la cola', 'warning');
        };

        window.reviewSkip = () => {
            const shift = AppState.activeShift;
            if (!shift) return;
            const mode = AppState.shiftMode[shift];
            if (mode.cursor < mode.queue.length - 1) mode.cursor += 1;
            else mode.cursor = mode.queue.length;
            renderQuickReview();
        };

        window.closeQuickReview = () => {
            AppState.activeShift = null;
            elements.quickReview.style.display = 'none';
        };

        window.renameShift = (shift, value) => {
            AppState.shiftMode[shift].name = (value || shift.toUpperCase()).trim();
            saveData();
        };

        window.rebalanceShift = (shift) => {
            const seq = ['tm', 'tt', 'tn'];
            if (shift === 'all') {
                const unreviewed = AppState.contacts.filter(c => c.status === 'sin revisar');
                let i = 0;
                unreviewed.forEach(c => { c.assignedShift = seq[i % 3]; i++; });
                renderShiftsView();
                saveData();
                showNotification('Turnos rebalanceados (global)', 'success');
                return;
            }

            const shiftContacts = AppState.contacts.filter(c => c.assignedShift === shift && c.status === 'sin revisar');
            shiftContacts.forEach(c => { c.shiftReviewed = false; });
            renderShiftsView();
            saveData();
            showNotification(`Turno ${String(shift).toUpperCase()} rebalanceado`, 'success');
        };

        function buildShiftQueue(shift) {
            return AppState.contacts
                .filter(c => c.assignedShift === shift && c.status === 'sin revisar')
                .sort((a, b) => (new Date(a.lastUpdated || 0).getTime()) - (new Date(b.lastUpdated || 0).getTime()));
        }

        window.startShiftReview = (shift) => {
            AppState.activeShift = shift;
            AppState.shiftMode[shift].queue = buildShiftQueue(shift);
            AppState.shiftMode[shift].cursor = 0;
            AppState.shiftMode[shift].stack = [];
            renderQuickReview();
        };

        function renderQuickReview() {
            const shift = AppState.activeShift;
            if (!shift) { elements.quickReview.style.display = 'none'; return; }
            const mode = AppState.shiftMode[shift];
            const contact = mode.queue[mode.cursor];
            if (!contact) {
                elements.quickReview.style.display = 'block';
                elements.quickReview.innerHTML = `<h3>Revisión ${shift.toUpperCase()}</h3><p style="color:var(--text-secondary)">Sin más contactos en este turno.</p><button class="btn" onclick="closeQuickReview()">Cerrar</button>`;
                return;
            }
            const phoneTxt = contact.phone || 'Sin teléfono';
            const st = getStatusOption(contact.status);
            elements.quickReview.style.display = 'block';
            const initials = (contact.name || '?').trim().slice(0, 2).toUpperCase();
            const escapedName = (contact.name || '').replace(/'/g, "\\'");
            const escapedPhone = (contact.phone || '').replace(/'/g, "\\'");
            const totalInQueue = mode.queue.length;
            const currentPos = Math.min(mode.cursor + 1, Math.max(1, totalInQueue));
            elements.quickReview.innerHTML = `
                <div class="quick-layout">
                    <div class="quick-profile">
                        <div class="quick-profile-head">
                            <div class="quick-avatar">${initials}</div>
                            <div>
                                <div class="quick-name copyable" onclick="copyToClipboard('${escapedName}', event)" title="Click para copiar usuario"><i class="fas fa-copy" style="font-size:.78rem;opacity:.8"></i>${contact.name}</div>
                                <div class="quick-meta">${phoneTxt} · ${contact.origin || '-'}</div>
                            </div>
                        </div>
                        <div class="quick-chips">
                            <span class="quick-chip">Turno ${shift.toUpperCase()}</span>
                            <span class="quick-chip">Operador: ${AppState.shiftMode[shift].name}</span>
                            <span class="quick-chip">Competencia: Pendiente</span>
                            <span class="quick-chip">Cuenta para: ${getLocalCompetitionShift(new Date()).toUpperCase()}</span>
                            ${contact.status !== 'sin revisar' ? `<span class="quick-chip" style="border-color:rgba(251,191,36,.45);color:#fde68a;">Preestado: ${st.label}</span>` : ''}
                        </div>
                        <div class="quick-progress">Usuario ${currentPos} de ${totalInQueue} en cola</div>
                    </div>
                    <div class="quick-panel">
                        <div class="quick-topbar">
                            <h3 style="margin:0;">Revisión rápida ${shift.toUpperCase()}</h3>
                            <button class="btn" onclick="closeQuickReview()"><i class="fas fa-times"></i> Cerrar</button>
                        </div>
                        <div class="review-actions">
                            ${STATUS_OPTIONS.map(opt => `<button class="btn quick-status-btn ${opt.id.replace(/ /g,'-')}" onclick="reviewSetStatus(${contact.id}, '${opt.id}', event)"><i class="fas ${opt.icon}"></i> ${opt.label}</button>`).join('')}
                        </div>
                        <div class="quick-tools">
                            <button class="btn" onclick="reviewPrev()" title="Deshabilitado para mantener consistencia de cola"><i class="fas fa-lock"></i> Sin retroceso</button>
                            <button class="btn" onclick="reviewSkip()"><i class="fas fa-forward"></i> Saltar</button>
                            <button class="btn" onclick="copyToClipboard('${escapedName}')"><i class="fas fa-copy"></i> Copiar usuario</button>
                            ${contact.phone ? `<button class="btn" onclick="copyToClipboard('${escapedPhone}')"><i class="fas fa-copy"></i> Copiar teléfono</button>` : ''}
                            <button class="btn" onclick="editContactField(${contact.id}, 'name')"><i class="fas fa-pen"></i> Editar</button>
                            ${contact.phone ? `<button class="btn btn-success" onclick="openWhatsApp('${escapedPhone}', event)"><i class="fab fa-whatsapp"></i> WhatsApp</button>` : ''}
                        </div>
                    </div>
                </div>
            `;
        }

        window.reviewSetStatus = (id, status, event) => {
            const shift = AppState.activeShift;
            if (!shift) return;
            const mode = AppState.shiftMode[shift];
            const current = mode.queue[mode.cursor];
            if (!current) return;
            if (event && event.currentTarget) event.currentTarget.classList.add('applied');
            const quickPanel = elements.quickReview.querySelector('.quick-panel');
            if (quickPanel) quickPanel.classList.add('updating');
            mode.stack.push(current.id);
            changeContactStatus(id, status, null, 'shift');
            setTimeout(() => {
                mode.cursor += 1;
                mode.queue = buildShiftQueue(shift);
                renderQuickReview();
                renderShiftsView();
            }, 130);
        };

        window.reviewPrev = () => {
            showNotification('Retroceso deshabilitado en modo competencia para no romper la cola', 'warning');
        };

        window.reviewSkip = () => {
            const shift = AppState.activeShift;
            if (!shift) return;
            const mode = AppState.shiftMode[shift];
            if (mode.cursor < mode.queue.length - 1) mode.cursor += 1;
            else mode.cursor = mode.queue.length;
            renderQuickReview();
        };

        window.closeQuickReview = () => {
            AppState.activeShift = null;
            elements.quickReview.style.display = 'none';
        };

        function getContactUrgency(contact) {
            if (contact.status !== 'revisado') return null;
            const base = contact.reviewedAt || contact.lastUpdated;
            if (!base) return null;
            const elapsedH = (Date.now() - new Date(base).getTime()) / 36e5;
            if (elapsedH < 16) return null;
            if (elapsedH < 24) return { level: 1, label: '16h', title: 'Revisado hace más de 16 horas' };
            if (elapsedH < 48) return { level: 2, label: '1 día', title: 'Revisado hace más de 1 día' };
            if (elapsedH < 72) return { level: 3, label: '2 días', title: 'Revisado hace más de 2 días' };
            return { level: 4, label: '3+ días', title: 'Revisado hace más de 3 días' };
        }

        function getExportUrgency() {
            const now = new Date();
            const slots = [5, 13, 21];
            let lastScheduled = null;
            for (let i = slots.length - 1; i >= 0; i--) {
                const d = new Date(now);
                d.setHours(slots[i], 0, 0, 0);
                if (d <= now) { lastScheduled = d; break; }
            }
            if (!lastScheduled) {
                lastScheduled = new Date(now);
                lastScheduled.setDate(now.getDate() - 1);
                lastScheduled.setHours(21, 0, 0, 0);
            }
            const lastExport = localStorage.getItem('lastExportAt');
            if (lastExport && new Date(lastExport) >= lastScheduled) return null;
            const overdueH = (now - lastScheduled) / 36e5;
            if (overdueH < 0.01) return null;
            if (overdueH < 8) return { level: 1, text: 'Pendiente', next: lastScheduled };
            if (overdueH < 16) return { level: 2, text: 'Atrasado', next: lastScheduled };
            return { level: 3, text: 'Urgente', next: lastScheduled };
        }

        function updateExportUrgencyBadge() {
            const btn = elements.exportBtn;
            if (!btn) return;
            btn.classList.remove('export-urgency-1', 'export-urgency-2', 'export-urgency-3');
            const urgency = getExportUrgency();
            const icon = '<i class="fas fa-download"></i>';
            if (!urgency) {
                btn.innerHTML = `${icon} Exportar`;
                btn.title = 'Exportar';
                return;
            }
            btn.classList.add(`export-urgency-${urgency.level}`);
            btn.innerHTML = `${icon} Exportar <span class="urgency-badge urgency-l${urgency.level}">${urgency.text}</span>`;
            btn.title = `Recordatorio de exportación (${urgency.next.toLocaleString('es-ES')})`;
        }


        function getMessageSentBadge(contact) {
            if (!contact?.lastMessageSentAt) return '';
            const sentAt = new Date(contact.lastMessageSentAt);
            const title = `Mensaje enviado: ${sentAt.toLocaleString('es-ES')}`;
            return `<span class="message-sent-tick" title="${title}"><i class="fas fa-check-double"></i></span>`;
        }

        function createCard(contact) {
            const statusOption = getStatusOption(contact.status);
            const escapedName = (contact.name || '').replace(/'/g, "\\'");
            const escapedPhone = (contact.phone || '').replace(/'/g, "\\'");
            const urgency = getContactUrgency(contact);
            const sentBadge = getMessageSentBadge(contact);
            const opsMini = getOpsMiniHtml(contact);
            const editedAtLabel = contact.lastEditedAt ? new Date(contact.lastEditedAt).toLocaleString('es-ES') : '-';
            
            return `
                <div class="contact-card ${AppState.selectedContacts.has(contact.id) ? 'selected' : ''} ${contact.isDuplicate ? 'duplicate' : ''}" style="--status-rgb: ${statusOption.rgb};" data-id="${contact.id}">
                    ${contact.isDuplicate ? '<span class="duplicate-badge"><i class="fas fa-exclamation-triangle"></i> DUP</span>' : ''}
                    <input type="checkbox" class="card-checkbox" ${AppState.selectedContacts.has(contact.id) ? 'checked' : ''}>
                    <div class="card-header">
                        <div class="card-icon" style="color: ${statusOption.color};">
                            <i class="fas ${statusOption.icon}"></i>
                        </div>
                        <div style="flex: 1; display: flex; align-items: center; gap: 8px;">
                            <span class="card-name" onclick="copyToClipboard('${escapedName}', event)" style="cursor: pointer; flex: 1;" title="Click para copiar">${contact.pinned ? '📌 ' : ''}${contact.name}</span>${AppState.currentView === 'shifts' && contact.assignedShift ? `<span class=\"shift-tag\">${contact.assignedShift.toUpperCase()}</span>` : ''}${urgency ? `<span class=\"urgency-badge urgency-l${urgency.level}\" title=\"${urgency.title}\"><i class=\"fas fa-clock\"></i>${urgency.label}</span>` : ''}
                            <button class="btn" style="padding: 4px 8px; font-size: 0.75rem;" onclick="editContactField(${contact.id}, 'name', event)" title="Editar nombre">
                                <i class="fas fa-pencil-alt"></i>
                            </button>
                            <button class="btn" style="padding: 4px 8px; font-size: 0.75rem;" onclick="openContactHistory(${contact.id}, event)" title="Historial del usuario">
                                <i class="fas fa-id-card"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-details">
                        ${contact.phone ? `
                            <div class="detail-item">
                                <i class="fas fa-phone"></i>
                                <span onclick="copyToClipboard('${escapedPhone}', event)" style="cursor: pointer; flex: 1;" title="Click para copiar">${contact.phone}</span>
                                <button class="btn" style="padding: 4px 8px; font-size: 0.7rem;" onclick="editContactField(${contact.id}, 'phone', event)" title="Editar">
                                    <i class="fas fa-pencil-alt"></i>
                                </button>
                                <button class="btn btn-success" style="padding: 4px 8px; font-size: 0.7rem;" onclick="openWhatsApp('${escapedPhone}', event)" title="WhatsApp">
                                    <i class="fab fa-whatsapp"></i>
                                </button>
                                ${sentBadge}
                            </div>
                        ` : `<div class="detail-item"><i class="fas fa-phone"></i><span style="color: var(--text-secondary); flex:1;">Sin teléfono</span><button class="btn" style="padding: 4px 8px; font-size: 0.7rem;" onclick="editContactField(${contact.id}, 'phone', event)" title="Agregar teléfono"><i class="fas fa-pencil-alt"></i></button></div>`}
                        <div class="detail-item"><i class="fas fa-tag"></i><span>${contact.origin}</span></div>
                        <div class="detail-item">
                            <i class="fas fa-circle-notch"></i>
                            <span class="card-status-inline" id="cardStatusInline-${contact.id}"><span class="status-badge status-${contact.status.replace(/ /g, '-')}" onclick="openCardStatusMenu(${contact.id}, event)">${statusOption.label}</span></span>
                        </div>
                    </div>
                    ${opsMini}
                    <div class="card-footer">
                        <span><i class="fas fa-calendar"></i> ${new Date(contact.lastUpdated).toLocaleDateString('es-ES')}</span><span title="Última edición"><i class="fas fa-pen"></i> ${editedAtLabel}</span>
                        <button class="btn btn-danger" style="padding: 5px 10px; font-size: 0.75rem;" onclick="deleteContact(${contact.id}, event)"><i class="fas fa-trash"></i></button>
                    </div>
                </div>
            `;
        }

        function createListItem(contact) {
            const statusOption = getStatusOption(contact.status);
            const escapedName = (contact.name || '').replace(/'/g, "\\'");
            const escapedPhone = (contact.phone || '').replace(/'/g, "\\'");
            const sentBadge = getMessageSentBadge(contact);
            const opsMini = getOpsMiniHtml(contact);
            const editedAtLabel = contact.lastEditedAt ? new Date(contact.lastEditedAt).toLocaleString('es-ES') : '-';
            
            return `
                <div class="list-item ${AppState.selectedContacts.has(contact.id) ? 'selected' : ''} ${contact.isDuplicate ? 'duplicate' : ''}" style="--status-rgb: ${statusOption.rgb};" data-id="${contact.id}">
                    <div><input type="checkbox" ${AppState.selectedContacts.has(contact.id) ? 'checked' : ''}></div>
                    <div class="list-item-name list-item-main" style="--status-color: ${statusOption.color}; --status-rgb: ${statusOption.rgb};">
                        <i class="fas ${statusOption.icon} list-status-bg-icon"></i>
                        <div class="list-name-row">
                            <span onclick="copyToClipboard('${escapedName}', event)" style="flex: 1; cursor: pointer;" title="Click para copiar">
                                ${contact.isDuplicate ? '<i class=\"fas fa-exclamation-triangle\" style=\"color: var(--accent-warning);\"></i> ' : ''}${contact.name}${AppState.currentView === 'shifts' && contact.assignedShift ? ` <span class=\"shift-tag\">${contact.assignedShift.toUpperCase()}</span>` : ''}
                            </span>
                            <button class="btn" style="padding: 4px 8px; font-size: 0.75rem;" onclick="editContactField(${contact.id}, 'name', event)" title="Editar">
                                <i class="fas fa-pencil-alt"></i>
                            </button>
                        </div>
                        <span class="list-status-chip"><i class="fas ${statusOption.icon}"></i>${statusOption.label}</span>${opsMini}
                    </div>
                    <div class="list-item-phone">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span onclick="copyToClipboard('${escapedPhone}', event)" style="flex: 1; font-family: monospace; cursor: pointer;" title="Click para copiar">${contact.phone || 'Sin teléfono'}</span>
                            <button class="btn" style="padding: 4px 8px; font-size: 0.75rem;" onclick="editContactField(${contact.id}, 'phone', event)" title="${contact.phone ? 'Editar' : 'Agregar teléfono'}">
                                <i class="fas fa-pencil-alt"></i>
                            </button>
                        </div>
                    </div>
                    <div class="list-item-origin">${contact.origin}</div>
                    <div class="list-item-date" title="Última edición: ${editedAtLabel}">${new Date(contact.lastUpdated).toLocaleDateString('es-ES')}<br><small style="color:var(--text-secondary);">✎ ${editedAtLabel.split(',')[0] || editedAtLabel}</small></div>
                    <div class="whatsapp-cell">
                        ${contact.phone ? `
                            <button class="btn whatsapp-btn" onclick="openWhatsApp('${escapedPhone}', event)" title="Abrir WhatsApp">
                                <i class="fab fa-whatsapp"></i>
                            </button>
                            ${sentBadge}
                        ` : '<span style="color: var(--text-secondary); font-size: 0.8rem;">-</span>'}
                    </div>
                    <div class="status-buttons">
                        <button class="status-btn sin-revisar ${contact.status === 'sin revisar' ? 'active' : ''}" 
                                onclick="changeContactStatus(${contact.id}, 'sin revisar', event)" 
                                title="Sin Revisar">
                            <i class="fas fa-circle"></i>
                        </button>
                        <button class="status-btn contactado ${contact.status === 'contactado' ? 'active' : ''}" 
                                onclick="changeContactStatus(${contact.id}, 'contactado', event)" 
                                title="Contactado">
                            <i class="fas fa-check"></i>
                        </button>
                        <button class="status-btn revisado ${contact.status === 'revisado' ? 'active' : ''}" 
                                onclick="changeContactStatus(${contact.id}, 'revisado', event)" 
                                title="Revisado">
                            <i class="fas fa-user-check"></i>
                        </button>
                        <button class="status-btn jugando ${contact.status === 'jugando' ? 'active' : ''}" 
                                onclick="changeContactStatus(${contact.id}, 'jugando', event)" 
                                title="Jugando">
                            <i class="fas fa-gamepad"></i>
                        </button>
                        <button class="status-btn sin-wsp ${contact.status === 'sin wsp' ? 'active' : ''}" 
                                onclick="changeContactStatus(${contact.id}, 'sin wsp', event)" 
                                title="Sin WhatsApp">
                            <i class="fas fa-ban"></i>
                        </button>
                        <button class="status-btn no-interesado ${contact.status === 'no interesado' ? 'active' : ''}" 
                                onclick="changeContactStatus(${contact.id}, 'no interesado', event)" 
                                title="No Interesado">
                            <i class="fas fa-times"></i>
                        </button>
                        <button class="btn" style="padding: 0; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center;" onclick="openContactHistory(${contact.id}, event)" title="Historial por usuario"><i class="fas fa-id-card"></i></button>
                        <button class="btn btn-danger" style="padding: 0; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center;" onclick="deleteContact(${contact.id}, event)" title="Eliminar">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `;
        }

        function renderPaginatedView(renderFunc) {
            const start = (AppState.currentPage - 1) * AppState.itemsPerPage;
            const end = start + AppState.itemsPerPage;
            const pageContacts = AppState.filteredContacts.slice(start, end);
            
            if (pageContacts.length === 0 && AppState.filteredContacts.length > 0 && AppState.currentPage > 1) {
                AppState.currentPage = 1;
                renderPaginatedView(renderFunc);
                return;
            }
            
            if (AppState.currentView === 'cards') {
                elements.cardsView.innerHTML = pageContacts.length > 0 
                    ? pageContacts.map(renderFunc).join('') 
                    : '<div style="text-align: center; padding: 50px; color: var(--text-secondary); grid-column: 1 / -1;">No se encontraron contactos</div>';
            } else {
                const listItems = pageContacts.map(renderFunc).join('');
                elements.listView.innerHTML = `
                    <div class="list-header">
                        <div><input type="checkbox" id="selectAllCheckbox"></div>
                        <div>Nombre</div>
                        <div>Teléfono</div>
                        <div>Origen</div>
                        <div>Fecha</div>
                        <div>WhatsApp</div>
                        <div>Acciones</div>
                    </div>
                    ${listItems || '<div style="text-align: center; padding: 50px; color: var(--text-secondary); grid-column: 1 / -1;">No se encontraron contactos</div>'}
                `;
                
                const selectAllCheckbox = $('#selectAllCheckbox');
                if (selectAllCheckbox) {
                    const areAllOnPageSelected = pageContacts.length > 0 && pageContacts.every(c => AppState.selectedContacts.has(c.id));
                    selectAllCheckbox.checked = areAllOnPageSelected;
                    selectAllCheckbox.onchange = (e) => {
                        pageContacts.forEach(c => {
                            if (e.target.checked) AppState.selectedContacts.add(c.id);
                            else AppState.selectedContacts.delete(c.id);
                        });
                        renderPaginatedView(createListItem);
                        updateBulkActionsBar();
                    };
                }
            }
            
            renderPagination();
        }

        function renderPagination() {
            const totalPages = Math.ceil(AppState.filteredContacts.length / AppState.itemsPerPage);
            if (totalPages <= 1) {
                elements.pagination.innerHTML = '';
                return;
            }
            let html = '';
            
            html += `<button ${AppState.currentPage === 1 ? 'disabled' : ''} onclick="changePage(${AppState.currentPage - 1})"><i class="fas fa-chevron-left"></i></button>`;
            
            const pagesToShow = [];
            pagesToShow.push(1);
            if (AppState.currentPage > 4) pagesToShow.push('...');
            for (let i = Math.max(2, AppState.currentPage - 2); i <= Math.min(totalPages - 1, AppState.currentPage + 2); i++) {
                pagesToShow.push(i);
            }
            if (AppState.currentPage < totalPages - 3) pagesToShow.push('...');
            if(totalPages > 1) pagesToShow.push(totalPages);

            const uniquePages = [...new Set(pagesToShow)];

            uniquePages.forEach(p => {
                if (p === '...') {
                    html += '<span class="page-info">...</span>';
                } else {
                    html += `<button class="${p === AppState.currentPage ? 'active' : ''}" onclick="changePage(${p})">${p}</button>`;
                }
            });

            html += `<button ${AppState.currentPage === totalPages ? 'disabled' : ''} onclick="changePage(${AppState.currentPage + 1})"><i class="fas fa-chevron-right"></i></button>`;
            html += `<span class="page-info">Página ${AppState.currentPage} de ${totalPages} (${AppState.filteredContacts.length} contactos)</span>`;
            
            elements.pagination.innerHTML = html;
        }

        window.changePage = (page) => {
            if (page < 1 || page > Math.ceil(AppState.filteredContacts.length / AppState.itemsPerPage)) return;
            AppState.currentPage = page;
            if (AppState.currentView === 'shifts') {
                elements.cardsView.style.display = 'none';
                elements.listView.style.display = 'none';
                elements.pagination.style.display = 'none';
                renderShiftsView();
            } else {
                elements.shiftsView.style.display = 'none';
                renderPaginatedView(AppState.currentView === 'cards' ? createCard : createListItem);
            }
        };

        window.deleteContact = (id, event) => {
            if (event) event.stopPropagation();
            const contact = AppState.contacts.find(c => c.id === id);
            if (contact && confirm(`¿Eliminar "${contact.name}"?`)) {
                AppState.contacts = AppState.contacts.filter(c => c.id !== id);
                AppState.selectedContacts.delete(id);
                addToHistory('Contacto eliminado', contact.name);
                saveData();
                render();
                showNotification('Contacto eliminado', 'success');
            }
        };

        window.copyToClipboard = (text, event) => {
            if (event) event.stopPropagation();
            navigator.clipboard.writeText(text).then(() => {
                showNotification(`✓ Copiado: ${text}`, 'success');
            }).catch(() => {
                showNotification('Error al copiar', 'error');
            });
        };


        window.changeContactStatus = (id, newStatus, event, source = 'common') => {
            try {
            if (event) event.stopPropagation();
            const contact = AppState.contacts.find(c => c.id === id);
            if (!contact) return;

            const oldStatus = contact.status;
            let requestedStatus = applyRecontactAutopolicy(contact, newStatus);
            if (contact.ops?.suggestedStatus) {
                requestedStatus = getHigherPriorityStatus(requestedStatus, contact.ops.suggestedStatus);
            }
            if (oldStatus === requestedStatus) {
                const moved = updateCompetitionCredit(contact, requestedStatus, source, { forceTransfer: true });
                if (!moved) return;
                touchContactEdit(contact, source === 'shift' ? 'turno_transfer' : 'status_transfer');
                addToHistory('Crédito de competencia transferido', `${contact.name}: ahora cuenta para ${String(contact.shiftReviewedByShift || '-').toUpperCase()}`, contact.id);
                setSaveState('pending', 'Guardando cambios...');
                saveData();
                render();
                return;
            }

            contact.status = requestedStatus;
            updateCompetitionCredit(contact, requestedStatus, source);
            try { setReviewMetadata(contact, requestedStatus); } catch (e) { console.error('Error metadata estado:', e); }
            touchContactEdit(contact, source === 'shift' ? 'turno_status' : 'status_change');
            AppState.lastEditedContact = id;
            const policyNote = (requestedStatus !== newStatus && requestedStatus === 'sin wsp') ? ' (autopolítica 3 recontactos)' : '';
            addToHistory('Estado cambiado', `${contact.name}: ${oldStatus} → ${requestedStatus}${policyNote}`, contact.id);
            if (oldStatus === 'sin revisar' && requestedStatus !== 'sin revisar') {
                try {
                    ensureReviewMilestonesState();
                    AppState.reviewPositiveCounter += 1;
                    const milestones = [100, 250, 500, 1000, 1500, 2500, 5000];
                    const nearest = milestones.find(v => v === AppState.reviewPositiveCounter);
                    if (nearest && !AppState.reviewMilestonesShown[nearest]) {
                        AppState.reviewMilestonesShown[nearest] = true;
                        const msg = `🚀 Tremendo laburo: ${nearest} usuarios revisados.`;
                        showNotification(msg, 'success');
                    }
                } catch (moralErr) {
                    console.warn('No se pudo procesar notificación motivacional:', moralErr);
                }
            }
            if (policyNote) announceGeneral('Autopolítica aplicada: 3 recontactos sin respuesta → sin WhatsApp.', 'warn', 3000);
            setSaveState('pending', 'Guardando cambios...');
            saveData();
            render();
            } catch (statusErr) {
                console.error('Error al cambiar estado:', statusErr);
                showNotification(`No se pudo cambiar estado: ${statusErr?.message || statusErr}`, 'error');
            }
        };

        window.applyOpsSuggestion = (id, event) => {
            if (event) event.stopPropagation();
            const contact = AppState.contacts.find(c => c.id === id);
            if (!contact || !contact.ops?.suggestedStatus) return;
            changeContactStatus(id, contact.ops.suggestedStatus);
            showNotification(`Sugerencia aplicada a ${contact.name}`, 'success');
        };

        window.pinContact = (id, event) => {
            if (event) event.stopPropagation();
            const contact = AppState.contacts.find(c => c.id === id);
            if (!contact) return;
            contact.pinned = !contact.pinned;
            touchContactEdit(contact, 'pin_toggle');
            saveData();
            render();
        };

        window.editContactField = (id, field, event) => {
            if (event) event.stopPropagation();
            const contact = AppState.contacts.find(c => c.id === id);
            if (!contact) return;
            openAddSingleModalForEdit(contact, field);
        };

        function undoToLastContact() {
            if (AppState.lastEditedContact) {
                const contact = AppState.contacts.find(c => c.id === AppState.lastEditedContact);
                if (contact) {
                    elements.searchInput.value = contact.name;
                    AppState.searchTerm = contact.name;
                    render();
                    showNotification(`📍 Mostrando: ${contact.name}`, 'info');
                } else {
                    showNotification('El último contacto editado ya no existe', 'error');
                }
            } else {
                showNotification('No hay contactos editados recientemente', 'info');
            }
        }

        function loadPreferences() {
            try {
                const tpl = localStorage.getItem('whatsappTemplate');
                if (tpl) AppState.whatsappTemplate = tpl;
                const mode = localStorage.getItem('duplicateMergeMode');
                if (mode) AppState.duplicateMergeMode = mode;
                const lastAutoDl = parseInt(localStorage.getItem('lastAutoBackupDownloadAt') || '0', 10);
                if (!Number.isNaN(lastAutoDl) && lastAutoDl > 0) AppState.lastAutoDownloadAt = lastAutoDl;
                const sig = localStorage.getItem('lastAutoBackupSignature') || '';
                if (sig) AppState.lastAutoBackupSignature = sig;
                AppState.lastImportBatchId = localStorage.getItem('lastImportBatchId') || '';
                AppState.previousImportBatchId = localStorage.getItem('previousImportBatchId') || '';
                AppState.lastImportFileName = localStorage.getItem('lastImportFileName') || '';
                const profilesRaw = localStorage.getItem('nexoProfiles');
                if (profilesRaw) { try { AppState.profiles = JSON.parse(profilesRaw); } catch (_) {} }
                AppState.activeProfileId = localStorage.getItem('activeProfileId') || AppState.activeProfileId || 'default';
                AppState.splitImportByFile = localStorage.getItem('splitImportByFile') === '1';
                const operatorName = localStorage.getItem('operatorName');
                if (operatorName) AppState.operatorName = operatorName;
                const backupMode = localStorage.getItem('autoBackupStorageMode');
                if (backupMode === 'download' || backupMode === 'file' || backupMode === 'ask') {
                    AppState.autoBackupStorageMode = backupMode === 'ask' ? 'download' : backupMode;
                } else {
                    AppState.autoBackupStorageMode = 'download';
                }
            } catch (e) {
                console.error('Error al cargar preferencias:', e);
            }
            if (elements.whatsappTemplateInput) {
                elements.whatsappTemplateInput.value = AppState.whatsappTemplate;
            }
        }

        function savePreferences() {
            try {
                localStorage.setItem('whatsappTemplate', AppState.whatsappTemplate);
                localStorage.setItem('duplicateMergeMode', AppState.duplicateMergeMode);
                localStorage.setItem('nexoProfiles', JSON.stringify(AppState.profiles || []));
                localStorage.setItem('activeProfileId', AppState.activeProfileId || 'default');
                localStorage.setItem('splitImportByFile', AppState.splitImportByFile ? '1' : '0');
                localStorage.setItem('operatorName', AppState.operatorName || 'PC local');
            } catch (e) {
                console.error('Error al guardar preferencias:', e);
            }
        }

        function buildWhatsAppMessage(contactName) {
            const base = (AppState.whatsappTemplate || '').trim();
            return base.replaceAll('{usuario}', contactName || '');
        }

        function getDuplicateReason(group) {
            if (group.type === 'teléfono') return 'Mismo teléfono';
            if (group.type === 'nombre') return 'Nombre coincidente';
            return 'Coincidencia múltiple';
        }

        function renderDuplicatePreview(group) {
            let result = { ...group.contacts[0] };
            for (let i = 1; i < group.contacts.length; i++) {
                result = mergeContact(result, group.contacts[i]);
            }
            return `${result.name || '-'} | ${result.phone || 'Sin teléfono'} | ${result.status || 'sin revisar'} | ${result.origin || '-'}`;
        }

        window.openWhatsApp = async (phone, event) => {
            if (event) event.stopPropagation();
            if (!phone) {
                showNotification('Este contacto no tiene teléfono', 'error');
                return;
            }
            const normalized = normalizePhoneToE164(phone);
            if (!normalized) {
                showNotification('Teléfono inválido', 'error');
                return;
            }
            const contact = AppState.contacts.find(c => normalizePhoneToE164(c.phone) === normalized);
            const message = buildWhatsAppMessage(contact?.name || '');
            const waMe = `https://wa.me/${normalized}${message ? `?text=${encodeURIComponent(message)}` : ''}`;
            const fallback = `https://api.whatsapp.com/send?phone=${normalized}${message ? `&text=${encodeURIComponent(message)}` : ''}`;
            try {
                if (window.electronAPI && window.electronAPI.openExternal) {
                    await window.electronAPI.openExternal(waMe);
                } else {
                    window.open(waMe, '_blank');
                }
            } catch (_) {
                await window.electronAPI.openExternal(fallback);
            }
            if (contact) {
                contact.lastMessageSentAt = new Date().toISOString();
                touchContactEdit(contact, 'whatsapp_open');
                saveData();
                render();
            }
            addToHistory('WhatsApp abierto', `${contact?.name || normalized}`);
            saveHistory();
        };

        window.openCardStatusMenu = (id, event) => {
            if (event) event.stopPropagation();
            const contact = AppState.contacts.find(c => c.id === id);
            const container = document.getElementById(`cardStatusInline-${id}`);
            if (!contact || !container) return;

            const existingMenu = container.querySelector('.card-status-menu');
            if (existingMenu) {
                existingMenu.remove();
                return;
            }

            $$('.card-status-menu').forEach(menu => menu.remove());

            const menu = document.createElement('div');
            menu.className = 'card-status-menu';
            menu.onclick = (e) => e.stopPropagation();
            menu.innerHTML = STATUS_OPTIONS.map(opt => `
                <button class="card-status-option ${opt.id === contact.status ? 'active' : ''}" data-status="${opt.id}">
                    <i class="fas ${opt.icon}" style="color:${opt.color}"></i>
                    <span>${opt.label}</span>
                </button>
            `).join('');

            menu.querySelectorAll('.card-status-option').forEach(btn => {
                btn.onclick = (e) => {
                    e.stopPropagation();
                    const next = btn.dataset.status;
                    if (next !== contact.status) {
                        const old = contact.status;
                        contact.status = next;
                        updateCompetitionCredit(contact, next, 'common');
                        setReviewMetadata(contact, next);
                        touchContactEdit(contact, 'inline_status');
                        AppState.lastEditedContact = id;
                        addToHistory('Estado cambiado', `${contact.name}: ${old} → ${next}`);
                        saveData();
                    }
                    menu.remove();
                    render();
                };
            });

            container.appendChild(menu);

            setTimeout(() => {
                const closeMenu = (evt) => {
                    if (!container.contains(evt.target)) menu.remove();
                    document.removeEventListener('click', closeMenu, true);
                };
                document.addEventListener('click', closeMenu, true);
            }, 0);
        };

        function updateBulkActionsBar() {
            if (AppState.selectedContacts.size > 0) {
                elements.bulkActionsBar.classList.add('active');
                elements.selectedCount.textContent = AppState.selectedContacts.size;
            } else {
                elements.bulkActionsBar.classList.remove('active');
            }
        }

        function render() {
            const isShiftsView = AppState.currentView === 'shifts';
            elements.mainApp.classList.toggle('shifts-mode', isShiftsView);

            if (isShiftsView) {
                updateStats();
                elements.pagination.style.display = 'none';
                elements.cardsView.style.display = 'none';
                elements.listView.style.display = 'none';
                renderShiftsView();
                updateBulkActionsBar();
                updateOpsUploadReminder();
                return;
            }

            elements.quickReview.style.display = 'none';
            AppState.activeShift = null;
            applyFilters();
            AppState.filteredContacts.sort((a, b) => {
                if (!!a.pinned !== !!b.pinned) return a.pinned ? -1 : 1;
                if (AppState.opsFilter === 'top50' || AppState.opsFilter === 'top100') return (b.ops?.score || 0) - (a.ops?.score || 0);
                buildContactDerivedFields(a);
                buildContactDerivedFields(b);
                return (a._nameKey || '').localeCompare(b._nameKey || '');
            });
            updateStats();
            elements.pagination.style.display = 'flex';
            elements.shiftsView.style.display = 'none';
            renderPaginatedView(AppState.currentView === 'cards' ? createCard : createListItem);
            updateBulkActionsBar();
            updateOpsUploadReminder();
        }

        function showDuplicatesModal() {
            const duplicates = detectDuplicates();
            
            if (duplicates.length === 0) {
                $('#duplicatesContent').innerHTML = '<p style="color: var(--accent-success); text-align: center; padding: 30px;">✅ No se encontraron duplicados</p>';
                $('#mergeAllDuplicates').style.display = 'none';
            } else {
                let html = `<div class="duplicates-list">`;
                duplicates.forEach((group, groupIndex) => {
                    html += `<div class="duplicate-group">`;
                    html += `<div class="duplicate-group-header">
                        <span>📋 ${group.name} (${group.contacts.length} entradas - ${group.type})</span><span style="font-size:0.78rem;color:var(--text-secondary);">${getDuplicateReason(group)}</span>
                    </div>`;
                    
                    group.contacts.forEach((contact, contactIndex) => {
                        const isRecommended = contactIndex === 0; // El primero es el recomendado por defecto
                        html += `<div class="duplicate-item" style="display: flex; align-items: center; justify-content: space-between; padding: 12px; ${isRecommended ? 'border: 2px solid var(--accent-primary);' : ''}">
                            <div style="flex: 1;">
                                <strong>${contact.name}</strong>
                                <div class="duplicate-item-detail">
                                    📞 ${contact.phone || 'Sin teléfono'} | 
                                    📍 ${contact.origin} | 
                                    🔵 <span class="status-badge status-${contact.status.replace(/ /g, '-')}">${contact.status}</span>
                                </div>
                            </div>
                            <div style="display: flex; gap: 8px; align-items: center;">
                                ${isRecommended ? '<span style="color: var(--accent-primary); font-size: 0.8rem; font-weight: 600;">RECOMENDADO</span>' : ''}
                                <button class="btn" style="padding: 6px 12px; font-size: 0.8rem;" onclick="selectDuplicateToKeep(${groupIndex}, ${contactIndex})" title="Mantener este">
                                    <i class="fas fa-check"></i> Elegir
                                </button>
                            </div>
                        </div>`;
                    });
                    html += `<div style="margin-top:8px;display:flex;flex-wrap:wrap;gap:8px;align-items:center;">
                        <button class="btn btn-success" style="padding:6px 10px;font-size:0.8rem;" onclick="combineDuplicateGroup(${groupIndex})"><i class="fas fa-object-group"></i> Combinar</button>
                        <span style="font-size:0.78rem;color:var(--text-secondary);"><strong>Preview:</strong> ${renderDuplicatePreview(group)}</span>
                    </div></div>`;
                });
                html += `</div>`;
                const totalEntries = duplicates.reduce((acc, g) => acc + g.contacts.length, 0);
                html += `<p style="color: var(--accent-warning); margin-top: 15px; text-align: center;">
                    Se encontraron ${duplicates.length} grupos duplicados con ${totalEntries} entradas totales
                </p>
                <p style="color: var(--text-secondary); font-size: 0.9rem; margin-top: 10px; text-align: center;">
                    <strong>Criterio de fusión automática:</strong> jugando > contactado > sin wsp > sin revisar > no interesado
                </p>
                <div class="duplicates-config">
                    <label><input type="radio" name="dupMergeMode" value="phone-auto" ${AppState.duplicateMergeMode === 'phone-auto' ? 'checked' : ''}> Si coincide teléfono: merge seguro. Si coincide nombre: pedir confirmación.</label>
                    <label><input type="radio" name="dupMergeMode" value="always-ask" ${AppState.duplicateMergeMode === 'always-ask' ? 'checked' : ''}> Pedir confirmación para todos los grupos.</label>
                </div>`;
                
                $('#duplicatesContent').innerHTML = html;
                $('#mergeAllDuplicates').style.display = 'block';
            }
            
            $('#duplicatesModal').classList.add('active');
        }
        
        window.selectDuplicateToKeep = (groupIndex, contactIndex) => {
            const group = AppState.duplicates[groupIndex];
            if (!group) return;
            
            const selectedContact = group.contacts[contactIndex];
            const contactsToRemove = group.contacts.filter((c, i) => i !== contactIndex);
            
            const idsToRemove = contactsToRemove.map(c => c.id);
            AppState.contacts = AppState.contacts.filter(c => !idsToRemove.includes(c.id));
            
            addToHistory('Duplicado resuelto manualmente', `${selectedContact.name} - mantenido, ${contactsToRemove.length} eliminados`);
            saveData();
            render();
            showDuplicatesModal();
            showNotification(`✅ Duplicados resueltos para ${selectedContact.name}`, 'success');
        };

        window.combineDuplicateGroup = (groupIndex) => {
            const group = AppState.duplicates[groupIndex];
            if (!group || group.contacts.length < 2) return;
            const preview = renderDuplicatePreview(group);
            const needsConfirm = AppState.duplicateMergeMode === 'always-ask' || group.type === 'nombre';
            if (needsConfirm && !confirm(`Combinar este grupo?\nResultado estimado:\n${preview}`)) return;

            let masterContact = { ...group.contacts[0] };
            for (let i = 1; i < group.contacts.length; i++) {
                masterContact = mergeContact(masterContact, group.contacts[i]);
            }
            const idsToRemove = group.contacts.map(c => c.id);
            AppState.contacts = AppState.contacts.filter(c => !idsToRemove.includes(c.id));
            AppState.contacts.push(masterContact);
            addToHistory('Duplicado combinado', `${group.name} -> ${masterContact.name}`);
            saveData();
            render();
            showDuplicatesModal();
            showNotification('Grupo combinado correctamente', 'success');
        };

        function mergeAllDuplicates() {
            const duplicates = AppState.duplicates;
            let mergedCount = 0;
            
            duplicates.forEach(group => {
                if (group.contacts.length > 1) {
                    const needsConfirm = AppState.duplicateMergeMode === 'always-ask' || (AppState.duplicateMergeMode === 'phone-auto' && group.type === 'nombre');
                    if (needsConfirm && !confirm(`Confirmar fusión para grupo: ${group.name}`)) return;
                    let masterContact = { ...group.contacts[0] };
                    
                    for (let i = 1; i < group.contacts.length; i++) {
                        masterContact = mergeContact(masterContact, group.contacts[i]);
                    }
                    
                    const idsToRemove = group.contacts.map(c => c.id);
                    AppState.contacts = AppState.contacts.filter(c => !idsToRemove.includes(c.id));
                    AppState.contacts.push(masterContact);
                    
                    mergedCount += group.contacts.length - 1;
                }
            });
            
            addToHistory('Duplicados fusionados', `${mergedCount} duplicados fusionados`);
            saveData();
            render();
            $('#duplicatesModal').classList.remove('active');
            showNotification(`✅ ${mergedCount} duplicados fusionados`, 'success');
        }

        function extractHistoryName(details = '') {
            const [raw] = details.split(':');
            return (raw || '').trim();
        }

        function getHistoryContact(name = '') {
            if (!name) return null;
            return AppState.contacts.find(c => normalizeUsername(c.name) === normalizeUsername(name));
        }

        function goToHistoryContact(name, event) {
            if (event) event.stopPropagation();
            const contact = getHistoryContact(name);
            if (!contact) {
                showNotification('Contacto no disponible en la base actual', 'info');
                return;
            }
            elements.searchInput.value = contact.name;
            AppState.searchTerm = contact.name;
            AppState.lastEditedContact = contact.id;
            closeAllOverlays();
            render();
            showNotification(`🔎 Mostrando: ${contact.name}`, 'success');
        }

        window.searchFromHistory = (name, event) => {
            goToHistoryContact(name, event);
        };

        window.editFromHistory = (name, event) => {
            if (event) event.stopPropagation();
            const contact = getHistoryContact(name);
            if (!contact) {
                showNotification('No se pudo abrir el editor: contacto no encontrado', 'error');
                return;
            }
            editContactField(contact.id, 'name');
        };

        window.openContactHistoryByName = (name, event) => {
            if (event) event.stopPropagation();
            const contact = getHistoryContact(name);
            if (!contact) {
                showNotification('No se encontró historial del usuario', 'warning');
                return;
            }
            openContactHistory(contact.id);
        };

        window.openContactHistory = (contactId, event) => {
            if (event) event.stopPropagation();
            const contact = AppState.contacts.find(c => c.id === contactId);
            if (!contact) {
                showNotification('Contacto no encontrado', 'warning');
                return;
            }
            const timeline = Array.isArray(contact.timeline) ? contact.timeline : [];
            const html = timeline.length ? timeline.map(item => `
                <div class="history-item">
                    <div class="history-time">${new Date(item.timestamp).toLocaleString('es-ES')}</div>
                    <div class="history-action"><strong>${item.action}:</strong> ${item.details}</div>
                </div>
            `).join('') : '<p style="text-align:center;color:var(--text-secondary);padding:24px;">Sin historial específico para este usuario.</p>';
            if (elements.contactHistoryMeta) {
                elements.contactHistoryMeta.textContent = `${contact.name} · ${timeline.length} evento(s)`;
            }
            if (elements.contactHistoryList) elements.contactHistoryList.innerHTML = html;
            if (elements.contactHistoryModal) elements.contactHistoryModal.classList.add('active');
        };

        function renderHistoryList(filterTerm = '') {
            const term = normalizeUsername(filterTerm);
            const filtered = AppState.history.filter(entry => {
                if (!term) return true;
                return normalizeUsername(`${entry.action} ${entry.details}`).includes(term);
            });

            const historyHTML = filtered.length > 0
                ? filtered.map(entry => {
                    const userName = extractHistoryName(entry.details);
                    const contact = getHistoryContact(userName);

                    return `
                    <div class="history-item ${contact ? '' : 'history-item-muted'}">
                        <div class="history-time">${new Date(entry.timestamp).toLocaleString('es-ES')}</div>
                        <div class="history-action"><strong>${entry.action}:</strong> ${entry.details}</div><div class="history-item-muted">por: ${entry.actor || 'PC local'}</div>
                        <div class="history-item-actions">
                            <button class="btn" onclick="searchFromHistory('${userName.replace(/'/g, "\\'")}', event)"><i class="fas fa-search"></i> Ver</button>
                            <button class="btn" onclick="editFromHistory('${userName.replace(/'/g, "\\'")}', event)" ${contact ? '' : 'disabled'}><i class="fas fa-pen"></i> Editar</button>
                            <button class="btn" onclick="openContactHistoryByName('${userName.replace(/'/g, "\\'")}', event)" ${contact ? '' : 'disabled'}><i class="fas fa-id-card"></i> Historial</button>
                        </div>
                    </div>
                `;
                }).join('')
                : '<p style="text-align: center; color: var(--text-secondary); padding: 30px;">No hay historial para ese filtro.</p>';

            $('#historyList').innerHTML = historyHTML;
            const label = $('#historyCountLabel');
            if (label) label.textContent = `${filtered.length} evento(s)`;
        }

        function showHistoryModal() {
            renderHistoryList('');
            const historySearchInput = $('#historySearchInput');
            if (historySearchInput) {
                historySearchInput.value = '';
                historySearchInput.oninput = (e) => renderHistoryList(e.target.value);
            }
            $('#historyModal').classList.add('active');
        }

        function closeAllOverlays() {
            const addSingleWasOpen = $('#addSingleModal')?.classList.contains('active');
            $$('.modal.active').forEach(modal => modal.classList.remove('active'));
            $$('.card-status-menu').forEach(menu => menu.remove());
            if (addSingleWasOpen) resetAddSingleModalState();
        }

        function openAddSingleModalForCreate() {
            AppState.editingContactId = null;
            refreshOriginSuggestions();
            $('#singleName').value = '';
            $('#singlePhone').value = '';
            $('#singleOrigin').value = '';
            $('#singleStatus').value = 'sin revisar';
            $('#addSingleModal .modal-header').innerHTML = '<i class="fas fa-user-plus"></i> Agregar Contacto';
            $('#confirmAddSingle').innerHTML = '<i class="fas fa-check"></i> Agregar';
            $('#addSingleModal').classList.add('active');
        }

        function openAddSingleModalForEdit(contact, focusField = 'name') {
            if (!contact) return;
            refreshOriginSuggestions();
            AppState.editingContactId = contact.id;
            $('#singleName').value = contact.name || '';
            $('#singlePhone').value = contact.phone || '';
            $('#singleOrigin').value = contact.origin || '';
            $('#singleStatus').value = contact.status || 'sin revisar';
            $('#addSingleModal .modal-header').innerHTML = '<i class="fas fa-user-edit"></i> Editar Contacto';
            $('#confirmAddSingle').innerHTML = '<i class="fas fa-save"></i> Guardar cambios';
            $('#addSingleModal').classList.add('active');
            const focusEl = focusField === 'phone' ? $('#singlePhone') : $('#singleName');
            if (focusEl) {
                focusEl.focus();
                focusEl.select();
            }
        }

        function resetAddSingleModalState() {
            AppState.editingContactId = null;
            $('#addSingleModal .modal-header').innerHTML = '<i class="fas fa-user-plus"></i> Agregar Contacto';
            $('#confirmAddSingle').innerHTML = '<i class="fas fa-check"></i> Agregar';
        }


        function setLoadingState(active, message = 'Cargando…', progress = null, cancelable = false) {
            if (!elements.appLoadingOverlay) return;
            elements.appLoadingOverlay.classList.toggle('active', !!active);
            if (elements.appLoadingText) elements.appLoadingText.textContent = message;
            if (elements.appLoadingProgress) elements.appLoadingProgress.style.width = `${Math.max(0, Math.min(100, progress ?? 0))}%`;
            if (elements.cancelImportBtn) elements.cancelImportBtn.style.display = cancelable ? 'inline-flex' : 'none';
        }

        function perfMark(label, fn) {
            if (!AppState.perfDebug) return fn();
            const tag = `[perf] ${label}`;
            console.time(tag);
            const result = fn();
            if (result && typeof result.then === 'function') {
                return result.finally(() => console.timeEnd(tag));
            }
            console.timeEnd(tag);
            return result;
        }

        function normalizePhoneToE164(raw) {
            const digits = String(raw || '').replace(/\D/g, '');
            if (!digits) return null;
            if (digits.startsWith('549') && digits.length >= 12) return digits;
            if (digits.startsWith('54') && digits.length >= 10) {
                if (digits[2] !== '9') return `549${digits.slice(2)}`;
                return digits;
            }
            if (digits.startsWith('0') && digits.length >= 10) {
                const noZero = digits.replace(/^0+/, '');
                return noZero.startsWith('9') ? `54${noZero}` : `549${noZero}`;
            }
            if (digits.length >= 10 && digits.length <= 11) return digits.startsWith('9') ? `54${digits}` : `549${digits}`;
            if (digits.length >= 8) return digits;
            return null;
        }

        function parseContactsInWorker(fileName, text, onProgress) {
            return new Promise((resolve, reject) => {
                const started = Date.now();
                let worker;
                try {
                    const workerUrl = new URL('./csv-worker.js', window.location.href);
                    worker = new Worker(workerUrl, { type: 'classic' });
                } catch (createErr) {
                    console.warn('[import] Worker URL fallback:', createErr);
                    try {
                        worker = new Worker('csv-worker.js');
                    } catch (fallbackErr) {
                        return reject(new Error(`No se pudo crear el worker de importación: ${fallbackErr?.message || fallbackErr}`));
                    }
                }

                worker.onmessage = (event) => {
                    const msg = event.data || {};
                    if (msg.type === 'progress') onProgress && onProgress(msg.payload || msg);
                    if (msg.type === 'done') {
                        worker.terminate();
                        console.info('[import] parse done', { ms: Date.now() - started, rows: (msg.contacts || []).length });
                        resolve(msg.contacts || []);
                    }
                    if (msg.type === 'error') {
                        worker.terminate();
                        reject(new Error(msg.message || 'No se pudo parsear archivo'));
                    }
                };
                worker.onerror = (error) => {
                    worker.terminate();
                    reject(new Error(`Worker error: ${error?.message || error}`));
                };
                console.info('[import] parse start', { fileName, bytes: String(text || '').length });
                worker.postMessage({ fileName, text });
            });
        }

        function setupEventListeners() {
            elements.uploadArea.onclick = () => elements.fileInput.click();
            elements.uploadArea.ondragover = (e) => { e.preventDefault(); elements.uploadArea.style.borderColor = 'var(--accent-primary)'; };
            elements.uploadArea.ondragleave = () => elements.uploadArea.style.borderColor = 'var(--border-color)';
            elements.uploadArea.ondrop = (e) => {
                e.preventDefault();
                elements.uploadArea.style.borderColor = 'var(--border-color)';
                const files = Array.from(e.dataTransfer.files).filter(f => f.name.toLowerCase().endsWith('.csv') || f.name.toLowerCase().endsWith('.vcf') || f.name.toLowerCase().endsWith('.json'));
                if (files.length > 0) {
                    selectedFiles.push(...files);
                    updateFileList();
                }
            };

            elements.fileInput.onchange = (e) => {
                selectedFiles = Array.from(e.target.files);
                updateFileList();
            };

            elements.startBtn.onclick = loadFiles;
            if (elements.storageMeter) {
                elements.storageMeter.onclick = async () => {
                    await refreshStorageDiagnostics();
                    const info = window.getStorageStatus();
                    showNotification(`📦 ${info}`, 'info');
                };
            }

            elements.addMoreBtn.onclick = () => {
                elements.uploadScreen.classList.remove('hidden');
                elements.fileInput.value = '';
                selectedFiles = [];
                elements.fileList.innerHTML = '';
                elements.startBtn.disabled = true;
            };
            elements.addSingleBtn.onclick = () => {
                openAddSingleModalForCreate();
            };
            elements.settingsBtn.onclick = () => {
                elements.userOptionsModal.classList.add('active');
            };
            if (elements.manageProfilesBtn) {
                elements.manageProfilesBtn.onclick = () => {
                    refreshProfilesUI();
                    elements.profilesModal && elements.profilesModal.classList.add('active');
                };
            }
            if (elements.profileSelect) {
                elements.profileSelect.onchange = (e) => {
                    AppState.activeProfileId = e.target.value || 'default';
                    localStorage.setItem('activeProfileId', AppState.activeProfileId);
                    render();
                };
            }
            if (elements.addProfileBtn) {
                elements.addProfileBtn.onclick = () => {
                    const name = (elements.newProfileName?.value || '').trim();
                    if (!name) {
                        showNotification('Escribí un nombre para el perfil', 'warning');
                        return;
                    }
                    const createdId = ensureProfileByName(name);
                    AppState.activeProfileId = createdId || AppState.activeProfileId;
                    localStorage.setItem('activeProfileId', AppState.activeProfileId);
                    if (elements.newProfileName) elements.newProfileName.value = '';
                    refreshProfilesUI();
                    render();
                    showNotification('Perfil creado y activado', 'success');
                };
            }
            if (elements.closeProfilesModal) elements.closeProfilesModal.onclick = () => elements.profilesModal && elements.profilesModal.classList.remove('active');
            if (elements.splitImportByFileToggle) {
                elements.splitImportByFileToggle.onchange = (e) => {
                    AppState.splitImportByFile = !!e.target.checked;
                    localStorage.setItem('splitImportByFile', AppState.splitImportByFile ? '1' : '0');
                };
            }
            const shortHash = (value) => {
                if (!value) return '';
                const raw = String(value).trim();
                if (raw.length <= 16) return raw;
                return `${raw.slice(0, 10)}…${raw.slice(-6)}`;
            };

            const triggerUpdateCheck = async (from = 'principal') => {
                if (elements.updateStatusText) elements.updateStatusText.textContent = 'Estado: buscando…';
                if (elements.updateProgressFill) elements.updateProgressFill.style.width = '0%';
                showNotification(`Buscando actualizaciones (${from})…`, 'info');
                try {
                    await window.electronAPI.checkForUpdates();
                } catch (error) {
                    showNotification(`No se pudo comprobar actualizaciones: ${error?.message || error}`, 'error');
                }
            };
            if (elements.checkUpdatesBtn && window.electronAPI?.checkForUpdates) {
                elements.checkUpdatesBtn.onclick = async () => {
                    await triggerUpdateCheck('panel principal');
                };
            }
            if (elements.preStartCheckUpdatesBtn && window.electronAPI?.checkForUpdates) {
                elements.preStartCheckUpdatesBtn.onclick = async () => {
                    await triggerUpdateCheck('pantalla inicial');
                };
            }
            if (elements.perfDebugToggle) {
                elements.perfDebugToggle.checked = localStorage.getItem('perfDebugMode') === '1';
                AppState.perfDebug = elements.perfDebugToggle.checked;
                document.body.classList.toggle('perf-mode', AppState.perfDebug);
                elements.perfDebugToggle.onchange = (e) => {
                    AppState.perfDebug = !!e.target.checked;
                    document.body.classList.toggle('perf-mode', AppState.perfDebug);
                    localStorage.setItem('perfDebugMode', AppState.perfDebug ? '1' : '0');
                    showNotification(`Modo debug performance ${AppState.perfDebug ? 'activado' : 'desactivado'}`, 'info');
                };
            }
            if (elements.checkUpdatesOption && window.electronAPI?.checkForUpdates) {
                elements.checkUpdatesOption.onclick = async () => {
                    elements.updateStatusText.textContent = 'Estado: buscando…';
                    if (elements.updateProgressFill) elements.updateProgressFill.style.width = '0%';
                    showNotification('Buscando actualizaciones…', 'info');
                    await window.electronAPI.checkForUpdates();
                };
            }
            if (elements.restartUpdateOption && window.electronAPI?.installUpdate) {
                elements.restartUpdateOption.onclick = async () => {
                    showNotification('Preparando instalación de actualización…', 'info');
                    const firstTry = await window.electronAPI.installUpdate({ force: false });
                    if (firstTry?.ok) {
                        setTimeout(() => window.close(), 120);
                        return;
                    }
                    if (firstTry?.requiresForce) {
                        const agree = confirm(`⚠️ Update sospechosa. ${firstTry.message || ''}

¿Querés forzar igual la instalación?`);
                        if (!agree) return;
                        const forced = await window.electronAPI.installUpdate({ force: true });
                        if (forced?.ok) {
                            showNotification('Forzando instalación de actualización…', 'warning');
                            setTimeout(() => window.close(), 120);
                            return;
                        }
                        showNotification(forced?.message || 'No se pudo instalar actualización', 'error');
                        return;
                    }
                    showNotification(firstTry?.message || 'No se pudo instalar actualización', 'error');
                };
            }
            if (window.electronAPI?.onUpdaterStatus) {
                window.electronAPI.onUpdaterStatus((payload) => {
                    const status = payload?.status;
                    if (!status) return;
                    if (status === 'checking') {
                        elements.updateStatusText.textContent = 'Estado: comprobando…';
                        if (elements.updateProgressFill) elements.updateProgressFill.style.width = '0%';
                    }
                    if (status === 'available') {
                        elements.updateStatusText.textContent = payload.message || 'Descargando actualización…';
                        if (elements.updateProgressFill) elements.updateProgressFill.style.width = '5%';
                        showNotification(payload.message || 'Descargando actualización…', 'info');
                    }
                    if (status === 'download-progress') {
                        elements.updateStatusText.textContent = `Estado: descargando ${payload.percent || 0}%`;
                        if (elements.updateProgressFill) elements.updateProgressFill.style.width = `${payload.percent || 0}%`;
                    }
                    if (status === 'not-available') {
                        elements.updateStatusText.textContent = payload.message || 'Estás en la última versión';
                        if (elements.updateProgressFill) elements.updateProgressFill.style.width = '100%';
                        showNotification(payload.message || 'Estás en la última versión', 'success');
                    }
                    if (status === 'suspicious-update') {
                        const issueHash = shortHash(payload.downloadedSha512 || payload.expectedSha512);
                        elements.updateStatusText.textContent = `${payload.message || 'Update sospechosa detectada'}${issueHash ? ` (hash ${issueHash})` : ''}`;
                        if (elements.updateProgressFill) elements.updateProgressFill.style.width = '100%';
                        elements.restartUpdateOption.style.display = 'flex';
                        const titleEl = elements.restartUpdateOption.querySelector('.export-option-title');
                        const descEl = elements.restartUpdateOption.querySelector('.export-option-desc');
                        if (titleEl) titleEl.textContent = 'Forzar actualización';
                        if (descEl) descEl.textContent = 'Instalar bajo tu responsabilidad';
                        showNotification(payload.message || 'Update sospechosa detectada', 'warning');
                    }
                    if (status === 'downloaded') {
                        const updateHash = shortHash(payload.downloadedSha512 || payload.expectedSha512);
                        const hashSummary = updateHash ? ` · hash ${updateHash}` : '';
                        elements.updateStatusText.textContent = `${payload.message || 'Actualización lista. Reiniciar ahora'}${hashSummary}`;
                        if (elements.updateProgressFill) elements.updateProgressFill.style.width = '100%';
                        elements.restartUpdateOption.style.display = 'flex';
                        const titleEl = elements.restartUpdateOption.querySelector('.export-option-title');
                        const descEl = elements.restartUpdateOption.querySelector('.export-option-desc');
                        if (titleEl) titleEl.textContent = 'Reiniciar y actualizar';
                        if (descEl) descEl.textContent = 'Cerrar e instalar actualización';
                        showNotification(payload.message || 'Actualización lista. Reiniciar ahora', 'success');
                    }
                    if (status === 'error') {
                        elements.updateStatusText.textContent = payload.message || 'Error de actualización';
                        if (elements.updateProgressFill) elements.updateProgressFill.style.width = '0%';
                        showNotification(payload.message || 'Error de actualización', 'error');
                    }
                });
            }
            if (elements.cancelImportBtn) {
                elements.cancelImportBtn.onclick = () => {
                    AppState.importCancelRequested = true;
                    showNotification('Cancelando importación…', 'warning');
                };
            }
            if (elements.importOpsBtn) {
                elements.importOpsBtn.onclick = () => elements.opsFileInput && elements.opsFileInput.click();
            }
            if (elements.opsFileInput) {
                elements.opsFileInput.onchange = (e) => {
                    const file = e.target.files && e.target.files[0];
                    importOperationsFile(file);
                    elements.opsFileInput.value = '';
                };
            }
            $('#openShortcutsOption').onclick = () => {
                elements.userOptionsModal.classList.remove('active');
                elements.shortcutsModal.classList.add('active');
            };
            $('#openWhatsappMessageOption').onclick = () => {
                elements.userOptionsModal.classList.remove('active');
                elements.whatsappMessageModal.classList.add('active');
                elements.whatsappTemplateInput.value = AppState.whatsappTemplate;
            };
            if (elements.openGithubReleasesOption) {
                elements.openGithubReleasesOption.onclick = async () => {
                    const url = 'https://github.com/zhinouno-ui/nexo-desktop/releases/latest';
                    try {
                        if (window.electronAPI?.openExternal) await window.electronAPI.openExternal(url);
                        else window.open(url, '_blank');
                    } catch (e) {
                        showNotification('No se pudo abrir GitHub Releases', 'error');
                    }
                };
            }

            if (elements.openStable110Option) {
                elements.openStable110Option.onclick = async () => {
                    const url = 'https://github.com/zhinouno-ui/nexo-desktop/releases/tag/v1.1.10';
                    try {
                        if (window.electronAPI?.openExternal) await window.electronAPI.openExternal(url);
                        else window.open(url, '_blank');
                    } catch (e) {
                        reportError('openStable110Option', e, { url });
                        showNotification('No se pudo abrir la release estable 1.1.10', 'error');
                    }
                };
            }
            if (elements.openErrorLogOption) {
                elements.openErrorLogOption.onclick = async () => {
                    try {
                        if (window.electronAPI?.openErrorLog) {
                            const p = await window.electronAPI.openErrorLog();
                            showNotification(`Log abierto: ${p}`, 'info');
                        } else {
                            showNotification('Log de errores no disponible en este entorno', 'warning');
                        }
                    } catch (e) {
                        reportError('openErrorLogOption', e);
                        showNotification('No se pudo abrir el log de errores', 'error');
                    }
                };
            }
            if (elements.rollbackPreviousOption) {
                elements.rollbackPreviousOption.onclick = async () => {
                    const ok = confirm('¿Querés volver a la versión anterior guardada en cache local?');
                    if (!ok) return;
                    try {
                        const res = await window.electronAPI?.rollbackPreviousVersion?.();
                        if (res?.ok) {
                            showNotification(`Iniciando rollback a ${res.version}…`, 'warning');
                            return;
                        }
                        showNotification(res?.message || 'No hay versión anterior disponible para rollback', 'warning');
                    } catch (e) {
                        reportError('rollbackPreviousOption', e);
                        showNotification(`No se pudo iniciar rollback: ${e?.message || e}`, 'error');
                    }
                };
            }

            if (elements.showQuickMetricsOption) {
                elements.showQuickMetricsOption.onclick = () => {
                    const now = new Date();
                    const today = new Date(now.getFullYear(), now.getMonth(), now.getDate()).toISOString().slice(0, 10);
                    const yesterdayDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() - 1);
                    const yesterday = yesterdayDate.toISOString().slice(0, 10);
                    const dayFromIso = (iso) => (iso ? new Date(iso).toISOString().slice(0, 10) : '');

                    const byShift = { tm: 0, tt: 0, tn: 0 };
                    let editedToday = 0;
                    let editedYesterday = 0;

                    AppState.contacts.forEach((c) => {
                        const day = dayFromIso(c.lastUpdated || c.lastEditedAt || c.lastImportedAt);
                        if (day === today) editedToday++;
                        if (day === yesterday) editedYesterday++;
                        const shiftKey = String(c.shiftReviewedByShift || '').toLowerCase();
                        if (byShift[shiftKey] !== undefined && day === today) byShift[shiftKey]++;
                    });

                    let revToContact = 0;
                    let contactToJugando = 0;
                    (AppState.history || []).forEach((entry) => {
                        const day = dayFromIso(entry.timestamp);
                        if (day !== today) return;
                        const details = String(entry.details || '').toLowerCase();
                        if (details.includes('revisado') && details.includes('→') && details.includes('contactado')) revToContact++;
                        if (details.includes('contactado') && details.includes('→') && details.includes('jugando')) contactToJugando++;
                    });

                    const lastBatchCount = AppState.lastImportBatchId
                        ? AppState.contacts.filter(c => getContactBatchId(c) === AppState.lastImportBatchId).length
                        : 0;
                    const prevBatchCount = AppState.previousImportBatchId
                        ? AppState.contacts.filter(c => getContactBatchId(c) === AppState.previousImportBatchId).length
                        : 0;

                    const topShift = Object.entries(byShift).sort((a,b) => b[1]-a[1])[0];
                    const topShiftText = topShift ? `${topShift[0].toUpperCase()} (${topShift[1]})` : 'sin datos';

                    if (elements.metricsDateLabel) elements.metricsDateLabel.textContent = `Métricas del día ${today}`;
                    if (elements.metricEditedToday) elements.metricEditedToday.textContent = String(editedToday);
                    if (elements.metricEditedYesterday) elements.metricEditedYesterday.textContent = String(editedYesterday);
                    if (elements.metricTopShift) elements.metricTopShift.textContent = topShiftText;
                    if (elements.metricRevToContact) elements.metricRevToContact.textContent = String(revToContact);
                    if (elements.metricContactToJugando) elements.metricContactToJugando.textContent = String(contactToJugando);
                    if (elements.metricLastBatchCount) elements.metricLastBatchCount.textContent = `${lastBatchCount} / ${prevBatchCount}`;

                    if (elements.metricsModal) elements.metricsModal.classList.add('active');
                };
            }

            if (elements.metricsFilterLastBatchBtn) {
                elements.metricsFilterLastBatchBtn.onclick = () => {
                    AppState.originFilter = '__last_upload__';
                    if (elements.originFilter) elements.originFilter.value = '__last_upload__';
                    AppState.currentPage = 1;
                    render();
                    showNotification('Filtro aplicado: última subida', 'info');
                };
            }

            if (elements.metricsDeleteLastBatchBtn) {
                elements.metricsDeleteLastBatchBtn.onclick = () => {
                    if (!AppState.lastImportBatchId) {
                        showNotification('No hay última subida para borrar', 'warning');
                        return;
                    }
                    const count = AppState.contacts.filter(c => getContactBatchId(c) === AppState.lastImportBatchId).length;
                    if (!count) {
                        showNotification('No hay contactos de la última subida', 'warning');
                        return;
                    }
                    const ok = confirm(`¿Borrar completamente ${count} contactos de la última subida?`);
                    if (!ok) return;
                    AppState.contacts = AppState.contacts.filter(c => getContactBatchId(c) !== AppState.lastImportBatchId);
                    addToHistory('Borrado por métricas', `Se eliminaron ${count} contactos de la última subida`);
                    AppState.lastImportBatchId = AppState.previousImportBatchId || '';
                    localStorage.setItem('lastImportBatchId', AppState.lastImportBatchId);
                    detectDuplicates();
                    saveData();
                    render();
                    showNotification(`Eliminados ${count} contactos de la última subida`, 'success');
                };
            }

            if ($('#closeMetricsModal')) $('#closeMetricsModal').onclick = () => $('#metricsModal').classList.remove('active');
            $('#closeUserOptionsModal').onclick = () => elements.userOptionsModal.classList.remove('active');

            elements.searchInput.oninput = (e) => {
                AppState.searchTerm = e.target.value;
                AppState.currentPage = 1;
                render();
            };

            $('#undoBtn').onclick = undoToLastContact;
            
            elements.saveTemplateBtn.onclick = () => {
                AppState.whatsappTemplate = elements.whatsappTemplateInput.value;
                savePreferences();
                showNotification('Mensaje de WhatsApp guardado', 'success');
                elements.whatsappMessageModal.classList.remove('active');
            };
            elements.insertUserTokenBtn.onclick = () => {
                const el = elements.whatsappTemplateInput;
                const token = '{usuario}';
                const start = el.selectionStart || el.value.length;
                const end = el.selectionEnd || el.value.length;
                el.value = el.value.slice(0, start) + token + el.value.slice(end);
                el.focus();
                el.selectionStart = el.selectionEnd = start + token.length;
            };
            elements.resetTemplateBtn.onclick = () => {
                elements.whatsappTemplateInput.value = 'Hola {usuario}, ¿cómo estás? Te escribo por la propuesta que vimos.';
                AppState.whatsappTemplate = elements.whatsappTemplateInput.value;
                savePreferences();
            };
            $('#closeWhatsappMessageModal').onclick = () => elements.whatsappMessageModal.classList.remove('active');
            const closeShortcutsBtn = $('#closeShortcutsModal');
            if (closeShortcutsBtn) closeShortcutsBtn.onclick = () => elements.shortcutsModal.classList.remove('active');

            document.addEventListener('change', (e) => {
                if (e.target && e.target.name === 'dupMergeMode') {
                    AppState.duplicateMergeMode = e.target.value;
                    savePreferences();
                }
            });

            window.addEventListener('beforeunload', () => {
                flushSaveQueue();
                saveHistory();
            });

            document.addEventListener('visibilitychange', () => {
                if (document.visibilityState === 'hidden') {
                    flushSaveQueue();
                    saveHistory();
                }
            });

            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    closeAllOverlays();
                    return;
                }
                if (e.ctrlKey && e.key === 'z' && !e.target.matches('input, textarea')) {
                    e.preventDefault();
                    undoToLastContact();
                    return;
                }
                if ((e.ctrlKey || e.metaKey) && ['+', '=', '-','0'].includes(e.key) && !e.target.matches('input, textarea')) {
                    e.preventDefault();
                    if (e.key === '+' || e.key === '=') window.electronAPI?.zoomIn?.();
                    else if (e.key === '-') window.electronAPI?.zoomOut?.();
                    else if (e.key === '0') window.electronAPI?.zoomReset?.();
                    return;
                }
                if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'a' && !e.target.matches('input, textarea, select')) {
                    e.preventDefault();
                    applyFilters();
                    AppState.filteredContacts.forEach(c => AppState.selectedContacts.add(c.id));
                    updateBulkActionsBar();
                    render();
                    return;
                }
                if (e.target.matches('input, textarea, select')) return;
                const code = e.code;
                const selectedId = Array.from(AppState.selectedContacts)[0] || AppState.lastEditedContact;
                if (code === 'Numpad1' && selectedId) changeContactStatus(selectedId, 'sin revisar');
                else if (code === 'Numpad2' && selectedId) changeContactStatus(selectedId, 'contactado');
                else if (code === 'Numpad3' && selectedId) changeContactStatus(selectedId, 'jugando');
                else if (code === 'Numpad4' && selectedId) changeContactStatus(selectedId, 'sin wsp');
                else if (code === 'Numpad5' && selectedId) changeContactStatus(selectedId, 'no interesado');
                else if (code === 'Numpad0') undoToLastContact();
                else if (code === 'NumpadAdd') elements.viewListBtn.click();
            });

            document.addEventListener('wheel', (e) => {
                if (!(e.ctrlKey || e.metaKey)) return;
                e.preventDefault();
                if (e.deltaY < 0) window.electronAPI?.zoomIn?.();
                else window.electronAPI?.zoomOut?.();
            }, { passive: false });

            elements.statusFilter.onchange = (e) => {
                AppState.statusFilter = e.target.value;
                AppState.currentPage = 1;
                render();
            };

            elements.originFilter.onchange = (e) => {
                AppState.originFilter = e.target.value;
                AppState.currentPage = 1;
                render();
            };

            if (elements.opsSegmentFilter) {
                elements.opsSegmentFilter.onchange = (e) => {
                    AppState.opsFilter = e.target.value;
                    AppState.currentPage = 1;
                    render();
                };
            }
            if (elements.shiftFilter) {
                elements.shiftFilter.onchange = (e) => {
                    AppState.shiftFilter = e.target.value;
                    AppState.currentPage = 1;
                    render();
                };
            }

            if (elements.phoneFilter) {
                elements.phoneFilter.onchange = (e) => {
                    AppState.phoneFilter = e.target.value;
                    AppState.currentPage = 1;
                    render();
                };
            }
            if (elements.editActivityFilter) {
                elements.editActivityFilter.onchange = (e) => {
                    AppState.editActivityFilter = e.target.value;
                    AppState.currentPage = 1;
                    render();
                };
            }

            if (elements.clearFiltersBtn) {
                elements.clearFiltersBtn.onclick = () => {
                    AppState.searchTerm = '';
                    AppState.statusFilter = '';
                    AppState.originFilter = '';
                    AppState.opsFilter = 'all';
                    AppState.shiftFilter = '';
                    AppState.phoneFilter = 'all';
                    AppState.editActivityFilter = 'all';
                    AppState.currentPage = 1;
                    elements.searchInput.value = '';
                    elements.statusFilter.value = '';
                    elements.originFilter.value = '';
                    if (elements.opsSegmentFilter) elements.opsSegmentFilter.value = 'all';
                    if (elements.shiftFilter) elements.shiftFilter.value = '';
                    if (elements.phoneFilter) elements.phoneFilter.value = 'all';
                    if (elements.editActivityFilter) elements.editActivityFilter.value = 'all';
                    render();
                };
            }

            if (elements.selectFilteredBtn) {
                elements.selectFilteredBtn.onclick = () => {
                    applyFilters();
                    const start = (AppState.currentPage - 1) * AppState.itemsPerPage;
                    const end = start + AppState.itemsPerPage;
                    const visibleContacts = AppState.filteredContacts.slice(start, end);
                    visibleContacts.forEach(c => AppState.selectedContacts.add(c.id));
                    showNotification(`Seleccionados ${visibleContacts.length} contactos visibles`, 'success');
                    updateBulkActionsBar();
                    render();
                };
            }

            if (elements.clearSelectionBtn) {
                elements.clearSelectionBtn.onclick = () => {
                    const removed = AppState.selectedContacts.size;
                    AppState.selectedContacts.clear();
                    AppState.lastSelectedContactId = null;
                    if (removed) showNotification('Selección limpiada', 'info');
                    updateBulkActionsBar();
                    render();
                };
            }

            elements.viewCardsBtn.onclick = () => {
                withSoftTransition(() => {
                    AppState.currentView = 'cards';
                    elements.viewCardsBtn.classList.add('active');
                    elements.viewListBtn.classList.remove('active');
                    if (elements.viewShiftsBtn) elements.viewShiftsBtn.classList.remove('active');
                    elements.cardsView.style.display = 'grid';
                    elements.listView.style.display = 'none';
                    elements.shiftsView.style.display = 'none';
                    render();
                });
            };

            elements.viewListBtn.onclick = () => {
                withSoftTransition(() => {
                    AppState.currentView = 'list';
                    elements.viewListBtn.classList.add('active');
                    elements.viewCardsBtn.classList.remove('active');
                    if (elements.viewShiftsBtn) elements.viewShiftsBtn.classList.remove('active');
                    elements.listView.style.display = 'block';
                    elements.cardsView.style.display = 'none';
                    elements.shiftsView.style.display = 'none';
                    render();
                });
            };

            if (elements.viewShiftsBtn) {
                elements.viewShiftsBtn.onclick = () => {
                    withSoftTransition(() => {
                        AppState.currentView = 'shifts';
                        AppState.selectedContacts.clear();
                        updateBulkActionsBar();
                        elements.viewShiftsBtn.classList.add('active');
                        elements.viewCardsBtn.classList.remove('active');
                        elements.viewListBtn.classList.remove('active');
                        render();
                    });
                };
            }

            $$('.stat-box').forEach(box => {
                box.onclick = () => {
                    const filter = box.dataset.filter;
                    if (box === elements.duplicatesStatBox) {
                        showDuplicatesModal();
                        return;
                    }
                    
                    $$('.stat-box').forEach(b => b.classList.remove('active'));
                    if (AppState.statusFilter === filter) {
                        AppState.statusFilter = '';
                    } else {
                        AppState.statusFilter = filter;
                        box.classList.add('active');
                    }
                    elements.statusFilter.value = AppState.statusFilter;
                    render();
                };
            });

            const unifiedEventHandler = (e) => {
                const card = e.target.closest('.contact-card, .list-item');
                if (!card) return;
                
                const id = parseFloat(card.dataset.id);
                if (isNaN(id)) return;

                const isCheckbox = e.target.matches('input[type="checkbox"]');
                const isButton = e.target.closest('button');
                const isInteractive = e.target.closest('button, select, option, input[type="text"], textarea, .card-status-inline, .status-badge, .card-status-menu, .card-status-option, .whatsapp-btn');
                
                if (isInteractive && !isCheckbox) return;
                
                if (isCheckbox) {
                     if (e.target.checked) AppState.selectedContacts.add(id);
                     else AppState.selectedContacts.delete(id);
                     AppState.lastSelectedContactId = id;
                     setSaveState('pending', 'Selección local');
                } else if (e.shiftKey && AppState.lastSelectedContactId !== null) {
                     const currentIndex = AppState.filteredContacts.findIndex(c => c.id === id);
                     const lastIndex = AppState.filteredContacts.findIndex(c => c.id === AppState.lastSelectedContactId);
                     if (currentIndex !== -1 && lastIndex !== -1) {
                        const [start, end] = currentIndex < lastIndex ? [currentIndex, lastIndex] : [lastIndex, currentIndex];
                        for (let i = start; i <= end; i++) {
                            AppState.selectedContacts.add(AppState.filteredContacts[i].id);
                        }
                     } else {
                        AppState.selectedContacts.add(id);
                     }
                } else if (e.ctrlKey || e.metaKey) {
                     if (AppState.selectedContacts.has(id)) AppState.selectedContacts.delete(id);
                     else AppState.selectedContacts.add(id);
                     AppState.lastSelectedContactId = id;
                } else {
                     AppState.selectedContacts.clear();
                     AppState.selectedContacts.add(id);
                     AppState.lastSelectedContactId = id;
                }
                
                updateBulkActionsBar();
                elements.pagination.style.display = 'flex';
                if (AppState.currentView === 'shifts') {
                elements.cardsView.style.display = 'none';
                elements.listView.style.display = 'none';
                elements.pagination.style.display = 'none';
                renderShiftsView();
            } else {
                elements.shiftsView.style.display = 'none';
                renderPaginatedView(AppState.currentView === 'cards' ? createCard : createListItem);
            }
            };

            const unifiedDblClickHandler = (e) => {
                const target = e.target.closest('[data-field]');
                if (!target) return;
                
                const card = e.target.closest('.contact-card, .list-item');
                const id = parseFloat(card.dataset.id);
                const field = target.dataset.field;
                const contact = AppState.contacts.find(c => c.id === id);
                
                if (!contact) return;
                
                const originalValue = target.textContent.trim();
                let hasSaved = false;

                if (field === 'status') {
                    const select = document.createElement('select');
                    select.className = 'filter-select';
                    select.style.width = '100%';
                    select.innerHTML = STATUS_OPTIONS.map(opt => 
                        `<option value="${opt.id}" ${opt.id === contact.status ? 'selected' : ''}>${opt.label}</option>`
                    ).join('');
                    target.textContent = '';
                    target.appendChild(select);
                    select.focus();
                    
                    const save = () => {
                        if (hasSaved) return;
                        hasSaved = true;
                        const oldStatus = contact.status;
                        contact.status = select.value;
                        updateCompetitionCredit(contact, select.value, 'common');
                        setReviewMetadata(contact, select.value);
                        touchContactEdit(contact, 'inline_status');
                        addToHistory('Estado cambiado', `${contact.name}: ${oldStatus} → ${select.value}`);
                        saveData();
                        render();
                    };
                    
                    select.onblur = save;
                    select.onchange = save;
                }
            };
            
            $$('#cardsView, #listView').forEach(el => {
                el.addEventListener('click', unifiedEventHandler);
                el.addEventListener('dblclick', unifiedDblClickHandler);
            });

            $('#bulkDeleteBtn').onclick = () => {
                if(AppState.selectedContacts.size > 0 && confirm(`¿Eliminar ${AppState.selectedContacts.size} contactos seleccionados?`)) {
                    const selectedCount = AppState.selectedContacts.size;
                    AppState.contacts = AppState.contacts.filter(c => !AppState.selectedContacts.has(c.id));
                    AppState.selectedContacts.clear();
                    addToHistory('Eliminación masiva', `${selectedCount} contactos eliminados`);
                    saveData();
                    render();
                    showNotification(`${selectedCount} contactos eliminados.`, 'success');
                }
            };

            $('#bulkStatusSelect').onchange = (e) => {
                const newStatus = e.target.value;
                if (AppState.selectedContacts.size > 0 && newStatus) {
                   const selectedCount = AppState.selectedContacts.size;
                   AppState.selectedContacts.forEach(id => {
                        const contact = AppState.contacts.find(c => c.id === id);
                        if (contact) {
                            contact.status = newStatus;
                            updateCompetitionCredit(contact, newStatus, 'common');
                            setReviewMetadata(contact, newStatus);
                            touchContactEdit(contact, 'inline_status');
                        }
                   });
                   addToHistory('Cambio de estado masivo', `${selectedCount} contactos → ${newStatus}`);
                   AppState.selectedContacts.clear();
                   saveData();
                   render();
                   showNotification(`${selectedCount} contactos actualizados.`, 'success');
                   e.target.value = "";
                }
            };

            $('#bulkCancelBtn').onclick = () => {
                AppState.selectedContacts.clear();
                render();
            };

            $('#exportBtn').onclick = () => {
                $('#exportFilteredCount').textContent = `${AppState.filteredContacts.length} contactos`;
                $('#exportAllCount').textContent = `${AppState.contacts.length} contactos`;
                $('#exportModal').classList.add('active');
            };

            $('#cancelExport').onclick = () => $('#exportModal').classList.remove('active');

            $('#confirmExport').onclick = () => {
                const selectedTypeEl = $('#exportModal .export-option[data-type].selected');
                const selectedFormatEl = $('#exportModal .export-option[data-format].selected');
                const type = selectedTypeEl ? selectedTypeEl.dataset.type : 'all';
                const format = selectedFormatEl ? selectedFormatEl.dataset.format : 'sheet';
                const contactsToExport = type === 'filtered' ? AppState.filteredContacts : AppState.contacts;

                if (!contactsToExport.length) {
                    showNotification('No hay contactos para exportar', 'warning');
                    return;
                }

                if (format === 'vcf') exportToVCF(contactsToExport);
                else exportToSheetFormat(contactsToExport);

                localStorage.setItem('lastExportAt', new Date().toISOString());
                updateExportUrgencyBadge();
                $('#exportModal').classList.remove('active');
            };

            $$('#exportModal .export-option').forEach(opt => opt.onclick = (e) => {
                const option = e.target.closest('.export-option');
                const group = option.dataset.type ? '[data-type]' : '[data-format]';
                $$(`#exportModal .export-option${group}`).forEach(o => o.classList.remove('selected'));
                option.classList.add('selected');
            });

            elements.manageDuplicatesBtn.onclick = showDuplicatesModal;
            $('#closeDuplicatesModal').onclick = () => $('#duplicatesModal').classList.remove('active');
            $('#mergeAllDuplicates').onclick = () => {
                if (confirm('¿Fusionar todos los duplicados? Esta acción no se puede deshacer.')) {
                    mergeAllDuplicates();
                }
            };

            elements.historyBtn.onclick = showHistoryModal;
            $('#closeHistoryModal').onclick = () => $('#historyModal').classList.remove('active');
            if ($('#closeContactHistoryModal')) $('#closeContactHistoryModal').onclick = () => $('#contactHistoryModal').classList.remove('active');
            $('#clearHistoryBtn').onclick = () => {
                if (confirm('¿Borrar todo el historial?')) {
                    AppState.history = [];
                    saveHistory();
                    $('#historyModal').classList.remove('active');
                    showNotification('Historial borrado', 'success');
                }
            };

            $('#cancelAddSingle').onclick = () => {
                resetAddSingleModalState();
                $('#addSingleModal').classList.remove('active');
            };

            $('#confirmAddSingle').onclick = () => {
                const name = $('#singleName').value.trim();
                const phone = normalizePhoneNumber($('#singlePhone').value.trim());
                const origin = $('#singleOrigin').value.trim() || 'Manual';
                const status = $('#singleStatus').value;

                if (!name) {
                    showNotification('El nombre es obligatorio', 'error');
                    return;
                }

                if (AppState.editingContactId) {
                    const contact = AppState.contacts.find(c => c.id === AppState.editingContactId);
                    if (!contact) {
                        showNotification('No se encontró el contacto a editar', 'error');
                        resetAddSingleModalState();
                        $('#addSingleModal').classList.remove('active');
                        return;
                    }
                    const oldSnapshot = `${contact.name} | ${contact.phone || 'sin teléfono'} | ${contact.origin || 'Manual'} | ${contact.status || 'sin revisar'}`;
                    contact.name = name;
                    contact.phone = phone;
                    contact.origin = origin;
                    if (contact.status !== status) {
                        setReviewMetadata(contact, status);
                    }
                    contact.status = status;
                    updateCompetitionCredit(contact, status, 'common');
                    touchContactEdit(contact, 'modal_edit');
                    AppState.lastEditedContact = contact.id;
                    const newSnapshot = `${contact.name} | ${contact.phone || 'sin teléfono'} | ${contact.origin || 'Manual'} | ${contact.status || 'sin revisar'}`;
                    addToHistory('Contacto editado', `${oldSnapshot} → ${newSnapshot}`, contact.id);
                    detectDuplicates();
                    saveData();
                    render();
                    resetAddSingleModalState();
                    $('#addSingleModal').classList.remove('active');
                    showNotification('✅ Contacto actualizado', 'success');
                    return;
                }

                const newContact = {
                    id: Date.now() + Math.random(),
                    name: name,
                    phone: phone,
                    origin: origin,
                    status: status,
                    lastUpdated: new Date().toISOString(),
                    lastEditedAt: new Date().toISOString(),
                    lastEditReason: 'manual_create',
                    recontactAttempts: 0,
                    isDuplicate: false
                };

                AppState.contacts.push(newContact);
                addToHistory('Contacto agregado manualmente', name);
                detectDuplicates();
                saveData();
                render();
                resetAddSingleModalState();
                $('#addSingleModal').classList.remove('active');
                showNotification('✅ Contacto agregado', 'success');
            };

            $('#deleteAllBtn').onclick = () => {
                if (confirm('⚠️ ¿BORRAR TODOS LOS CONTACTOS? Esta acción NO se puede deshacer.')) {
                    const count = AppState.contacts.length;
                    AppState.contacts = [];
                    AppState.selectedContacts.clear();
                    addToHistory('Todos los contactos eliminados', `${count} contactos borrados`);
                    saveData();
                    render();
                    showNotification(`${count} contactos eliminados`, 'success');
                }
            };
        }

        function updateFileList() {
            if (selectedFiles.length === 0) {
                elements.fileList.innerHTML = '';
                elements.startBtn.disabled = true;
                return;
            }
            
            elements.fileList.innerHTML = selectedFiles.map((f, i) => 
                `<div class="file-item">
                    <span><i class="fas fa-file-csv"></i> ${f.name}</span>
                    <span>${(f.size / 1024).toFixed(1)} KB</span>
                </div>`
            ).join('');
            
            elements.startBtn.disabled = false;
        }

        function csvField(value) {
            if (value === null || value === undefined) return '';
            return String(value).replace(/\r?\n/g, ' ').trim();
        }

        function vcfEscape(value) {
            return String(value || '')
                .replace(/\\/g, '\\\\')
                .replace(/;/g, '\\;')
                .replace(/,/g, '\\,')
                .replace(/\r?\n/g, '\\n');
        }

        function formatCsvField(value) {
            if (value === null || value === undefined) return '""';
            const stringValue = String(value);
            if (stringValue.includes(',') || stringValue.includes('\n') || stringValue.includes('"')) {
                return `"${stringValue.replace(/"/g, '""')}"`;
            }
            return `"${stringValue}"`;
        }

        function exportToVCF(contacts) {
            const lines = [];
            contacts.forEach(c => {
                const name = csvField(c.name) || 'Sin nombre';
                const phone = normalizePhoneNumber(c.phone || '');
                lines.push('BEGIN:VCARD');
                lines.push('VERSION:3.0');
                lines.push(`N:${vcfEscape(name)};;;;`);
                lines.push(`FN:${vcfEscape(name)}`);
                if (phone) lines.push(`TEL;TYPE=CELL:${phone}`);
                lines.push(`NOTE:${vcfEscape(`Origen: ${c.origin || '-'} | Estado: ${c.status || '-'}`)}`);
                lines.push('END:VCARD');
            });
            const vcfContent = lines.join('\r\n') + '\r\n';
            downloadFile(vcfContent, `contactos_${new Date().toISOString().split('T')[0]}.vcf`, 'text/vcard;charset=utf-8');
            showNotification('✅ VCF real exportado (compatible con celulares)', 'success');
        }

        function parseVCF(text) {
            const contacts = [];
            const vcards = text.split('BEGIN:VCARD').filter(v => v.trim());
            
            vcards.forEach(vcard => {
                const contact = {};
                const lines = vcard.split('\n').map(l => l.trim()).filter(Boolean);
                
                lines.forEach(line => {
                    if (line.startsWith('FN:')) {
                        contact.name = line.substring(3).trim();
                    } else if (line.startsWith('TEL')) {
                        const phoneMatch = line.match(/:([\d+]+)/);
                        if (phoneMatch) {
                            contact.phone = normalizePhoneNumber(phoneMatch[1]);
                        }
                    } else if (line.startsWith('NOTE:')) {
                        const noteText = line.substring(5);
                        
                        const origenMatch = noteText.match(/Origen:\s*([^,]+)/);
                        if (origenMatch) {
                            contact.origin = origenMatch[1].trim();
                        }
                        
                        const estadoMatch = noteText.match(/Estado:\s*(.+)/);
                        if (estadoMatch) {
                            const estado = estadoMatch[1].trim().toLowerCase();
                            if (estado.includes('contactado')) contact.status = 'contactado';
                            else if (estado.includes('jugando')) contact.status = 'jugando';
                            else if (estado.includes('revisado') || estado.includes('verificado')) contact.status = 'revisado';
                            else if (estado.includes('sin wsp')) contact.status = 'sin wsp';
                            else if (estado.includes('no interesado')) contact.status = 'no interesado';
                            else contact.status = 'sin revisar';
                        }
                    }
                });
                
                if (contact.name) {
                    if (!contact.status) contact.status = 'sin revisar';
                    if (!contact.origin) contact.origin = 'VCF Importado';
                    if (!contact.phone) contact.phone = '';
                    contacts.push(contact);
                }
            });
            
            return contacts;
        }

        function exportToSheetFormat(contacts) {
            const headers = "usuarios,alias,estado de revision,telefono,estado actual,cargas,descargas,neto,score,lealtad,ultima actividad,\"VISTO, RESPONDIDO?\",RECUPERADO,TURNO DE LAS CARGAS,interesado en jugar?,ya contactados,recuperados!,actualmente cargando,TURNO MAÑANA,TURNO TARDE,TURNO NOCHE,contactos a borrar\n";
            
            const statusToSheetStatus = (status) => {
                const map = { 'contactado': 'promo enviada', 'revisado': 'REVISADO', 'sin wsp': 'NO ESTA EN WSP', 'sin revisar': 'A CONTACTAR', 'jugando': 'EN CONTACTO', 'no interesado': 'ELIMINADO' };
                return map[status] || 'SIN REVISAR';
            };

            const yaContactados = contacts.filter(c => c.status === 'contactado').map(c => c.name);
            const recuperados = contacts.filter(c => c.status === 'jugando').map(c => c.name);
            const actualmenteCargando = contacts.filter(c => c.origin && c.origin.toLowerCase().includes('cargando')).map(c => c.name);
            const turnoManana = contacts.filter(c => c.origin && c.origin.toLowerCase().includes('mañana')).map(c => c.name);
            const turnoTarde = contacts.filter(c => c.origin && c.origin.toLowerCase().includes('tarde')).map(c => c.name);
            const turnoNoche = contacts.filter(c => c.origin && c.origin.toLowerCase().includes('noche')).map(c => c.name);
            const aBorrar = contacts.filter(c => c.status === 'no interesado' || c.markedForCleanup).map(c => c.name);

            const maxLength = Math.max(contacts.length, yaContactados.length, recuperados.length, actualmenteCargando.length, turnoManana.length, turnoTarde.length, turnoNoche.length, aBorrar.length);
            
            let csvContent = headers;

            for (let i = 0; i < maxLength; i++) {
                const mainContact = contacts[i];
                const row = [
                    mainContact ? formatCsvField(mainContact.name) : '',
                    mainContact ? formatCsvField(mainContact.alias || extractPrimaryAlias(mainContact.name || '')) : '',
                    mainContact ? formatCsvField(statusToSheetStatus(mainContact.status)) : '',
                    mainContact && mainContact.phone ? formatCsvField(mainContact.phone) : '',
                    mainContact ? formatCsvField(statusToSheetStatus(mainContact.status)) : '',
                    mainContact ? formatCsvField(mainContact.ops?.cargasCount || 0) : '',
                    mainContact ? formatCsvField(mainContact.ops?.descargasCount || 0) : '',
                    mainContact ? formatCsvField(Math.round(mainContact.ops?.netoTotal || 0)) : '',
                    mainContact ? formatCsvField(mainContact.ops?.score || 0) : '',
                    mainContact ? formatCsvField(mainContact.ops?.loyalty || 0) : '',
                    mainContact && mainContact.ops?.lastCargaAt ? formatCsvField(new Date(mainContact.ops.lastCargaAt).toLocaleString('es-ES')) : '',
                    'NO', 'NO', '', 'NO',
                    formatCsvField(yaContactados[i]),
                    formatCsvField(recuperados[i]),
                    formatCsvField(actualmenteCargando[i]),
                    formatCsvField(turnoManana[i]),
                    formatCsvField(turnoTarde[i]),
                    formatCsvField(turnoNoche[i]),
                    formatCsvField(aBorrar[i])
                ];
                csvContent += row.join(',') + '\n';
            }

            const shiftTotals = { tm: 0, tt: 0, tn: 0 };
            contacts.forEach((c) => {
                const key = String(c.shiftReviewedByShift || '').toLowerCase();
                if (shiftTotals[key] !== undefined) shiftTotals[key]++;
            });
            const originsCount = {};
            contacts.forEach((c) => {
                const o = (c.origin || 'Sin origen').toString();
                originsCount[o] = (originsCount[o] || 0) + 1;
            });
            csvContent += '\n\n';
            csvContent += 'META_LOG,TIPO,VALOR\n';
            csvContent += `META_LOG,exportado_en,${formatCsvField(new Date().toISOString())}\n`;
            csvContent += `META_LOG,total_contactos,${contacts.length}\n`;
            csvContent += `META_LOG,turno_manana,${shiftTotals.tm}\n`;
            csvContent += `META_LOG,turno_tarde,${shiftTotals.tt}\n`;
            csvContent += `META_LOG,turno_noche,${shiftTotals.tn}\n`;
            Object.entries(originsCount).forEach(([originName, qty]) => {
                csvContent += `META_LOG,origen_${formatCsvField(originName)},${qty}\n`;
            });

            downloadFile(csvContent, `planilla_exportada_${new Date().toISOString().split('T')[0]}.csv`, 'text/csv;charset=utf-8;');
            showNotification('Exportación completada con teléfonos', 'success');
        }

        function downloadFile(content, fileName, mimeType) {
            const bom = mimeType.includes('csv') ? '\uFEFF' : '';
            const blob = new Blob([bom + content], { type: mimeType });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = fileName;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        async function init() {
            try {
                await (window.__nexoStoreReady || Promise.resolve());
                try {
                    const version = await window.electronAPI?.getAppVersion?.();
                    if (version) {
                        const safeVersion = String(version || '').replace(/^v/i, '');
                        document.title = `Nexo Desktop v${safeVersion}`;
                        const h1 = document.querySelector('#uploadScreen h1');
                        if (h1) h1.textContent = `Gestor de Contactos Masivo · v${safeVersion}`;
                    }
                    const runtimeHash = await window.electronAPI?.getRuntimeHash?.();
                    AppState.runtimeHash = runtimeHash?.hash || '';
                } catch (e) { console.warn('No se pudo leer versión/hash de app', e); }
                window.addEventListener('nexo-store-error', (event) => {
                    if (event && event.detail) showNotification(event.detail, 'warning');
                });
                elements.bulkStatusSelect.innerHTML = `<option value="" disabled selected>Cambiar estado</option>` + STATUS_OPTIONS.map(opt => `<option value="${opt.id}">${opt.label}</option>`).join('');
                setupEventListeners();

                window.nexoUpdaterDiagnostics = async () => {
                    const diag = await window.electronAPI?.getUpdaterDiagnostics?.();
                    console.table(diag || {});
                    return diag || {};
                };
                loadHistory();
                loadPreferences();
                ensureActiveProfile();
                refreshProfilesUI();
                loadOpsData();
                setLoadingState(true, 'Hidratando datos…', 8, false);
                await perfMark('init/hidratacion', async () => loadData());
                ensureReviewMilestonesState();
                setLoadingState(false, 'Listo', 100, false);
                refreshStorageDiagnostics();
                updateExportUrgencyBadge();
                setInterval(() => { if (AppState.contacts.length) render(); else updateExportUrgencyBadge(); }, 300000);
                setInterval(() => { refreshStorageDiagnostics(); }, 45000);
                setInterval(() => {
                    if (!AppState.contacts.length) return;
                    maybeDownloadAutomaticBackup('interval');
                }, 60000);
            } catch (e) {
                console.error("Error fatal en la inicialización:", e);
                document.body.innerHTML = "<h1>Error Crítico</h1><p>La aplicación no pudo iniciarse. Por favor, borra la caché y los datos del sitio e inténtalo de nuevo.</p>";
            }
        }


        window.addEventListener('error', (event) => {
            reportError('window.error', event?.error || event?.message || 'window error', {
                filename: event?.filename || '',
                lineno: event?.lineno || 0,
                colno: event?.colno || 0
            });
        });

        window.addEventListener('unhandledrejection', (event) => {
            reportError('window.unhandledrejection', event?.reason || 'Unhandled rejection');
        });

        window.addEventListener('nexo-store-error', (event) => {
            reportError('store', event?.detail || 'Error de store');
        });

        init();
    })();
    </script>


</body></html>
